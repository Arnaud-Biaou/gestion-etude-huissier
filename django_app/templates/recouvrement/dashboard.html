{% extends "base.html" %}
{% load static %}

{% block title %}Tableau de bord - Recouvrement{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-title h1 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
    }

    .btn-primary, .btn-secondary {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-size: 0.875rem;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: #15294d;
        color: white;
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    /* Stats Cards Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: 0.5rem;
        padding: 1.25rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .stat-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .stat-icon.primary { background: rgba(26, 54, 93, 0.1); color: var(--primary); }
    .stat-icon.success { background: #dcfce7; color: #166534; }
    .stat-icon.warning { background: #fef3c7; color: #92400e; }
    .stat-icon.info { background: #dbeafe; color: #1e40af; }
    .stat-icon.danger { background: #fee2e2; color: #dc2626; }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .stat-change {
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    .stat-change.positive { color: #166534; }
    .stat-change.negative { color: #dc2626; }

    /* Two columns layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Cards */
    .card {
        background: var(--card-bg);
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .card-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .card-body.no-padding {
        padding: 0;
    }

    /* Progress circle */
    .taux-container {
        display: flex;
        align-items: center;
        gap: 2rem;
        padding: 1rem;
    }

    .taux-circle {
        position: relative;
        width: 120px;
        height: 120px;
    }

    .taux-circle svg {
        transform: rotate(-90deg);
    }

    .taux-circle .circle-bg {
        fill: none;
        stroke: var(--bg-secondary);
        stroke-width: 8;
    }

    .taux-circle .circle-progress {
        fill: none;
        stroke: var(--primary);
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
    }

    .taux-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }

    .taux-details {
        flex: 1;
    }

    .taux-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .taux-row:last-child {
        border-bottom: none;
    }

    .taux-row .label {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .taux-row .value {
        font-weight: 600;
        font-family: monospace;
    }

    /* Table */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
        background: var(--bg-secondary);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-secondary);
    }

    .data-table tr:hover {
        background: var(--bg-secondary);
    }

    .data-table .amount {
        font-family: monospace;
        text-align: right;
    }

    .data-table a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
    }

    /* Badges */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-info { background: #dbeafe; color: #1e40af; }

    /* Top créanciers */
    .creancier-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .creancier-item:last-child {
        border-bottom: none;
    }

    .creancier-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .creancier-rank {
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
        background: var(--bg-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .creancier-name {
        font-weight: 500;
    }

    .creancier-stats {
        text-align: right;
        font-size: 0.875rem;
    }

    .creancier-stats .dossiers {
        color: var(--text-secondary);
        font-size: 0.75rem;
    }

    /* Quick links */
    .quick-links {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .quick-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 0.375rem;
        text-decoration: none;
        color: var(--text-primary);
        transition: background 0.2s;
    }

    .quick-link:hover {
        background: var(--border-color);
    }

    .quick-link i {
        color: var(--primary);
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <i data-lucide="layout-dashboard"></i>
        <h1>Tableau de bord Recouvrement</h1>
    </div>
    <div class="header-actions">
        <a href="{% url 'recouvrement:liste_dossiers_recouvrement' %}" class="btn-secondary">
            <i data-lucide="folder-open"></i>
            Voir les dossiers
        </a>
        <a href="{% url 'recouvrement:creer_dossier_recouvrement' %}" class="btn-primary">
            <i data-lucide="plus"></i>
            Nouveau dossier
        </a>
    </div>
</div>

<!-- Stats principales -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i data-lucide="folder"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ stats_dossiers.total }}</div>
            <div class="stat-label">Total dossiers</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success">
            <i data-lucide="play-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ stats_dossiers.en_cours }}</div>
            <div class="stat-label">Dossiers en cours</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon info">
            <i data-lucide="credit-card"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ paiements_mois.nombre|default:0 }}</div>
            <div class="stat-label">Paiements ce mois</div>
            <div class="stat-change positive">{{ paiements_mois.total|floatformat:0|default:0 }} FCFA</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon warning">
            <i data-lucide="send"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ reversements_en_attente.nombre|default:0 }}</div>
            <div class="stat-label">Reversements en attente</div>
            <div class="stat-change">{{ reversements_en_attente.total|floatformat:0|default:0 }} FCFA</div>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Colonne principale -->
    <div>
        <!-- Taux de recouvrement global -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">
                    <i data-lucide="trending-up"></i>
                    Taux de recouvrement global
                </span>
            </div>
            <div class="card-body">
                <div class="taux-container">
                    <div class="taux-circle">
                        <svg viewBox="0 0 36 36">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            />
                            <path class="circle-progress"
                                stroke-dasharray="{{ taux_recouvrement_global|floatformat:0 }}, 100"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            />
                        </svg>
                        <div class="taux-value">{{ taux_recouvrement_global|floatformat:1 }}%</div>
                    </div>
                    <div class="taux-details">
                        <div class="taux-row">
                            <span class="label">Total créances</span>
                            <span class="value">{{ stats_financieres.total_creances|floatformat:0 }} F</span>
                        </div>
                        <div class="taux-row">
                            <span class="label">Total encaissé</span>
                            <span class="value" style="color: #166534;">{{ stats_financieres.total_encaisse|floatformat:0 }} F</span>
                        </div>
                        <div class="taux-row">
                            <span class="label">Reste à recouvrer</span>
                            <span class="value" style="color: #dc2626;">{{ stats_financieres.reste_du|floatformat:0 }} F</span>
                        </div>
                        <div class="taux-row">
                            <span class="label">Total reversé</span>
                            <span class="value" style="color: var(--primary);">{{ stats_financieres.total_reverse|floatformat:0 }} F</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Derniers dossiers -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">
                    <i data-lucide="clock"></i>
                    Derniers dossiers créés
                </span>
                <a href="{% url 'recouvrement:liste_dossiers_recouvrement' %}" class="btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                    Voir tout
                </a>
            </div>
            <div class="card-body no-padding">
                {% if derniers_dossiers %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Référence</th>
                            <th>Créancier</th>
                            <th>Type</th>
                            <th class="amount">Principal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in derniers_dossiers %}
                        <tr>
                            <td>
                                <a href="{% url 'recouvrement:detail_dossier_recouvrement' d.id %}">{{ d.reference }}</a>
                            </td>
                            <td>{{ d.creancier.nom|truncatechars:25 }}</td>
                            <td>
                                {% if d.type_recouvrement == 'amiable' %}
                                <span class="badge badge-info">Amiable</span>
                                {% else %}
                                <span class="badge badge-warning">Forcé</span>
                                {% endif %}
                            </td>
                            <td class="amount">{{ d.montant_principal|floatformat:0 }} F</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>Aucun dossier créé.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Derniers paiements -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">
                    <i data-lucide="credit-card"></i>
                    Derniers paiements
                </span>
            </div>
            <div class="card-body no-padding">
                {% if derniers_paiements %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Dossier</th>
                            <th>Mode</th>
                            <th class="amount">Montant</th>
                            <th>Reversé</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in derniers_paiements %}
                        <tr>
                            <td>{{ p.date_paiement|date:"d/m/Y" }}</td>
                            <td>
                                <a href="{% url 'recouvrement:detail_dossier_recouvrement' p.dossier.id %}">{{ p.dossier.reference }}</a>
                            </td>
                            <td>{{ p.get_mode_paiement_display }}</td>
                            <td class="amount">{{ p.montant|floatformat:0 }} F</td>
                            <td>
                                {% if p.est_reverse %}
                                <span class="badge badge-success">Oui</span>
                                {% else %}
                                <span class="badge badge-warning">Non</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>Aucun paiement enregistré.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Colonne latérale -->
    <div>
        <!-- Répartition par type -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">
                    <i data-lucide="pie-chart"></i>
                    Répartition
                </span>
            </div>
            <div class="card-body">
                <div class="taux-row">
                    <span class="label">Amiables</span>
                    <span class="value">{{ stats_dossiers.amiables }} dossiers</span>
                </div>
                <div class="taux-row">
                    <span class="label">Forcés</span>
                    <span class="value">{{ stats_dossiers.forces }} dossiers</span>
                </div>
                <div class="taux-row">
                    <span class="label">Suspendus</span>
                    <span class="value">{{ stats_dossiers.suspendus }} dossiers</span>
                </div>
                <div class="taux-row">
                    <span class="label">Clôturés</span>
                    <span class="value">{{ stats_dossiers.clotures }} dossiers</span>
                </div>
            </div>
        </div>

        <!-- Top créanciers -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">
                    <i data-lucide="trophy"></i>
                    Top créanciers
                </span>
            </div>
            <div class="card-body">
                {% if top_creanciers %}
                {% for c in top_creanciers %}
                <div class="creancier-item">
                    <div class="creancier-info">
                        <span class="creancier-rank">{{ forloop.counter }}</span>
                        <span class="creancier-name">{{ c.creancier__nom|truncatechars:20 }}</span>
                    </div>
                    <div class="creancier-stats">
                        <div>{{ c.total_creances|floatformat:0 }} F</div>
                        <div class="dossiers">{{ c.nombre_dossiers }} dossier{{ c.nombre_dossiers|pluralize }}</div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <p>Aucune donnée.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Accès rapides -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">
                    <i data-lucide="zap"></i>
                    Accès rapides
                </span>
            </div>
            <div class="card-body">
                <div class="quick-links">
                    <a href="{% url 'recouvrement:creer_dossier_recouvrement' %}" class="quick-link">
                        <i data-lucide="plus"></i>
                        <span>Nouveau dossier</span>
                    </a>
                    <a href="{% url 'recouvrement:liste_dossiers_recouvrement' %}?statut=en_cours" class="quick-link">
                        <i data-lucide="folder-open"></i>
                        <span>Dossiers actifs</span>
                    </a>
                    <a href="{% url 'recouvrement:point_global_creancier' %}" class="quick-link">
                        <i data-lucide="file-text"></i>
                        <span>Point global</span>
                    </a>
                    <a href="{% url 'recouvrement:liste_dossiers_recouvrement' %}?type=force" class="quick-link">
                        <i data-lucide="gavel"></i>
                        <span>Forcés</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
});
</script>
{% endblock %}
