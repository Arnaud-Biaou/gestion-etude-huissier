{% extends "base.html" %}
{% load static %}

{% block title %}{% if action == 'creer' %}Nouveau dossier{% else %}Modifier {{ dossier.reference }}{% endif %} - Recouvrement{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-title h1 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .breadcrumb {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
    }

    .form-card {
        background: var(--card-bg);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .form-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-group label {
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .form-group label .required {
        color: #dc2626;
    }

    .form-group select,
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="date"],
    .form-group textarea {
        padding: 0.625rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
    }

    .form-group input:read-only {
        background: var(--bg-secondary);
        cursor: not-allowed;
    }

    .form-group .help-text {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .radio-group {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.25rem;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .radio-item input[type="radio"] {
        width: 1rem;
        height: 1rem;
    }

    .btn-group {
        display: flex;
        gap: 0.75rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        padding: 0.625rem 1.5rem;
        border: none;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary:hover {
        background: #15294d;
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 0.625rem 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-secondary:hover {
        background: var(--border-color);
    }

    /* Messages */
    .messages {
        margin-bottom: 1.5rem;
    }

    .alert {
        padding: 1rem 1.25rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .alert-success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
    }

    .alert-error {
        background: #fee2e2;
        color: #dc2626;
        border: 1px solid #fca5a5;
    }

    /* Section clôture */
    .cloture-section {
        display: none;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .cloture-section.visible {
        display: block;
    }

    /* Info calculée */
    .info-calculee {
        background: var(--bg-secondary);
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .info-calculee .title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .info-calculee .value {
        font-family: monospace;
        font-size: 1.25rem;
        color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'recouvrement:dashboard_recouvrement' %}">Recouvrement</a> /
    <a href="{% url 'recouvrement:liste_dossiers_recouvrement' %}">Dossiers</a> /
    {% if action == 'creer' %}Nouveau dossier{% else %}Modifier {{ dossier.reference }}{% endif %}
</div>

<div class="page-header">
    <div class="page-title">
        <i data-lucide="{% if action == 'creer' %}plus-circle{% else %}edit{% endif %}"></i>
        <h1>{% if action == 'creer' %}Nouveau dossier de recouvrement{% else %}Modifier le dossier {{ dossier.reference }}{% endif %}</h1>
    </div>
</div>

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        <i data-lucide="{% if message.tags == 'success' %}check-circle{% else %}alert-circle{% endif %}"></i>
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<form method="post">
    {% csrf_token %}

    <!-- Informations principales -->
    <div class="form-card">
        <div class="form-card-title">
            <i data-lucide="file-text"></i>
            Informations principales
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="reference">Référence <span class="required">*</span></label>
                {% if action == 'creer' %}
                <input type="text" id="reference" name="reference" required placeholder="Ex: REC-2024-001">
                {% else %}
                <input type="text" id="reference" value="{{ dossier.reference }}" readonly>
                {% endif %}
            </div>
            <div class="form-group">
                <label for="creancier">Créancier <span class="required">*</span></label>
                <select id="creancier" name="creancier" {% if action == 'modifier' %}disabled{% endif %} required>
                    <option value="">-- Sélectionner un créancier --</option>
                    {% for c in creanciers %}
                    <option value="{{ c.id }}" {% if dossier and dossier.creancier_id == c.id %}selected{% endif %}>
                        {{ c.code }} - {{ c.nom }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="debiteur">Débiteur</label>
                <select id="debiteur" name="debiteur">
                    <option value="">-- Sélectionner un débiteur --</option>
                    {% for p in parties %}
                    <option value="{{ p.id }}" {% if dossier and dossier.debiteur_id == p.id %}selected{% endif %}>
                        {{ p.nom }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="date_ouverture">Date d'ouverture</label>
                <input type="date" id="date_ouverture" name="date_ouverture"
                       value="{% if dossier %}{{ dossier.date_ouverture|date:'Y-m-d' }}{% endif %}">
            </div>
        </div>
    </div>

    <!-- Type et mode -->
    <div class="form-card">
        <div class="form-card-title">
            <i data-lucide="settings"></i>
            Type et mode de facturation
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label>Type de recouvrement <span class="required">*</span></label>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="type_recouvrement" value="amiable"
                               {% if not dossier or dossier.type_recouvrement == 'amiable' %}checked{% endif %}
                               onchange="updateEmoluments()">
                        Amiable
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="type_recouvrement" value="force"
                               {% if dossier and dossier.type_recouvrement == 'force' %}checked{% endif %}
                               onchange="updateEmoluments()">
                        Forcé
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="mode_facturation">Mode de facturation</label>
                <select id="mode_facturation" name="mode_facturation">
                    <option value="standard" {% if dossier and dossier.mode_facturation == 'standard' %}selected{% endif %}>
                        Standard - Imputation automatique
                    </option>
                    <option value="reserve" {% if dossier and dossier.mode_facturation == 'reserve' %}selected{% endif %}>
                        Réservé - Imputation différée
                    </option>
                    <option value="banque" {% if dossier and dossier.mode_facturation == 'banque' %}selected{% endif %}>
                        Mode Banque - Reversement total + Facture
                    </option>
                </select>
                <span class="help-text">Détermine comment les paiements sont imputés automatiquement</span>
            </div>
            {% if action == 'modifier' %}
            <div class="form-group">
                <label for="statut">Statut</label>
                <select id="statut" name="statut" onchange="toggleClotureSection()">
                    <option value="en_cours" {% if dossier.statut == 'en_cours' %}selected{% endif %}>En cours</option>
                    <option value="suspendu" {% if dossier.statut == 'suspendu' %}selected{% endif %}>Suspendu</option>
                    <option value="cloture" {% if dossier.statut == 'cloture' %}selected{% endif %}>Clôturé</option>
                </select>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Montants -->
    <div class="form-card">
        <div class="form-card-title">
            <i data-lucide="banknote"></i>
            Montants de la créance
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="montant_principal">Montant principal (FCFA) <span class="required">*</span></label>
                <input type="number" id="montant_principal" name="montant_principal" required min="0"
                       value="{% if dossier %}{{ dossier.montant_principal|floatformat:0 }}{% endif %}"
                       onchange="updateEmoluments()">
            </div>
            <div class="form-group">
                <label for="montant_interets">Intérêts (FCFA)</label>
                <input type="number" id="montant_interets" name="montant_interets" min="0"
                       value="{% if dossier %}{{ dossier.montant_interets|floatformat:0 }}{% endif %}">
            </div>
            <div class="form-group">
                <label for="frais_engages">Frais engagés (FCFA)</label>
                <input type="number" id="frais_engages" name="frais_engages" min="0"
                       value="{% if dossier %}{{ dossier.frais_engages|floatformat:0 }}{% endif %}">
                <span class="help-text">Frais de procédure, signification, etc.</span>
            </div>
        </div>

        <div class="info-calculee" id="emolumentsInfo">
            <div class="title">Émoluments / Honoraires calculés</div>
            <div class="value" id="emolumentsValue">0 FCFA</div>
            <span class="help-text" id="emolumentsType">Selon le barème applicable</span>
        </div>
    </div>

    <!-- Suivi (modification uniquement) -->
    {% if action == 'modifier' %}
    <div class="form-card">
        <div class="form-card-title">
            <i data-lucide="clipboard-list"></i>
            Suivi du dossier
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="derniere_action">Dernière action</label>
                <input type="text" id="derniere_action" name="derniere_action"
                       value="{{ dossier.derniere_action }}" placeholder="Ex: Relance téléphonique">
            </div>
            <div class="form-group">
                <label for="prochaine_etape">Prochaine étape</label>
                <input type="text" id="prochaine_etape" name="prochaine_etape"
                       value="{{ dossier.prochaine_etape }}" placeholder="Ex: Mise en demeure">
            </div>
        </div>
    </div>

    <!-- Section clôture -->
    <div class="form-card cloture-section" id="clotureSection">
        <div class="form-card-title">
            <i data-lucide="check-circle"></i>
            Informations de clôture
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="motif_cloture">Motif de clôture</label>
                <select id="motif_cloture" name="motif_cloture">
                    <option value="">-- Sélectionner --</option>
                    <option value="recouvre" {% if dossier.motif_cloture == 'recouvre' %}selected{% endif %}>Créance recouvrée</option>
                    <option value="irrecoverable" {% if dossier.motif_cloture == 'irrecoverable' %}selected{% endif %}>Créance irrécouvrable</option>
                    <option value="abandon" {% if dossier.motif_cloture == 'abandon' %}selected{% endif %}>Abandon par le créancier</option>
                    <option value="prescription" {% if dossier.motif_cloture == 'prescription' %}selected{% endif %}>Prescription</option>
                    <option value="transaction" {% if dossier.motif_cloture == 'transaction' %}selected{% endif %}>Transaction</option>
                    <option value="autre" {% if dossier.motif_cloture == 'autre' %}selected{% endif %}>Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label for="date_cloture">Date de clôture</label>
                <input type="date" id="date_cloture" name="date_cloture"
                       value="{% if dossier.date_cloture %}{{ dossier.date_cloture|date:'Y-m-d' }}{% endif %}">
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Observations -->
    <div class="form-card">
        <div class="form-card-title">
            <i data-lucide="message-square"></i>
            Observations
        </div>
        <div class="form-group full-width">
            <textarea id="observations" name="observations" rows="4"
                      placeholder="Notes, remarques particulières...">{% if dossier %}{{ dossier.observations }}{% endif %}</textarea>
        </div>
    </div>

    <!-- Boutons -->
    <div class="btn-group">
        <a href="{% if dossier %}{% url 'recouvrement:detail_dossier_recouvrement' dossier.id %}{% else %}{% url 'recouvrement:liste_dossiers_recouvrement' %}{% endif %}" class="btn-secondary">
            <i data-lucide="x"></i>
            Annuler
        </a>
        <button type="submit" class="btn-primary">
            <i data-lucide="save"></i>
            {% if action == 'creer' %}Créer le dossier{% else %}Enregistrer{% endif %}
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();

    // Date par défaut si création
    {% if action == 'creer' %}
    if (!document.getElementById('date_ouverture').value) {
        document.getElementById('date_ouverture').value = new Date().toISOString().split('T')[0];
    }
    {% endif %}

    // Initialiser l'affichage des émoluments
    updateEmoluments();

    // Afficher section clôture si nécessaire
    {% if action == 'modifier' %}
    toggleClotureSection();
    {% endif %}
});

function getTypeRecouvrement() {
    const radios = document.getElementsByName('type_recouvrement');
    for (const radio of radios) {
        if (radio.checked) return radio.value;
    }
    return 'amiable';
}

async function updateEmoluments() {
    const montant = document.getElementById('montant_principal').value || 0;
    const type = getTypeRecouvrement();

    if (montant <= 0) {
        document.getElementById('emolumentsValue').textContent = '0 FCFA';
        document.getElementById('emolumentsType').textContent = 'Saisissez un montant principal';
        return;
    }

    try {
        const response = await fetch(`/recouvrement/api/calculer-honoraires/?montant=${montant}&type=${type}`);
        const data = await response.json();

        if (data.total_droit !== undefined) {
            const total = parseFloat(data.total_droit).toLocaleString('fr-FR');
            document.getElementById('emolumentsValue').textContent = total + ' FCFA';
            document.getElementById('emolumentsType').textContent =
                type === 'amiable' ? 'Honoraires phase amiable (charge créancier)' : 'Émoluments forcés (charge débiteur)';
        }
    } catch (error) {
        console.error('Erreur calcul émoluments:', error);
    }
}

function toggleClotureSection() {
    const statut = document.getElementById('statut').value;
    const section = document.getElementById('clotureSection');
    if (section) {
        if (statut === 'cloture') {
            section.classList.add('visible');
        } else {
            section.classList.remove('visible');
        }
    }
}
</script>
{% endblock %}
