{% extends 'base.html' %}
{% load static %}

{% block title %}{% if proforma %}Modifier{% else %}Nouvelle{% endif %} Proforma{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{% url 'gestion:liste_proformas' %}" class="text-decoration-none">
                <i class="fas fa-arrow-left"></i> Retour
            </a>
            <h2 class="mt-2">
                {% if proforma %}
                    Modifier {{ proforma.numero }}
                {% else %}
                    Nouvelle Proforma
                {% endif %}
            </h2>
        </div>
    </div>

    <form id="proformaForm">
        {% csrf_token %}
        <input type="hidden" id="proforma_id" value="{{ proforma.pk|default:'' }}">

        <div class="row">
            <!-- Colonne principale -->
            <div class="col-md-8">
                <!-- Informations client -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user"></i> Client</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="client" class="form-label">Nom du client *</label>
                                <input type="text" class="form-control" id="client" name="client"
                                       value="{{ proforma.client|default:'' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ifu" class="form-label">IFU</label>
                                <input type="text" class="form-control" id="ifu" name="ifu"
                                       value="{{ proforma.ifu|default:'' }}" maxlength="20">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dossier" class="form-label">Dossier (optionnel)</label>
                                <select class="form-select" id="dossier" name="dossier">
                                    <option value="">-- Aucun dossier --</option>
                                    {% for d in dossiers %}
                                    <option value="{{ d.pk }}" {% if proforma.dossier_id == d.pk %}selected{% endif %}>
                                        {{ d.reference }} - {{ d.get_intitule }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="date_validite" class="form-label">Date de validité</label>
                                <input type="date" class="form-control" id="date_validite" name="date_validite"
                                       value="{{ proforma.date_validite|date:'Y-m-d'|default:'' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lignes -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Lignes</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="ajouterLigneActe()">
                                <i class="fas fa-plus"></i> Ajouter un Acte
                            </button>
                            <button type="button" class="btn btn-sm btn-warning" onclick="ajouterLigneDebours()">
                                <i class="fas fa-plus"></i> Ajouter un Débours
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table mb-0" id="tableLignes">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 35%">Description</th>
                                    <th style="width: 15%" class="text-end">Honoraires</th>
                                    <th style="width: 12%" class="text-end">Timbre</th>
                                    <th style="width: 12%" class="text-end">Enregistrement</th>
                                    <th style="width: 15%" class="text-end">Total</th>
                                    <th style="width: 6%"></th>
                                </tr>
                            </thead>
                            <tbody id="lignesBody">
                                <!-- Lignes ajoutées dynamiquement -->
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td class="text-end"><strong>Honoraires :</strong></td>
                                    <td class="text-end"><strong id="totalHonoraires">0</strong></td>
                                    <td colspan="2" class="text-end"><strong>Débours :</strong></td>
                                    <td class="text-end"><strong id="totalDebours">0</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Total HT :</strong></td>
                                    <td class="text-end"><strong id="totalHT">0</strong> FCFA</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>TVA (sur honoraires) :</strong></td>
                                    <td class="text-end"><strong id="totalTVA">0</strong> FCFA</td>
                                    <td></td>
                                </tr>
                                <tr class="table-primary">
                                    <td colspan="4" class="text-end"><strong>Total TTC :</strong></td>
                                    <td class="text-end"><strong id="totalTTC">0</strong> FCFA</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Observations -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-comment"></i> Observations</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" id="observations" name="observations" rows="3">{{ proforma.observations|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Colonne actions -->
            <div class="col-md-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Récapitulatif</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td>Honoraires</td>
                                <td class="text-end" id="recapHonoraires">0 FCFA</td>
                            </tr>
                            <tr>
                                <td>Débours</td>
                                <td class="text-end" id="recapDebours">0 FCFA</td>
                            </tr>
                            <tr class="border-top">
                                <td>Total HT</td>
                                <td class="text-end" id="recapHT">0 FCFA</td>
                            </tr>
                            <tr>
                                <td>TVA (5%)</td>
                                <td class="text-end" id="recapTVA">0 FCFA</td>
                            </tr>
                            <tr class="border-top">
                                <td><strong>Total TTC</strong></td>
                                <td class="text-end"><strong id="recapTTC">0 FCFA</strong></td>
                            </tr>
                        </table>
                    </div>
                    <div class="card-footer">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" onclick="sauvegarderProforma('brouillon')">
                                <i class="fas fa-save"></i> Enregistrer (Brouillon)
                            </button>
                            <button type="button" class="btn btn-success" onclick="sauvegarderProforma('envoyee')">
                                <i class="fas fa-paper-plane"></i> Enregistrer et Envoyer
                            </button>
                            <a href="{% url 'gestion:liste_proformas' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Annuler
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Régime TPS: l'étude paie 5% du CA annuel à l'État, mais PAS facturé au client
// Donc taux sur facture = 0% (contrairement au régime réel où TVA 18% est facturée)
const TAUX_TVA = 0;

let ligneIndex = 0;

// Ajouter une ligne ACTE (honoraires + timbre + enregistrement)
function ajouterLigneActe(data = null) {
    const tbody = document.getElementById('lignesBody');
    const tr = document.createElement('tr');
    tr.className = 'ligne-acte';
    tr.dataset.type = 'acte';
    tr.id = `ligne_${ligneIndex}`;

    const honoraires = data ? (data.honoraires || data.prix_unitaire || '') : '';
    const timbre = data ? (data.timbre || '') : '';
    const enreg = data ? (data.enregistrement || '') : '';
    const description = data ? data.description : '';

    tr.innerHTML = `
        <td>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary">ACTE</span>
                <input type="text" class="form-control form-control-sm ligne-description"
                       placeholder="Intitulé de l'acte..." value="${description}" required>
            </div>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm text-end ligne-honoraires"
                   placeholder="0" min="0" value="${honoraires}" onchange="calculerTotaux()">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm text-end ligne-timbre"
                   placeholder="0" min="0" value="${timbre}" onchange="calculerTotaux()">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm text-end ligne-enreg"
                   placeholder="0" min="0" value="${enreg}" onchange="calculerTotaux()">
        </td>
        <td class="text-end ligne-total fw-bold">0</td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="supprimerLigne(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(tr);
    ligneIndex++;
    calculerTotaux();
}

// Ajouter une ligne DÉBOURS (montant unique)
function ajouterLigneDebours(data = null) {
    const tbody = document.getElementById('lignesBody');
    const tr = document.createElement('tr');
    tr.className = 'ligne-debours';
    tr.dataset.type = 'debours';
    tr.id = `ligne_${ligneIndex}`;
    tr.style.backgroundColor = '#fffbeb';

    const montant = data ? (data.montant || data.prix_unitaire || '') : '';
    const description = data ? data.description : '';

    tr.innerHTML = `
        <td colspan="3">
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-warning text-dark">DÉBOURS</span>
                <input type="text" class="form-control form-control-sm ligne-description"
                       placeholder="Description du débours..." value="${description}" required>
            </div>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm text-end ligne-montant"
                   placeholder="0" min="0" value="${montant}" onchange="calculerTotaux()">
        </td>
        <td class="text-end ligne-total fw-bold">0</td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="supprimerLigne(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(tr);
    ligneIndex++;
    calculerTotaux();
}

function supprimerLigne(btn) {
    const tr = btn.closest('tr');
    if (tr) {
        tr.remove();
        calculerTotaux();
    }
}

function calculerTotaux() {
    let totalHonoraires = 0;
    let totalDebours = 0;

    // Lignes ACTE
    document.querySelectorAll('.ligne-acte').forEach(tr => {
        const honoraires = parseFloat(tr.querySelector('.ligne-honoraires')?.value) || 0;
        const timbre = parseFloat(tr.querySelector('.ligne-timbre')?.value) || 0;
        const enreg = parseFloat(tr.querySelector('.ligne-enreg')?.value) || 0;

        const ligneTotal = honoraires + timbre + enreg;
        totalHonoraires += honoraires;
        totalDebours += timbre + enreg;  // Timbre et enregistrement = débours exonérés

        tr.querySelector('.ligne-total').textContent = Math.round(ligneTotal).toLocaleString('fr-FR');
    });

    // Lignes DÉBOURS
    document.querySelectorAll('.ligne-debours').forEach(tr => {
        const montant = parseFloat(tr.querySelector('.ligne-montant')?.value) || 0;
        totalDebours += montant;
        tr.querySelector('.ligne-total').textContent = Math.round(montant).toLocaleString('fr-FR');
    });

    // Calcul TVA (régime TPS = 0% sur facture, l'étude paie 5% du CA annuel)
    const totalHT = totalHonoraires + totalDebours;
    const montantTVA = totalHonoraires * TAUX_TVA / 100;
    const totalTTC = totalHT + montantTVA;

    // Mise à jour tableau
    document.getElementById('totalHonoraires').textContent = Math.round(totalHonoraires).toLocaleString('fr-FR');
    document.getElementById('totalDebours').textContent = Math.round(totalDebours).toLocaleString('fr-FR');
    document.getElementById('totalHT').textContent = Math.round(totalHT).toLocaleString('fr-FR');
    document.getElementById('totalTVA').textContent = Math.round(montantTVA).toLocaleString('fr-FR');
    document.getElementById('totalTTC').textContent = Math.round(totalTTC).toLocaleString('fr-FR');

    // Mise à jour récap
    document.getElementById('recapHonoraires').textContent = Math.round(totalHonoraires).toLocaleString('fr-FR') + ' FCFA';
    document.getElementById('recapDebours').textContent = Math.round(totalDebours).toLocaleString('fr-FR') + ' FCFA';
    document.getElementById('recapHT').textContent = Math.round(totalHT).toLocaleString('fr-FR') + ' FCFA';
    document.getElementById('recapTVA').textContent = Math.round(montantTVA).toLocaleString('fr-FR') + ' FCFA';
    document.getElementById('recapTTC').textContent = Math.round(totalTTC).toLocaleString('fr-FR') + ' FCFA';
}

function collecterLignes() {
    const lignes = [];

    // Actes
    document.querySelectorAll('.ligne-acte').forEach(tr => {
        const description = tr.querySelector('.ligne-description')?.value;
        const honoraires = parseFloat(tr.querySelector('.ligne-honoraires')?.value) || 0;
        const timbre = parseFloat(tr.querySelector('.ligne-timbre')?.value) || 0;
        const enreg = parseFloat(tr.querySelector('.ligne-enreg')?.value) || 0;

        if (description && (honoraires > 0 || timbre > 0 || enreg > 0)) {
            lignes.push({
                type_ligne: 'acte',
                description: description,
                honoraires: honoraires,
                timbre: timbre,
                enregistrement: enreg,
                prix_unitaire: honoraires,
                quantite: 1,
                groupe_taxation: 'E'  // Honoraires taxables TPS
            });
        }
    });

    // Débours
    document.querySelectorAll('.ligne-debours').forEach(tr => {
        const description = tr.querySelector('.ligne-description')?.value;
        const montant = parseFloat(tr.querySelector('.ligne-montant')?.value) || 0;

        if (description && montant > 0) {
            lignes.push({
                type_ligne: 'debours',
                description: description,
                prix_unitaire: montant,
                quantite: 1,
                groupe_taxation: 'A'  // Débours exonérés
            });
        }
    });

    return lignes;
}

function sauvegarderProforma(statut) {
    const lignes = collecterLignes();

    if (lignes.length === 0) {
        alert('Veuillez ajouter au moins une ligne.');
        return;
    }

    const client = document.getElementById('client').value;
    if (!client) {
        alert('Veuillez saisir le nom du client.');
        return;
    }

    const data = {
        proforma_id: document.getElementById('proforma_id').value || null,
        client: client,
        ifu: document.getElementById('ifu').value,
        dossier_id: document.getElementById('dossier').value || null,
        date_validite: document.getElementById('date_validite').value || null,
        observations: document.getElementById('observations').value,
        statut: statut,
        taux_tva: TAUX_TVA,
        lignes: lignes
    };

    fetch("{% url 'gestion:api_sauvegarder_proforma' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Proforma ' + result.numero + ' enregistrée avec succès !');
            window.location.href = "{% url 'gestion:detail_proforma' 0 %}".replace('0', result.proforma_id);
        } else {
            alert('Erreur : ' + (result.error || 'Erreur inconnue'));
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur de communication avec le serveur.');
    });
}

// Charger les lignes existantes si modification
document.addEventListener('DOMContentLoaded', function() {
    {% if proforma and lignes %}
    const lignesExistantes = [
        {% for ligne in lignes %}
        {
            description: "{{ ligne.description|escapejs }}",
            type_ligne: "{{ ligne.type_ligne }}",
            honoraires: {{ ligne.honoraires|default:0 }},
            timbre: {{ ligne.timbre|default:0 }},
            enregistrement: {{ ligne.enregistrement|default:0 }},
            prix_unitaire: {{ ligne.prix_unitaire|default:0 }},
            montant: {{ ligne.prix_unitaire|default:0 }}
        },
        {% endfor %}
    ];

    lignesExistantes.forEach(l => {
        if (l.type_ligne === 'acte') {
            ajouterLigneActe(l);
        } else {
            ajouterLigneDebours(l);
        }
    });
    {% else %}
    // Ajouter une ligne acte vide par défaut
    ajouterLigneActe();
    {% endif %}
});
</script>
{% endblock %}
