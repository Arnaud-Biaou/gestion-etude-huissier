{% extends 'base.html' %}

{% block breadcrumb %}
<span class="breadcrumb-separator"></span>
<a href="{% url 'gestion:dossiers' %}" class="breadcrumb-item">Dossiers</a>
<span class="breadcrumb-separator"></span>
<span class="breadcrumb-current">{{ dossier.reference }}</span>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex justify-between items-center flex-wrap gap-4 mb-4">
    <div class="flex items-center gap-4">
        <a href="{% url 'gestion:dossiers' %}" class="btn btn-secondary btn-sm">
            <i data-lucide="arrow-left"></i> Retour
        </a>
        <div>
            <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">{{ dossier.reference }}</h2>
            <p style="color: var(--neutral-500);">{{ dossier.get_intitule }}</p>
        </div>
    </div>
    <div class="flex gap-2">
        <a href="{% url 'gestion:securiser_acte' dossier.pk %}" class="btn btn-secondary">
            <i data-lucide="qr-code"></i> Sécuriser
        </a>
        <a href="{% url 'gestion:modifier_dossier' dossier.pk %}" class="btn btn-primary">
            <i data-lucide="edit"></i> Modifier
        </a>
        <button class="btn btn-secondary" onclick="window.print()">
            <i data-lucide="printer"></i> Imprimer
        </button>
    </div>
</div>

<!-- Badges statut et phase -->
<div class="flex gap-2 mb-4">
    <span class="status-badge {{ dossier.statut }}">
        {% if dossier.statut == 'actif' %}
        <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i> Actif
        {% elif dossier.statut == 'urgent' %}
        <i data-lucide="alert-circle" style="width: 12px; height: 12px;"></i> Urgent
        {% elif dossier.statut == 'archive' %}
        <i data-lucide="archive" style="width: 12px; height: 12px;"></i> Archivé
        {% elif dossier.statut == 'cloture' %}
        <i data-lucide="lock" style="width: 12px; height: 12px;"></i> Clôturé
        {% endif %}
    </span>
    <span class="status-badge {% if dossier.is_contentieux %}contentieux{% else %}non-contentieux{% endif %}">
        {{ dossier.is_contentieux|yesno:"Contentieux,Non-contentieux" }}
    </span>
    <span class="status-badge {% if dossier.phase == 'force' %}urgent{% else %}actif{% endif %}">
        <i data-lucide="{% if dossier.phase == 'force' %}gavel{% else %}handshake{% endif %}" style="width: 12px; height: 12px;"></i>
        Phase {{ dossier.get_phase_display }}
    </span>
</div>

<!-- Statistiques financières -->
<div class="grid grid-cols-4 gap-4 mb-4">
    <div class="card" style="padding: 16px;">
        <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 4px;">Montant Total Dû</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">{{ stats.montant_total_du|floatformat:0 }} F</div>
    </div>
    <div class="card" style="padding: 16px;">
        <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 4px;">Total Encaissé</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">{{ stats.total_encaisse|floatformat:0 }} F</div>
    </div>
    <div class="card" style="padding: 16px;">
        <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 4px;">Solde Restant</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">{{ stats.solde_restant|floatformat:0 }} F</div>
    </div>
    <div class="card" style="padding: 16px;">
        <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 4px;">Taux Recouvrement</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">{{ stats.taux_recouvrement|floatformat:1 }}%</div>
    </div>
</div>

<div class="grid grid-cols-2 gap-4">
    <!-- Colonne gauche -->
    <div>
        <!-- Informations générales -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="info" style="width: 18px; height: 18px;"></i> Informations générales</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Référence</span>
                        <p style="font-weight: 600;">{{ dossier.reference }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Type</span>
                        <p style="font-weight: 500;">{{ dossier.get_type_dossier_display|default:"-" }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Date d'ouverture</span>
                        <p style="font-weight: 500;">{{ dossier.date_ouverture|date:"d/m/Y" }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Affecté à</span>
                        <p style="font-weight: 500;">{{ dossier.affecte_a.nom|default:"-" }}</p>
                    </div>
                    {% if dossier.creancier %}
                    <div class="col-span-2">
                        <span style="color: var(--neutral-500); font-size: 12px;">Créancier</span>
                        <p style="font-weight: 500;">{{ dossier.creancier.nom }}</p>
                    </div>
                    {% endif %}
                    {% if dossier.description %}
                    <div class="col-span-2">
                        <span style="color: var(--neutral-500); font-size: 12px;">Description</span>
                        <p style="font-weight: 500;">{{ dossier.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Montants détaillés -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="calculator" style="width: 18px; height: 18px;"></i> Montants détaillés</h3>
            </div>
            <div class="card-body">
                <table class="w-full">
                    <tbody>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Montant créance</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_creance|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Principal</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_principal|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Intérêts</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_interets|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Frais de procédure</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_frais|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Émoluments</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_emoluments|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Dépens</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_depens|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; font-weight: 700;">TOTAL</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 700; color: var(--primary);">{{ stats.montant_total_du|floatformat:0 }} F</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% if dossier.phase == 'force' and dossier.titre_executoire_type %}
        <!-- Titre exécutoire -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="file-check" style="width: 18px; height: 18px;"></i> Titre exécutoire</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Type</span>
                        <p style="font-weight: 500;">{{ dossier.titre_executoire_type }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Référence</span>
                        <p style="font-weight: 500;">{{ dossier.titre_executoire_reference|default:"-" }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Date</span>
                        <p style="font-weight: 500;">{{ dossier.titre_executoire_date|date:"d/m/Y"|default:"-" }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Juridiction</span>
                        <p style="font-weight: 500;">{{ dossier.titre_executoire_juridiction|default:"-" }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Colonne droite -->
    <div>
        <!-- Demandeurs -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="user" style="width: 18px; height: 18px;"></i> Demandeur(s) / Client(s)</h3>
            </div>
            <div class="card-body">
                {% for partie in demandeurs %}
                <div style="{% if not forloop.last %}border-bottom: 1px solid var(--neutral-200); margin-bottom: 12px; padding-bottom: 12px;{% endif %}">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: {% if partie.type_personne == 'physique' %}var(--info-light){% else %}var(--accent-light){% endif %}; color: {% if partie.type_personne == 'physique' %}white{% else %}var(--primary-dark){% endif %};">
                            {{ partie.type_personne|title }}
                        </span>
                        {% if partie.est_commercant or partie.nom_commercial or partie.enseigne %}
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: var(--success-light); color: var(--success-dark);">
                            Commerçant
                        </span>
                        {% endif %}
                    </div>
                    <p style="font-weight: 600; margin-bottom: 4px;">{{ partie.get_nom_complet }}</p>
                    {% if partie.nom_commercial %}
                    <p style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                        <i data-lucide="store" style="width: 12px; height: 12px; display: inline;"></i>
                        Nom commercial : <strong>{{ partie.nom_commercial }}</strong>
                    </p>
                    {% endif %}
                    {% if partie.enseigne %}
                    <p style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                        <i data-lucide="building-2" style="width: 12px; height: 12px; display: inline;"></i>
                        Enseigne : <strong>{{ partie.enseigne }}</strong>
                    </p>
                    {% endif %}
                    {% if partie.activite_commerciale %}
                    <p style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">
                        <i data-lucide="briefcase" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.activite_commerciale }}
                    </p>
                    {% endif %}
                    {% if partie.domicile or partie.siege_social %}
                    <p style="font-size: 13px; color: var(--neutral-600);">
                        <i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.domicile|default:partie.siege_social }}
                    </p>
                    {% endif %}
                    {% if partie.telephone %}
                    <p style="font-size: 13px; color: var(--neutral-600);">
                        <i data-lucide="phone" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.telephone }}
                    </p>
                    {% endif %}
                </div>
                {% empty %}
                <p style="color: var(--neutral-500); font-style: italic;">Aucun demandeur enregistré</p>
                {% endfor %}
            </div>
        </div>

        <!-- Défendeurs -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="users" style="width: 18px; height: 18px;"></i> Défendeur(s) / Débiteur(s)</h3>
            </div>
            <div class="card-body">
                {% for partie in defendeurs %}
                <div style="{% if not forloop.last %}border-bottom: 1px solid var(--neutral-200); margin-bottom: 12px; padding-bottom: 12px;{% endif %}">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: {% if partie.type_personne == 'physique' %}var(--warning-light){% else %}var(--danger-light){% endif %}; color: var(--primary-dark);">
                            {{ partie.type_personne|title }}
                        </span>
                        {% if partie.est_commercant or partie.nom_commercial or partie.enseigne %}
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: var(--success-light); color: var(--success-dark);">
                            Commerçant
                        </span>
                        {% endif %}
                    </div>
                    <p style="font-weight: 600; margin-bottom: 4px;">{{ partie.get_nom_complet }}</p>
                    {% if partie.nom_commercial %}
                    <p style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                        <i data-lucide="store" style="width: 12px; height: 12px; display: inline;"></i>
                        Nom commercial : <strong>{{ partie.nom_commercial }}</strong>
                    </p>
                    {% endif %}
                    {% if partie.enseigne %}
                    <p style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                        <i data-lucide="building-2" style="width: 12px; height: 12px; display: inline;"></i>
                        Enseigne : <strong>{{ partie.enseigne }}</strong>
                    </p>
                    {% endif %}
                    {% if partie.activite_commerciale %}
                    <p style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">
                        <i data-lucide="briefcase" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.activite_commerciale }}
                    </p>
                    {% endif %}
                    {% if partie.domicile or partie.siege_social %}
                    <p style="font-size: 13px; color: var(--neutral-600);">
                        <i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.domicile|default:partie.siege_social }}
                    </p>
                    {% endif %}
                    {% if partie.telephone %}
                    <p style="font-size: 13px; color: var(--neutral-600);">
                        <i data-lucide="phone" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.telephone }}
                    </p>
                    {% endif %}
                </div>
                {% empty %}
                <p style="color: var(--neutral-500); font-style: italic;">Aucun défendeur enregistré</p>
                {% endfor %}
            </div>
        </div>

        <!-- Encaissements récents -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="banknote" style="width: 18px; height: 18px;"></i> Encaissements récents</h3>
            </div>
            <div class="card-body" style="padding: 0;">
                {% if encaissements %}
                <table class="w-full">
                    <thead>
                        <tr style="background: var(--neutral-50);">
                            <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                            <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Référence</th>
                            <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Montant</th>
                            <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enc in encaissements %}
                        <tr style="border-bottom: 1px solid var(--neutral-100);">
                            <td style="padding: 8px 12px; font-size: 13px;">{{ enc.date_encaissement|date:"d/m/Y" }}</td>
                            <td style="padding: 8px 12px; font-size: 13px;">{{ enc.reference }}</td>
                            <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600;">{{ enc.montant|floatformat:0 }} F</td>
                            <td style="padding: 8px 12px; text-align: center;">
                                <span class="status-badge {{ enc.statut }}">{{ enc.get_statut_display }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="padding: 16px; color: var(--neutral-500); font-style: italic;">Aucun encaissement</p>
                {% endif %}
            </div>
        </div>

        <!-- Factures -->
        <div class="card mb-4">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title"><i data-lucide="file-text" style="width: 18px; height: 18px;"></i> Factures</h3>
                <span style="background: var(--info-light); color: var(--info); padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">{{ factures|length }}</span>
            </div>
            <div class="card-body" style="padding: 0;">
                {% if factures %}
                <table class="w-full">
                    <thead>
                        <tr style="background: var(--neutral-50);">
                            <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Numéro</th>
                            <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                            <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Montant TTC</th>
                            <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fac in factures %}
                        <tr style="border-bottom: 1px solid var(--neutral-100);">
                            <td style="padding: 8px 12px; font-size: 13px; color: var(--primary); font-weight: 500;">
                                {{ fac.numero }}
                            </td>
                            <td style="padding: 8px 12px; font-size: 13px;">{{ fac.date_emission|date:"d/m/Y" }}</td>
                            <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600;">{{ fac.montant_ttc|floatformat:0 }} F</td>
                            <td style="padding: 8px 12px; text-align: center;">
                                <span class="status-badge {% if fac.statut == 'payee' %}actif{% elif fac.statut == 'attente' %}urgent{% else %}archive{% endif %}">{{ fac.get_statut_display }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="padding: 16px; color: var(--neutral-500); font-style: italic;">Aucune facture</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Section pleine largeur : Tâches et Mouvements -->
<div class="grid grid-cols-2 gap-4 mb-4">
    <!-- Tâches liées -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title"><i data-lucide="check-square" style="width: 18px; height: 18px;"></i> Tâches liées</h3>
            <span style="background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">{{ taches_dossier|length }}</span>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if taches_dossier %}
            <table class="w-full">
                <thead>
                    <tr style="background: var(--neutral-50);">
                        <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Titre</th>
                        <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Échéance</th>
                        <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Priorité</th>
                        <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Statut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tache in taches_dossier %}
                    <tr style="border-bottom: 1px solid var(--neutral-100);">
                        <td style="padding: 8px 12px; font-size: 13px; color: var(--primary); font-weight: 500;">
                            {{ tache.titre|truncatechars:30 }}
                        </td>
                        <td style="padding: 8px 12px; font-size: 13px;">{{ tache.date_echeance|date:"d/m/Y" }}</td>
                        <td style="padding: 8px 12px; text-align: center;">
                            <span class="status-badge {% if tache.priorite == 'haute' or tache.priorite == 'urgente' %}urgent{% elif tache.priorite == 'normale' %}actif{% else %}archive{% endif %}">
                                {{ tache.get_priorite_display|default:tache.priorite }}
                            </span>
                        </td>
                        <td style="padding: 8px 12px; text-align: center;">
                            <span class="status-badge {% if tache.statut == 'terminee' %}actif{% elif tache.statut == 'en_cours' %}urgent{% else %}archive{% endif %}">
                                {{ tache.get_statut_display|default:tache.statut }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="padding: 16px; color: var(--neutral-500); font-style: italic;">Aucune tâche liée</p>
            {% endif %}
        </div>
    </div>

    <!-- Mouvements de trésorerie -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title"><i data-lucide="wallet" style="width: 18px; height: 18px;"></i> Mouvements de trésorerie</h3>
            <span style="background: var(--success-light); color: var(--success); padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">{{ mouvements_dossier|length }}</span>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if mouvements_dossier %}
            <table class="w-full">
                <thead>
                    <tr style="background: var(--neutral-50);">
                        <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                        <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Libellé</th>
                        <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Type</th>
                        <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mvt in mouvements_dossier %}
                    <tr style="border-bottom: 1px solid var(--neutral-100);">
                        <td style="padding: 8px 12px; font-size: 13px;">{{ mvt.date_mouvement|date:"d/m/Y" }}</td>
                        <td style="padding: 8px 12px; font-size: 13px;">{{ mvt.libelle|truncatechars:25 }}</td>
                        <td style="padding: 8px 12px; text-align: center;">
                            <span class="status-badge {% if mvt.type_mouvement == 'entree' %}actif{% else %}urgent{% endif %}">
                                {% if mvt.type_mouvement == 'entree' %}<i data-lucide="arrow-down-circle" style="width: 12px; height: 12px;"></i>{% else %}<i data-lucide="arrow-up-circle" style="width: 12px; height: 12px;"></i>{% endif %}
                                {{ mvt.get_type_mouvement_display }}
                            </span>
                        </td>
                        <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600; color: {% if mvt.type_mouvement == 'entree' %}var(--success){% else %}var(--danger){% endif %};">
                            {% if mvt.type_mouvement == 'entree' %}+{% else %}-{% endif %}{{ mvt.montant|floatformat:0 }} F
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="padding: 16px; color: var(--neutral-500); font-style: italic;">Aucun mouvement</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Section Actes Sécurisés -->
<div class="card mb-4">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title"><i data-lucide="qr-code" style="width: 18px; height: 18px;"></i> Actes Sécurisés</h3>
        <a href="{% url 'gestion:securiser_acte' dossier.id %}" class="btn btn-primary btn-sm">
            + Sécuriser un acte
        </a>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if dossier.actes_securises.exists %}
        <table class="w-full">
            <thead>
                <tr style="background: var(--neutral-50);">
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Code</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Type</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Titre</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                    <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Vérif.</th>
                    <th style="padding: 8px 12px; text-align: center; font-size: 12px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for acte in dossier.actes_securises.all|slice:":5" %}
                <tr style="border-bottom: 1px solid var(--neutral-100);">
                    <td style="padding: 8px 12px; font-size: 13px;">
                        <code style="font-size: 11px; background: var(--neutral-100); padding: 2px 6px; border-radius: 4px;">{{ acte.code_verification }}</code>
                    </td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ acte.get_type_acte_display }}</td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ acte.titre_acte|truncatechars:25 }}</td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ acte.date_acte|date:"d/m/Y" }}</td>
                    <td style="padding: 8px 12px; text-align: center;">
                        <span style="background: var(--neutral-100); padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                            {{ acte.nombre_verifications }}
                        </span>
                    </td>
                    <td style="padding: 8px 12px; text-align: center;">
                        <a href="{% url 'gestion:acte_securise_detail' acte.id %}" class="btn btn-sm btn-secondary" style="padding: 4px 8px; font-size: 11px;">
                            QR
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if dossier.actes_securises.count > 5 %}
        <div style="text-align: center; padding: 12px; border-top: 1px solid var(--neutral-100);">
            <a href="{% url 'gestion:liste_actes_securises' dossier.id %}" style="color: var(--primary); font-size: 13px;">
                Voir tous les actes sécurisés ({{ dossier.actes_securises.count }})
            </a>
        </div>
        {% endif %}
        {% else %}
        <p style="padding: 20px; color: var(--neutral-500); font-style: italic; text-align: center;">
            Aucun acte sécurisé pour ce dossier
        </p>
        {% endif %}
    </div>
</div>

<!-- Section Actes Réalisés (pour facturation) -->
<div class="card mb-4">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title"><i data-lucide="file-signature" style="width: 18px; height: 18px;"></i> Actes réalisés</h3>
        <button type="button" class="btn btn-primary btn-sm" onclick="ouvrirModalAjoutActe()">
            + Ajouter un acte
        </button>
    </div>
    <div class="card-body" style="padding: 0;">
        <div id="actes-realises-container">
            <div style="padding: 20px; text-align: center; color: var(--neutral-500);">
                <i data-lucide="loader" class="spin" style="width: 24px; height: 24px;"></i>
                Chargement...
            </div>
        </div>
    </div>
    <div id="actes-totaux" class="card-footer" style="display: none; padding: 12px 16px; background: var(--neutral-50); border-top: 1px solid var(--neutral-200);">
        <div class="flex justify-between" style="font-size: 13px;">
            <span><strong>Total honoraires:</strong> <span id="total-honoraires">0</span> F</span>
            <span><strong>Total débours:</strong> <span id="total-debours">0</span> F</span>
            <span style="color: var(--primary);"><strong>Total TTC:</strong> <span id="total-ttc">0</span> F</span>
            <span><strong>Non facturés:</strong> <span id="total-non-factures">0</span> F</span>
        </div>
    </div>
</div>

<!-- Modal Ajout Acte -->
<div id="modal-ajout-acte" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="fermerModalAjoutActe()"></div>
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Ajouter un acte réalisé</h3>
            <button type="button" class="modal-close" onclick="fermerModalAjoutActe()">&times;</button>
        </div>
        <form id="form-ajout-acte" onsubmit="sauvegarderActeDossier(event)">
            <div class="modal-body">
                <div class="form-group mb-3">
                    <label for="acte-type">Type d'acte</label>
                    <select id="acte-type" name="type_acte" class="form-control">
                        <option value="">-- Sélectionner un type --</option>
                        {% for type in types_actes %}
                        <option value="{{ type.id }}" data-honoraires="{{ type.tarif_base|default:0 }}" data-feuillets="{{ type.feuillets_defaut|default:1 }}">
                            {{ type.nom }} {% if type.tarif_base %}({{ type.tarif_base|floatformat:0 }} F){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group mb-3">
                    <label for="acte-intitule">Intitulé de l'acte *</label>
                    <input type="text" id="acte-intitule" name="intitule" class="form-control" required placeholder="Ex: Commandement de payer du 03/12/2025">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group mb-3">
                        <label for="acte-date">Date de l'acte *</label>
                        <input type="date" id="acte-date" name="date_acte" class="form-control" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="acte-honoraires">Honoraires (FCFA) *</label>
                        <input type="number" id="acte-honoraires" name="honoraires" class="form-control" min="0" value="0" required>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group mb-3">
                        <label for="acte-feuillets">Nombre de feuillets</label>
                        <input type="number" id="acte-feuillets" name="feuillets" class="form-control" min="1" value="1">
                    </div>
                    <div class="form-group mb-3">
                        <label for="acte-timbre">Timbre fiscal</label>
                        <input type="number" id="acte-timbre" name="timbre" class="form-control" min="0" value="0">
                        <small style="color: var(--neutral-500); font-size: 11px;">1200 F/feuillet</small>
                    </div>
                    <div class="form-group mb-3">
                        <label for="acte-enregistrement">Enregistrement</label>
                        <input type="number" id="acte-enregistrement" name="enregistrement" class="form-control" min="0" value="0">
                        <small style="color: var(--neutral-500); font-size: 11px;">2500 F si applicable</small>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label for="acte-debours">Débours divers</label>
                    <input type="number" id="acte-debours" name="debours_divers" class="form-control" min="0" value="0">
                </div>
                <div class="flex gap-3 mb-3">
                    <label class="flex items-center gap-2" style="cursor: pointer;">
                        <input type="checkbox" id="calc-timbre" onchange="calculerTimbreAuto()">
                        <span style="font-size: 13px;">Calculer timbre automatiquement</span>
                    </label>
                    <label class="flex items-center gap-2" style="cursor: pointer;">
                        <input type="checkbox" id="add-enregistrement" onchange="ajouterEnregistrement()">
                        <span style="font-size: 13px;">Ajouter droit d'enregistrement (2500 F)</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fermerModalAjoutActe()">Annuler</button>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Historique des basculements (si phase forcée) -->
{% if dossier.phase == 'force' and basculements %}
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title"><i data-lucide="history" style="width: 18px; height: 18px;"></i> Historique des basculements</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <table class="w-full">
            <thead>
                <tr style="background: var(--neutral-50);">
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Type</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Motif</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Par</th>
                </tr>
            </thead>
            <tbody>
                {% for basc in basculements %}
                <tr style="border-bottom: 1px solid var(--neutral-100);">
                    <td style="padding: 8px 12px; font-size: 13px;">{{ basc.date_basculement|date:"d/m/Y H:i" }}</td>
                    <td style="padding: 8px 12px; font-size: 13px;">
                        <span class="status-badge urgent">
                            <i data-lucide="zap" style="width: 12px; height: 12px;"></i> Phase forcée
                        </span>
                    </td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ basc.motif|default:"-" }}</td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ basc.effectue_par|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Métadonnées -->
<div class="card">
    <div class="card-body" style="padding: 12px 16px; background: var(--neutral-50);">
        <div class="flex justify-between" style="font-size: 12px; color: var(--neutral-500);">
            <span>Créé le {{ dossier.date_creation|date:"d/m/Y à H:i" }}{% if dossier.cree_par %} par {{ dossier.cree_par }}{% endif %}</span>
            <span>Dernière modification: {{ dossier.date_modification|date:"d/m/Y à H:i" }}</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const DOSSIER_ID = {{ dossier.id }};

    // Charger les actes au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        chargerActesDossier();
        // Définir la date du jour par défaut
        document.getElementById('acte-date').valueAsDate = new Date();
    });

    // Charger la liste des actes réalisés
    async function chargerActesDossier() {
        try {
            const response = await fetch(`/api/dossier/${DOSSIER_ID}/actes/`);
            const data = await response.json();

            const container = document.getElementById('actes-realises-container');
            const totauxDiv = document.getElementById('actes-totaux');

            if (data.actes && data.actes.length > 0) {
                let html = `
                    <table class="w-full">
                        <thead>
                            <tr style="background: var(--neutral-50);">
                                <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                                <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Intitulé</th>
                                <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Honoraires</th>
                                <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Débours</th>
                                <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Total</th>
                                <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Statut</th>
                                <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.actes.forEach(acte => {
                    const statutClass = acte.est_facture ? 'actif' : 'urgent';
                    const statutText = acte.est_facture ? 'Facturé' : 'Non facturé';
                    const deleteBtn = acte.est_facture ? '' : `
                        <button type="button" class="btn btn-sm" style="padding: 4px 8px; background: var(--danger-light); color: var(--danger);"
                                onclick="supprimerActeDossier(${acte.id})" title="Supprimer">
                            <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                        </button>
                    `;

                    html += `
                        <tr style="border-bottom: 1px solid var(--neutral-100);">
                            <td style="padding: 8px 12px; font-size: 13px;">${acte.date_acte}</td>
                            <td style="padding: 8px 12px; font-size: 13px;" title="${acte.intitule}">
                                ${acte.intitule.length > 35 ? acte.intitule.substring(0, 35) + '...' : acte.intitule}
                                ${acte.type_acte ? `<br><small style="color: var(--neutral-500);">${acte.type_acte}</small>` : ''}
                            </td>
                            <td style="padding: 8px 12px; font-size: 13px; text-align: right;">${formatMontant(acte.honoraires)} F</td>
                            <td style="padding: 8px 12px; font-size: 13px; text-align: right;">${formatMontant(acte.total_debours)} F</td>
                            <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600;">${formatMontant(acte.total_ttc)} F</td>
                            <td style="padding: 8px 12px; text-align: center;">
                                <span class="status-badge ${statutClass}">${statutText}</span>
                            </td>
                            <td style="padding: 8px 12px; text-align: center;">
                                ${deleteBtn}
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

                // Mettre à jour les totaux
                document.getElementById('total-honoraires').textContent = formatMontant(data.totaux.total_honoraires);
                document.getElementById('total-debours').textContent = formatMontant(data.totaux.total_debours);
                document.getElementById('total-ttc').textContent = formatMontant(data.totaux.total_ttc);
                document.getElementById('total-non-factures').textContent = formatMontant(data.totaux.total_non_factures);
                totauxDiv.style.display = 'block';

                // Réinitialiser les icônes Lucide
                lucide.createIcons();
            } else {
                container.innerHTML = `
                    <p style="padding: 20px; color: var(--neutral-500); font-style: italic; text-align: center;">
                        Aucun acte réalisé pour ce dossier. Cliquez sur "+ Ajouter un acte" pour enregistrer les actes effectués.
                    </p>
                `;
                totauxDiv.style.display = 'none';
            }
        } catch (error) {
            console.error('Erreur chargement actes:', error);
            document.getElementById('actes-realises-container').innerHTML = `
                <p style="padding: 20px; color: var(--danger); text-align: center;">
                    Erreur lors du chargement des actes
                </p>
            `;
        }
    }

    // Formater un montant avec séparateurs de milliers
    function formatMontant(montant) {
        return new Intl.NumberFormat('fr-FR').format(Math.round(montant));
    }

    // Ouvrir le modal d'ajout d'acte
    function ouvrirModalAjoutActe() {
        document.getElementById('modal-ajout-acte').style.display = 'flex';
        document.getElementById('form-ajout-acte').reset();
        document.getElementById('acte-date').valueAsDate = new Date();
    }

    // Fermer le modal
    function fermerModalAjoutActe() {
        document.getElementById('modal-ajout-acte').style.display = 'none';
    }

    // Pré-remplir les champs quand un type d'acte est sélectionné
    document.getElementById('acte-type').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const honoraires = selectedOption.dataset.honoraires || 0;
            const feuillets = selectedOption.dataset.feuillets || 1;
            document.getElementById('acte-honoraires').value = honoraires;
            document.getElementById('acte-feuillets').value = feuillets;

            // Générer l'intitulé automatiquement
            const typeName = selectedOption.text.split('(')[0].trim();
            const today = new Date().toLocaleDateString('fr-FR');
            document.getElementById('acte-intitule').value = `${typeName} du ${today}`;

            // Recalculer le timbre si coché
            if (document.getElementById('calc-timbre').checked) {
                calculerTimbreAuto();
            }
        }
    });

    // Calculer le timbre automatiquement
    function calculerTimbreAuto() {
        if (document.getElementById('calc-timbre').checked) {
            const feuillets = parseInt(document.getElementById('acte-feuillets').value) || 1;
            document.getElementById('acte-timbre').value = feuillets * 1200;
        }
    }

    // Recalculer quand le nombre de feuillets change
    document.getElementById('acte-feuillets').addEventListener('change', function() {
        if (document.getElementById('calc-timbre').checked) {
            calculerTimbreAuto();
        }
    });

    // Ajouter le droit d'enregistrement
    function ajouterEnregistrement() {
        if (document.getElementById('add-enregistrement').checked) {
            document.getElementById('acte-enregistrement').value = 2500;
        } else {
            document.getElementById('acte-enregistrement').value = 0;
        }
    }

    // Sauvegarder un acte
    async function sauvegarderActeDossier(event) {
        event.preventDefault();

        const formData = {
            type_acte: document.getElementById('acte-type').value || null,
            intitule: document.getElementById('acte-intitule').value,
            date_acte: document.getElementById('acte-date').value,
            honoraires: parseInt(document.getElementById('acte-honoraires').value) || 0,
            feuillets: parseInt(document.getElementById('acte-feuillets').value) || 1,
            timbre: parseInt(document.getElementById('acte-timbre').value) || 0,
            enregistrement: parseInt(document.getElementById('acte-enregistrement').value) || 0,
            debours_divers: parseInt(document.getElementById('acte-debours').value) || 0
        };

        try {
            const response = await fetch(`/api/dossier/${DOSSIER_ID}/ajouter-acte/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                fermerModalAjoutActe();
                chargerActesDossier();
            } else {
                alert('Erreur: ' + (data.error || 'Impossible d\'ajouter l\'acte'));
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'enregistrement');
        }
    }

    // Supprimer un acte
    async function supprimerActeDossier(acteId) {
        if (!confirm('Êtes-vous sûr de vouloir supprimer cet acte ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/acte-dossier/${acteId}/supprimer/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                chargerActesDossier();
            } else {
                alert('Erreur: ' + (data.error || 'Impossible de supprimer l\'acte'));
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de la suppression');
        }
    }

    // Utilitaire pour récupérer le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    lucide.createIcons();
</script>

<style>
    /* Style pour le modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
        position: relative;
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
        width: 90%;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--neutral-200);
    }
    .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--neutral-500);
    }
    .modal-body {
        padding: 20px;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 20px;
        border-top: 1px solid var(--neutral-200);
    }

    /* Animation de chargement */
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}
