{% extends 'base.html' %}

{% block breadcrumb %}
<span class="breadcrumb-separator"></span>
<a href="{% url 'gestion:dossiers' %}" class="breadcrumb-item">Dossiers</a>
<span class="breadcrumb-separator"></span>
<span class="breadcrumb-current">{{ dossier.reference }}</span>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex justify-between items-center flex-wrap gap-4 mb-4">
    <div class="flex items-center gap-4">
        <a href="{% url 'gestion:dossiers' %}" class="btn btn-secondary btn-sm">
            <i data-lucide="arrow-left"></i> Retour
        </a>
        <div>
            <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">{{ dossier.reference }}</h2>
            <p style="color: var(--neutral-500);">{{ dossier.get_intitule }}</p>
        </div>
    </div>
    <div class="flex gap-2">
        <a href="{% url 'gestion:securiser_acte' dossier.pk %}" class="btn btn-secondary">
            <i data-lucide="qr-code"></i> Sécuriser
        </a>
        <a href="{% url 'gestion:modifier_dossier' dossier.pk %}" class="btn btn-primary">
            <i data-lucide="edit"></i> Modifier
        </a>
        <button class="btn btn-secondary" onclick="window.print()">
            <i data-lucide="printer"></i> Imprimer
        </button>
    </div>
</div>

<!-- Badges statut et phase -->
<div class="flex gap-2 mb-4">
    <span class="status-badge {{ dossier.statut }}">
        {% if dossier.statut == 'actif' %}
        <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i> Actif
        {% elif dossier.statut == 'urgent' %}
        <i data-lucide="alert-circle" style="width: 12px; height: 12px;"></i> Urgent
        {% elif dossier.statut == 'archive' %}
        <i data-lucide="archive" style="width: 12px; height: 12px;"></i> Archivé
        {% elif dossier.statut == 'cloture' %}
        <i data-lucide="lock" style="width: 12px; height: 12px;"></i> Clôturé
        {% endif %}
    </span>
    <span class="status-badge {% if dossier.is_contentieux %}contentieux{% else %}non-contentieux{% endif %}">
        {{ dossier.is_contentieux|yesno:"Contentieux,Non-contentieux" }}
    </span>
    <span class="status-badge {% if dossier.phase == 'force' %}urgent{% else %}actif{% endif %}">
        <i data-lucide="{% if dossier.phase == 'force' %}gavel{% else %}handshake{% endif %}" style="width: 12px; height: 12px;"></i>
        Phase {{ dossier.get_phase_display }}
    </span>
</div>

<!-- Statistiques financières -->
<div class="grid grid-cols-4 gap-4 mb-4">
    <div class="card" style="padding: 16px;">
        <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 4px;">Montant Total Dû</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">{{ stats.montant_total_du|floatformat:0 }} F</div>
    </div>
    <div class="card" style="padding: 16px;">
        <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 4px;">Total Encaissé</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">{{ stats.total_encaisse|floatformat:0 }} F</div>
    </div>
    <div class="card" style="padding: 16px;">
        <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 4px;">Solde Restant</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">{{ stats.solde_restant|floatformat:0 }} F</div>
    </div>
    <div class="card" style="padding: 16px;">
        <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 4px;">Taux Recouvrement</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">{{ stats.taux_recouvrement|floatformat:1 }}%</div>
    </div>
</div>

<div class="grid grid-cols-2 gap-4">
    <!-- Colonne gauche -->
    <div>
        <!-- Informations générales -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="info" style="width: 18px; height: 18px;"></i> Informations générales</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Référence</span>
                        <p style="font-weight: 600;">{{ dossier.reference }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Type</span>
                        <p style="font-weight: 500;">{{ dossier.get_type_dossier_display|default:"-" }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Date d'ouverture</span>
                        <p style="font-weight: 500;">{{ dossier.date_ouverture|date:"d/m/Y" }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Affecté à</span>
                        <p style="font-weight: 500;">{{ dossier.affecte_a.nom|default:"-" }}</p>
                    </div>
                    {% if dossier.creancier %}
                    <div class="col-span-2">
                        <span style="color: var(--neutral-500); font-size: 12px;">Créancier</span>
                        <p style="font-weight: 500;">{{ dossier.creancier.nom }}</p>
                    </div>
                    {% endif %}
                    {% if dossier.description %}
                    <div class="col-span-2">
                        <span style="color: var(--neutral-500); font-size: 12px;">Description</span>
                        <p style="font-weight: 500;">{{ dossier.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Montants détaillés -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="calculator" style="width: 18px; height: 18px;"></i> Montants détaillés</h3>
            </div>
            <div class="card-body">
                <table class="w-full">
                    <tbody>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Montant créance</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_creance|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Principal</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_principal|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Intérêts</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_interets|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Frais de procédure</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_frais|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Émoluments</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_emoluments|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--neutral-200);">
                            <td style="padding: 8px 0; color: var(--neutral-600);">Dépens</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 600;">{{ dossier.montant_depens|floatformat:0|default:"0" }} F</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; font-weight: 700;">TOTAL</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: 700; color: var(--primary);">{{ stats.montant_total_du|floatformat:0 }} F</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% if dossier.phase == 'force' and dossier.titre_executoire_type %}
        <!-- Titre exécutoire -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="file-check" style="width: 18px; height: 18px;"></i> Titre exécutoire</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Type</span>
                        <p style="font-weight: 500;">{{ dossier.titre_executoire_type }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Référence</span>
                        <p style="font-weight: 500;">{{ dossier.titre_executoire_reference|default:"-" }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Date</span>
                        <p style="font-weight: 500;">{{ dossier.titre_executoire_date|date:"d/m/Y"|default:"-" }}</p>
                    </div>
                    <div>
                        <span style="color: var(--neutral-500); font-size: 12px;">Juridiction</span>
                        <p style="font-weight: 500;">{{ dossier.titre_executoire_juridiction|default:"-" }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Colonne droite -->
    <div>
        <!-- Demandeurs -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="user" style="width: 18px; height: 18px;"></i> Demandeur(s) / Client(s)</h3>
            </div>
            <div class="card-body">
                {% for partie in demandeurs %}
                <div style="{% if not forloop.last %}border-bottom: 1px solid var(--neutral-200); margin-bottom: 12px; padding-bottom: 12px;{% endif %}">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: {% if partie.type_personne == 'physique' %}var(--info-light){% else %}var(--accent-light){% endif %}; color: {% if partie.type_personne == 'physique' %}white{% else %}var(--primary-dark){% endif %};">
                            {{ partie.type_personne|title }}
                        </span>
                        {% if partie.est_commercant or partie.nom_commercial or partie.enseigne %}
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: var(--success-light); color: var(--success-dark);">
                            Commerçant
                        </span>
                        {% endif %}
                    </div>
                    <p style="font-weight: 600; margin-bottom: 4px;">{{ partie.get_nom_complet }}</p>
                    {% if partie.nom_commercial %}
                    <p style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                        <i data-lucide="store" style="width: 12px; height: 12px; display: inline;"></i>
                        Nom commercial : <strong>{{ partie.nom_commercial }}</strong>
                    </p>
                    {% endif %}
                    {% if partie.enseigne %}
                    <p style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                        <i data-lucide="building-2" style="width: 12px; height: 12px; display: inline;"></i>
                        Enseigne : <strong>{{ partie.enseigne }}</strong>
                    </p>
                    {% endif %}
                    {% if partie.activite_commerciale %}
                    <p style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">
                        <i data-lucide="briefcase" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.activite_commerciale }}
                    </p>
                    {% endif %}
                    {% if partie.domicile or partie.siege_social %}
                    <p style="font-size: 13px; color: var(--neutral-600);">
                        <i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.domicile|default:partie.siege_social }}
                    </p>
                    {% endif %}
                    {% if partie.telephone %}
                    <p style="font-size: 13px; color: var(--neutral-600);">
                        <i data-lucide="phone" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.telephone }}
                    </p>
                    {% endif %}
                </div>
                {% empty %}
                <p style="color: var(--neutral-500); font-style: italic;">Aucun demandeur enregistré</p>
                {% endfor %}
            </div>
        </div>

        <!-- Défendeurs -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="users" style="width: 18px; height: 18px;"></i> Défendeur(s) / Débiteur(s)</h3>
            </div>
            <div class="card-body">
                {% for partie in defendeurs %}
                <div style="{% if not forloop.last %}border-bottom: 1px solid var(--neutral-200); margin-bottom: 12px; padding-bottom: 12px;{% endif %}">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: {% if partie.type_personne == 'physique' %}var(--warning-light){% else %}var(--danger-light){% endif %}; color: var(--primary-dark);">
                            {{ partie.type_personne|title }}
                        </span>
                        {% if partie.est_commercant or partie.nom_commercial or partie.enseigne %}
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: var(--success-light); color: var(--success-dark);">
                            Commerçant
                        </span>
                        {% endif %}
                    </div>
                    <p style="font-weight: 600; margin-bottom: 4px;">{{ partie.get_nom_complet }}</p>
                    {% if partie.nom_commercial %}
                    <p style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                        <i data-lucide="store" style="width: 12px; height: 12px; display: inline;"></i>
                        Nom commercial : <strong>{{ partie.nom_commercial }}</strong>
                    </p>
                    {% endif %}
                    {% if partie.enseigne %}
                    <p style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                        <i data-lucide="building-2" style="width: 12px; height: 12px; display: inline;"></i>
                        Enseigne : <strong>{{ partie.enseigne }}</strong>
                    </p>
                    {% endif %}
                    {% if partie.activite_commerciale %}
                    <p style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">
                        <i data-lucide="briefcase" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.activite_commerciale }}
                    </p>
                    {% endif %}
                    {% if partie.domicile or partie.siege_social %}
                    <p style="font-size: 13px; color: var(--neutral-600);">
                        <i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.domicile|default:partie.siege_social }}
                    </p>
                    {% endif %}
                    {% if partie.telephone %}
                    <p style="font-size: 13px; color: var(--neutral-600);">
                        <i data-lucide="phone" style="width: 12px; height: 12px; display: inline;"></i>
                        {{ partie.telephone }}
                    </p>
                    {% endif %}
                </div>
                {% empty %}
                <p style="color: var(--neutral-500); font-style: italic;">Aucun défendeur enregistré</p>
                {% endfor %}
            </div>
        </div>

        <!-- Encaissements récents -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="banknote" style="width: 18px; height: 18px;"></i> Encaissements récents</h3>
            </div>
            <div class="card-body" style="padding: 0;">
                {% if encaissements %}
                <table class="w-full">
                    <thead>
                        <tr style="background: var(--neutral-50);">
                            <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                            <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Référence</th>
                            <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Montant</th>
                            <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enc in encaissements %}
                        <tr style="border-bottom: 1px solid var(--neutral-100);">
                            <td style="padding: 8px 12px; font-size: 13px;">{{ enc.date_encaissement|date:"d/m/Y" }}</td>
                            <td style="padding: 8px 12px; font-size: 13px;">{{ enc.reference }}</td>
                            <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600;">{{ enc.montant|floatformat:0 }} F</td>
                            <td style="padding: 8px 12px; text-align: center;">
                                <span class="status-badge {{ enc.statut }}">{{ enc.get_statut_display }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="padding: 16px; color: var(--neutral-500); font-style: italic;">Aucun encaissement</p>
                {% endif %}
            </div>
        </div>

        <!-- Factures -->
        <div class="card mb-4">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title"><i data-lucide="file-text" style="width: 18px; height: 18px;"></i> Factures</h3>
                <span style="background: var(--info-light); color: var(--info); padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">{{ factures|length }}</span>
            </div>
            <div class="card-body" style="padding: 0;">
                {% if factures %}
                <table class="w-full">
                    <thead>
                        <tr style="background: var(--neutral-50);">
                            <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Numéro</th>
                            <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                            <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Montant TTC</th>
                            <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fac in factures %}
                        <tr style="border-bottom: 1px solid var(--neutral-100);">
                            <td style="padding: 8px 12px; font-size: 13px; color: var(--primary); font-weight: 500;">
                                {{ fac.numero }}
                            </td>
                            <td style="padding: 8px 12px; font-size: 13px;">{{ fac.date_emission|date:"d/m/Y" }}</td>
                            <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600;">{{ fac.montant_ttc|floatformat:0 }} F</td>
                            <td style="padding: 8px 12px; text-align: center;">
                                <span class="status-badge {% if fac.statut == 'payee' %}actif{% elif fac.statut == 'attente' %}urgent{% else %}archive{% endif %}">{{ fac.get_statut_display }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="padding: 16px; color: var(--neutral-500); font-style: italic;">Aucune facture</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Section pleine largeur : Tâches et Mouvements -->
<div class="grid grid-cols-2 gap-4 mb-4">
    <!-- Tâches liées -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title"><i data-lucide="check-square" style="width: 18px; height: 18px;"></i> Tâches liées</h3>
            <span style="background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">{{ taches_dossier|length }}</span>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if taches_dossier %}
            <table class="w-full">
                <thead>
                    <tr style="background: var(--neutral-50);">
                        <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Titre</th>
                        <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Échéance</th>
                        <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Priorité</th>
                        <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Statut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tache in taches_dossier %}
                    <tr style="border-bottom: 1px solid var(--neutral-100);">
                        <td style="padding: 8px 12px; font-size: 13px; color: var(--primary); font-weight: 500;">
                            {{ tache.titre|truncatechars:30 }}
                        </td>
                        <td style="padding: 8px 12px; font-size: 13px;">{{ tache.date_echeance|date:"d/m/Y" }}</td>
                        <td style="padding: 8px 12px; text-align: center;">
                            <span class="status-badge {% if tache.priorite == 'haute' or tache.priorite == 'urgente' %}urgent{% elif tache.priorite == 'normale' %}actif{% else %}archive{% endif %}">
                                {{ tache.get_priorite_display|default:tache.priorite }}
                            </span>
                        </td>
                        <td style="padding: 8px 12px; text-align: center;">
                            <span class="status-badge {% if tache.statut == 'terminee' %}actif{% elif tache.statut == 'en_cours' %}urgent{% else %}archive{% endif %}">
                                {{ tache.get_statut_display|default:tache.statut }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="padding: 16px; color: var(--neutral-500); font-style: italic;">Aucune tâche liée</p>
            {% endif %}
        </div>
    </div>

    <!-- Mouvements de trésorerie -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title"><i data-lucide="wallet" style="width: 18px; height: 18px;"></i> Mouvements de trésorerie</h3>
            <span style="background: var(--success-light); color: var(--success); padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">{{ mouvements_dossier|length }}</span>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if mouvements_dossier %}
            <table class="w-full">
                <thead>
                    <tr style="background: var(--neutral-50);">
                        <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                        <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Libellé</th>
                        <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Type</th>
                        <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mvt in mouvements_dossier %}
                    <tr style="border-bottom: 1px solid var(--neutral-100);">
                        <td style="padding: 8px 12px; font-size: 13px;">{{ mvt.date_mouvement|date:"d/m/Y" }}</td>
                        <td style="padding: 8px 12px; font-size: 13px;">{{ mvt.libelle|truncatechars:25 }}</td>
                        <td style="padding: 8px 12px; text-align: center;">
                            <span class="status-badge {% if mvt.type_mouvement == 'entree' %}actif{% else %}urgent{% endif %}">
                                {% if mvt.type_mouvement == 'entree' %}<i data-lucide="arrow-down-circle" style="width: 12px; height: 12px;"></i>{% else %}<i data-lucide="arrow-up-circle" style="width: 12px; height: 12px;"></i>{% endif %}
                                {{ mvt.get_type_mouvement_display }}
                            </span>
                        </td>
                        <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600; color: {% if mvt.type_mouvement == 'entree' %}var(--success){% else %}var(--danger){% endif %};">
                            {% if mvt.type_mouvement == 'entree' %}+{% else %}-{% endif %}{{ mvt.montant|floatformat:0 }} F
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="padding: 16px; color: var(--neutral-500); font-style: italic;">Aucun mouvement</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Section Actes Sécurisés -->
<div class="card mb-4">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title"><i data-lucide="qr-code" style="width: 18px; height: 18px;"></i> Actes Sécurisés</h3>
        <a href="{% url 'gestion:securiser_acte' dossier.id %}" class="btn btn-primary btn-sm">
            + Sécuriser un acte
        </a>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if dossier.actes_securises.exists %}
        <table class="w-full">
            <thead>
                <tr style="background: var(--neutral-50);">
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Code</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Type</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Titre</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                    <th style="padding: 8px 12px; text-align: center; font-size: 12px;">Vérif.</th>
                    <th style="padding: 8px 12px; text-align: center; font-size: 12px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for acte in dossier.actes_securises.all|slice:":5" %}
                <tr style="border-bottom: 1px solid var(--neutral-100);">
                    <td style="padding: 8px 12px; font-size: 13px;">
                        <code style="font-size: 11px; background: var(--neutral-100); padding: 2px 6px; border-radius: 4px;">{{ acte.code_verification }}</code>
                    </td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ acte.get_type_acte_display }}</td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ acte.titre_acte|truncatechars:25 }}</td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ acte.date_acte|date:"d/m/Y" }}</td>
                    <td style="padding: 8px 12px; text-align: center;">
                        <span style="background: var(--neutral-100); padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                            {{ acte.nombre_verifications }}
                        </span>
                    </td>
                    <td style="padding: 8px 12px; text-align: center;">
                        <a href="{% url 'gestion:acte_securise_detail' acte.id %}" class="btn btn-sm btn-secondary" style="padding: 4px 8px; font-size: 11px;">
                            QR
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if dossier.actes_securises.count > 5 %}
        <div style="text-align: center; padding: 12px; border-top: 1px solid var(--neutral-100);">
            <a href="{% url 'gestion:liste_actes_securises' dossier.id %}" style="color: var(--primary); font-size: 13px;">
                Voir tous les actes sécurisés ({{ dossier.actes_securises.count }})
            </a>
        </div>
        {% endif %}
        {% else %}
        <p style="padding: 20px; color: var(--neutral-500); font-style: italic; text-align: center;">
            Aucun acte sécurisé pour ce dossier
        </p>
        {% endif %}
    </div>
</div>

<!-- Section Actes et Débours du Dossier -->
<div class="grid grid-cols-2 gap-4 mb-4">
    <!-- Actes du dossier -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title"><i data-lucide="file-text" style="width: 18px; height: 18px;"></i> Actes du dossier</h3>
            <button class="btn btn-primary btn-sm" onclick="ouvrirModalActe()">
                <i data-lucide="plus"></i> Ajouter
            </button>
        </div>
        <div class="card-body" style="padding: 0;">
            <div id="tableActesDossier">
                <p style="padding: 16px; color: var(--neutral-500); font-style: italic; text-align: center;">Chargement...</p>
            </div>
        </div>
        <div class="card-footer" id="totauxActes" style="display: none; background: var(--neutral-50); padding: 12px 16px;">
            <div class="grid grid-cols-4 gap-2" style="font-size: 12px;">
                <div><span style="color: var(--neutral-500);">Honoraires:</span> <strong id="totalHonoraires">0</strong> F</div>
                <div><span style="color: var(--neutral-500);">Timbre:</span> <strong id="totalTimbre">0</strong> F</div>
                <div><span style="color: var(--neutral-500);">Enreg.:</span> <strong id="totalEnregistrement">0</strong> F</div>
                <div style="color: var(--primary);"><span>Total:</span> <strong id="totalActes">0</strong> F</div>
            </div>
        </div>
    </div>

    <!-- Débours du dossier -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title"><i data-lucide="receipt" style="width: 18px; height: 18px;"></i> Débours du dossier</h3>
            <button class="btn btn-primary btn-sm" onclick="ouvrirModalDebours()">
                <i data-lucide="plus"></i> Ajouter
            </button>
        </div>
        <div class="card-body" style="padding: 0;">
            <div id="tableDeboursDossier">
                <p style="padding: 16px; color: var(--neutral-500); font-style: italic; text-align: center;">Chargement...</p>
            </div>
        </div>
        <div class="card-footer" id="totauxDebours" style="display: none; background: var(--neutral-50); padding: 12px 16px; text-align: right;">
            <span style="font-size: 13px; color: var(--primary); font-weight: 600;">Total débours: <strong id="totalDebours">0</strong> F</span>
        </div>
    </div>
</div>

<!-- Modal Ajouter Acte -->
<div id="modalActe" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Ajouter un acte</h3>
            <button onclick="fermerModalActe()" style="background: none; border: none; cursor: pointer;">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formActe">
                <div class="form-group mb-3">
                    <label>Date de l'acte *</label>
                    <input type="date" id="acteDate" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label>Type d'acte *</label>
                    <input type="text" id="acteType" class="form-control" placeholder="Ex: Signification, Commandement..." required>
                </div>
                <div class="form-group mb-3">
                    <label>Description</label>
                    <textarea id="acteDescription" class="form-control" rows="2" placeholder="Description de l'acte..."></textarea>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="form-group">
                        <label>Honoraires</label>
                        <input type="number" id="acteHonoraires" class="form-control" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Timbre</label>
                        <input type="number" id="acteTimbre" class="form-control" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Enregistrement</label>
                        <input type="number" id="acteEnregistrement" class="form-control" value="0" min="0">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="fermerModalActe()">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="sauvegarderActe()">Enregistrer</button>
        </div>
    </div>
</div>

<!-- Modal Ajouter Débours -->
<div id="modalDebours" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h3>Ajouter un débours</h3>
            <button onclick="fermerModalDebours()" style="background: none; border: none; cursor: pointer;">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formDebours">
                <div class="form-group mb-3">
                    <label>Date du débours *</label>
                    <input type="date" id="deboursDate" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label>Désignation *</label>
                    <input type="text" id="deboursDesignation" class="form-control" placeholder="Ex: Frais de transport, Droit de timbre..." required>
                </div>
                <div class="form-group mb-3">
                    <label>Montant *</label>
                    <input type="number" id="deboursMontant" class="form-control" value="0" min="0" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="fermerModalDebours()">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="sauvegarderDebours()">Enregistrer</button>
        </div>
    </div>
</div>

<!-- Historique des basculements (si phase forcée) -->
{% if dossier.phase == 'force' and basculements %}
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title"><i data-lucide="history" style="width: 18px; height: 18px;"></i> Historique des basculements</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <table class="w-full">
            <thead>
                <tr style="background: var(--neutral-50);">
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Type</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Motif</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Par</th>
                </tr>
            </thead>
            <tbody>
                {% for basc in basculements %}
                <tr style="border-bottom: 1px solid var(--neutral-100);">
                    <td style="padding: 8px 12px; font-size: 13px;">{{ basc.date_basculement|date:"d/m/Y H:i" }}</td>
                    <td style="padding: 8px 12px; font-size: 13px;">
                        <span class="status-badge urgent">
                            <i data-lucide="zap" style="width: 12px; height: 12px;"></i> Phase forcée
                        </span>
                    </td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ basc.motif|default:"-" }}</td>
                    <td style="padding: 8px 12px; font-size: 13px;">{{ basc.effectue_par|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Métadonnées -->
<div class="card">
    <div class="card-body" style="padding: 12px 16px; background: var(--neutral-50);">
        <div class="flex justify-between" style="font-size: 12px; color: var(--neutral-500);">
            <span>Créé le {{ dossier.date_creation|date:"d/m/Y à H:i" }}{% if dossier.cree_par %} par {{ dossier.cree_par }}{% endif %}</span>
            <span>Dernière modification: {{ dossier.date_modification|date:"d/m/Y à H:i" }}</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    lucide.createIcons();

    const dossierId = {{ dossier.id }};
    const csrfToken = '{{ csrf_token }}';

    // =============================================
    // GESTION DES ACTES
    // =============================================

    function chargerActesDossier() {
        fetch(`/gestion/api/dossiers/${dossierId}/actes/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    afficherActes(data.actes, data.totaux);
                }
            })
            .catch(err => {
                document.getElementById('tableActesDossier').innerHTML =
                    '<p style="padding: 16px; color: var(--danger); text-align: center;">Erreur de chargement</p>';
            });
    }

    function afficherActes(actes, totaux) {
        const container = document.getElementById('tableActesDossier');
        const footerTotaux = document.getElementById('totauxActes');

        if (actes.length === 0) {
            container.innerHTML = '<p style="padding: 16px; color: var(--neutral-500); font-style: italic; text-align: center;">Aucun acte enregistré</p>';
            footerTotaux.style.display = 'none';
            return;
        }

        let html = `<table class="w-full">
            <thead>
                <tr style="background: var(--neutral-50);">
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Type</th>
                    <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Honoraires</th>
                    <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Timbre</th>
                    <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Enreg.</th>
                    <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Total</th>
                    <th style="padding: 8px 12px; text-align: center; font-size: 12px;"></th>
                </tr>
            </thead>
            <tbody>`;

        actes.forEach(acte => {
            html += `<tr style="border-bottom: 1px solid var(--neutral-100);">
                <td style="padding: 8px 12px; font-size: 13px;">${acte.date_acte_display}</td>
                <td style="padding: 8px 12px; font-size: 13px;" title="${acte.description || ''}">${acte.type_acte}</td>
                <td style="padding: 8px 12px; font-size: 13px; text-align: right;">${formatNumber(acte.honoraires)}</td>
                <td style="padding: 8px 12px; font-size: 13px; text-align: right;">${formatNumber(acte.timbre)}</td>
                <td style="padding: 8px 12px; font-size: 13px; text-align: right;">${formatNumber(acte.enregistrement)}</td>
                <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600;">${formatNumber(acte.montant_total)}</td>
                <td style="padding: 8px 12px; text-align: center;">
                    <button onclick="supprimerActe(${acte.id})" class="btn btn-sm" style="padding: 4px 8px; background: var(--danger-light); color: var(--danger);">
                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                    </button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;

        // Mise à jour des totaux
        document.getElementById('totalHonoraires').textContent = formatNumber(totaux.honoraires);
        document.getElementById('totalTimbre').textContent = formatNumber(totaux.timbre);
        document.getElementById('totalEnregistrement').textContent = formatNumber(totaux.enregistrement);
        document.getElementById('totalActes').textContent = formatNumber(totaux.total);
        footerTotaux.style.display = 'block';

        lucide.createIcons();
    }

    function ouvrirModalActe() {
        document.getElementById('formActe').reset();
        document.getElementById('acteDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('modalActe').style.display = 'flex';
        lucide.createIcons();
    }

    function fermerModalActe() {
        document.getElementById('modalActe').style.display = 'none';
    }

    function sauvegarderActe() {
        const data = {
            date_acte: document.getElementById('acteDate').value,
            type_acte: document.getElementById('acteType').value,
            description: document.getElementById('acteDescription').value,
            honoraires: parseInt(document.getElementById('acteHonoraires').value) || 0,
            timbre: parseInt(document.getElementById('acteTimbre').value) || 0,
            enregistrement: parseInt(document.getElementById('acteEnregistrement').value) || 0
        };

        if (!data.date_acte || !data.type_acte) {
            alert('Veuillez remplir les champs obligatoires');
            return;
        }

        fetch(`/gestion/api/dossiers/${dossierId}/actes/ajouter/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(response => {
            if (response.success) {
                fermerModalActe();
                chargerActesDossier();
            } else {
                alert('Erreur: ' + (response.error || 'Erreur inconnue'));
            }
        })
        .catch(err => alert('Erreur de connexion'));
    }

    function supprimerActe(acteId) {
        if (!confirm('Supprimer cet acte ?')) return;

        fetch(`/gestion/api/actes-dossier/${acteId}/supprimer/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(r => r.json())
        .then(response => {
            if (response.success) {
                chargerActesDossier();
            } else {
                alert('Erreur: ' + (response.error || 'Erreur inconnue'));
            }
        })
        .catch(err => alert('Erreur de connexion'));
    }

    // =============================================
    // GESTION DES DÉBOURS
    // =============================================

    function chargerDeboursDossier() {
        fetch(`/gestion/api/dossiers/${dossierId}/debours/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    afficherDebours(data.debours, data.total);
                }
            })
            .catch(err => {
                document.getElementById('tableDeboursDossier').innerHTML =
                    '<p style="padding: 16px; color: var(--danger); text-align: center;">Erreur de chargement</p>';
            });
    }

    function afficherDebours(debours, total) {
        const container = document.getElementById('tableDeboursDossier');
        const footerTotaux = document.getElementById('totauxDebours');

        if (debours.length === 0) {
            container.innerHTML = '<p style="padding: 16px; color: var(--neutral-500); font-style: italic; text-align: center;">Aucun débours enregistré</p>';
            footerTotaux.style.display = 'none';
            return;
        }

        let html = `<table class="w-full">
            <thead>
                <tr style="background: var(--neutral-50);">
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Date</th>
                    <th style="padding: 8px 12px; text-align: left; font-size: 12px;">Désignation</th>
                    <th style="padding: 8px 12px; text-align: right; font-size: 12px;">Montant</th>
                    <th style="padding: 8px 12px; text-align: center; font-size: 12px;"></th>
                </tr>
            </thead>
            <tbody>`;

        debours.forEach(d => {
            html += `<tr style="border-bottom: 1px solid var(--neutral-100);">
                <td style="padding: 8px 12px; font-size: 13px;">${d.date_debours_display}</td>
                <td style="padding: 8px 12px; font-size: 13px;">${d.designation}</td>
                <td style="padding: 8px 12px; font-size: 13px; text-align: right; font-weight: 600;">${formatNumber(d.montant)} F</td>
                <td style="padding: 8px 12px; text-align: center;">
                    <button onclick="supprimerDebours(${d.id})" class="btn btn-sm" style="padding: 4px 8px; background: var(--danger-light); color: var(--danger);">
                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                    </button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;

        document.getElementById('totalDebours').textContent = formatNumber(total);
        footerTotaux.style.display = 'block';

        lucide.createIcons();
    }

    function ouvrirModalDebours() {
        document.getElementById('formDebours').reset();
        document.getElementById('deboursDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('modalDebours').style.display = 'flex';
        lucide.createIcons();
    }

    function fermerModalDebours() {
        document.getElementById('modalDebours').style.display = 'none';
    }

    function sauvegarderDebours() {
        const data = {
            date_debours: document.getElementById('deboursDate').value,
            designation: document.getElementById('deboursDesignation').value,
            montant: parseInt(document.getElementById('deboursMontant').value) || 0
        };

        if (!data.date_debours || !data.designation || data.montant <= 0) {
            alert('Veuillez remplir tous les champs obligatoires');
            return;
        }

        fetch(`/gestion/api/dossiers/${dossierId}/debours/ajouter/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(response => {
            if (response.success) {
                fermerModalDebours();
                chargerDeboursDossier();
            } else {
                alert('Erreur: ' + (response.error || 'Erreur inconnue'));
            }
        })
        .catch(err => alert('Erreur de connexion'));
    }

    function supprimerDebours(deboursId) {
        if (!confirm('Supprimer ce débours ?')) return;

        fetch(`/gestion/api/debours-dossier/${deboursId}/supprimer/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(r => r.json())
        .then(response => {
            if (response.success) {
                chargerDeboursDossier();
            } else {
                alert('Erreur: ' + (response.error || 'Erreur inconnue'));
            }
        })
        .catch(err => alert('Erreur de connexion'));
    }

    // =============================================
    // UTILITAIRES
    // =============================================

    function formatNumber(n) {
        return Math.round(n).toLocaleString('fr-FR');
    }

    // Charger les données au démarrage
    document.addEventListener('DOMContentLoaded', function() {
        chargerActesDossier();
        chargerDeboursDossier();
    });
</script>
{% endblock %}
