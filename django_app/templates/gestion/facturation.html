{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Header with tabs and button -->
<div class="flex justify-between items-center flex-wrap gap-4 mb-4">
    <div class="tabs" style="margin-bottom: 0; border-bottom: none;">
        <a href="?tab=liste" class="tab {% if current_tab == 'liste' %}active{% endif %}">
            Liste des factures
        </a>
        <a href="{% url 'gestion:memoires' %}" class="tab">
            Memoires
        </a>
        <a href="?tab=mecef" class="tab {% if current_tab == 'mecef' %}active{% endif %}">
            MECeF
        </a>
    </div>
    <div class="flex gap-2">
        {% if current_tab == 'liste' %}
        <button class="btn btn-secondary" onclick="exporterFactures()">
            <i data-lucide="download"></i> Exporter
        </button>
        <button class="btn btn-primary" onclick="ouvrirModalFacture()">
            <i data-lucide="plus"></i> Nouvelle facture
        </button>
        {% endif %}
    </div>
</div>

{% if current_tab == 'mecef' %}
<!-- Contenu MECeF -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title"><i data-lucide="shield-check"></i> Factures Normalisees MECeF</h3>
        <div class="flex gap-2">
            <span class="status-badge active">{{ factures_normalisees|length }} normalisee{{ factures_normalisees|length|pluralize }}</span>
        </div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>N Facture</th>
                    <th>Client</th>
                    <th>Total TTC</th>
                    <th>N MECeF</th>
                    <th>NIM</th>
                    <th>Date normalisation</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for facture in factures %}
                {% if facture.mecef_numero %}
                <tr>
                    <td style="font-weight: 600; color: var(--primary);">{{ facture.numero }}</td>
                    <td>{{ facture.client }}</td>
                    <td style="font-weight: 600;">{{ facture.total|floatformat:0 }} F</td>
                    <td><span class="status-badge active">{{ facture.mecef_numero }}</span></td>
                    <td>{{ facture.nim }}</td>
                    <td>{{ facture.date_mecef }}</td>
                    <td>
                        <div class="flex gap-1">
                            <button class="icon-btn" title="Voir" onclick="voirFacture('{{ facture.id }}')">
                                <i data-lucide="eye"></i>
                            </button>
                            <button class="icon-btn" title="Imprimer" onclick="imprimerFacture('{{ facture.id }}')">
                                <i data-lucide="printer"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
                {% if not nb_normalisees or nb_normalisees == 0 %}
                <tr>
                    <td colspan="7" class="text-center" style="padding: 40px; color: var(--neutral-500);">
                        Aucune facture normalisee
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Info MECeF -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><i data-lucide="info"></i> A propos du MECeF</h3>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">
            Le <strong>MECeF</strong> (Machine Electronique Certifiee de Facturation) est le systeme de normalisation
            des factures mis en place par la Direction Generale des Impots du Benin.
        </p>
        <div class="grid grid-cols-3 gap-4">
            <div class="stat-card" style="padding: 16px;">
                <div style="color: var(--primary); font-weight: 600; font-size: 1.2rem;">{{ nb_normalisees|default:0 }}</div>
                <div style="color: var(--neutral-500); font-size: 0.85rem;">Factures normalisees</div>
            </div>
            <div class="stat-card" style="padding: 16px;">
                <div style="color: var(--warning); font-weight: 600; font-size: 1.2rem;">{{ nb_non_normalisees|default:0 }}</div>
                <div style="color: var(--neutral-500); font-size: 0.85rem;">En attente de normalisation</div>
            </div>
            <div class="stat-card" style="padding: 16px;">
                <div style="color: var(--success); font-weight: 600; font-size: 1.2rem;">18%</div>
                <div style="color: var(--neutral-500); font-size: 0.85rem;">Taux TVA applique</div>
            </div>
        </div>
        <div class="alert alert-info mt-4" style="background: var(--primary-light); border: 1px solid var(--primary); border-radius: 8px; padding: 12px;">
            <strong>Note:</strong> La normalisation MECeF est actuellement en mode simulation.
            Pour une integration complete avec l'API DGI Benin, contactez votre administrateur.
        </div>
    </div>
</div>

{% else %}
<!-- Contenu Liste des factures (onglet par defaut) -->

<!-- Factures Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Factures</h3>
        <div class="flex gap-2">
            <select class="form-select" style="width: auto; padding: 6px 10px;" id="filtreStatut" onchange="filtrerFactures()">
                <option value="">Tous les statuts</option>
                <option value="brouillon">Brouillon</option>
                <option value="attente">En attente</option>
                <option value="payee">Payee</option>
                <option value="annulee">Annulee</option>
            </select>
            <input type="text" class="form-input" placeholder="Rechercher..." id="rechercheFacture" style="width: 200px; padding: 6px 10px;" oninput="filtrerFactures()">
        </div>
    </div>
    <div class="table-container">
        <table id="tableFactures">
            <thead>
                <tr>
                    <th>N Facture</th>
                    <th>Client</th>
                    <th>Montant HT</th>
                    <th>TVA (18%)</th>
                    <th>Total TTC</th>
                    <th>Date</th>
                    <th>Statut</th>
                    <th>MECeF</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="factureListe">
                {% for facture in factures %}
                <tr data-id="{{ facture.id }}" data-client="{{ facture.client }}" data-statut="{{ facture.statut }}">
                    <td style="font-weight: 600; color: var(--primary);">{{ facture.numero }}</td>
                    <td>{{ facture.client }}</td>
                    <td>{{ facture.montant_ht|floatformat:0 }} F</td>
                    <td>{{ facture.tva|floatformat:0 }} F</td>
                    <td style="font-weight: 600;">{{ facture.total|floatformat:0 }} F</td>
                    <td>{{ facture.date }}</td>
                    <td>
                        <span class="status-badge {{ facture.statut }}">
                            {% if facture.statut == 'payee' %}Payee
                            {% elif facture.statut == 'attente' %}En attente
                            {% elif facture.statut == 'brouillon' %}Brouillon
                            {% else %}Annulee{% endif %}
                        </span>
                    </td>
                    <td>
                        {% if facture.mecef_numero %}
                        <span class="status-badge active" style="font-size: 10px;">
                            <i data-lucide="check" style="width: 12px; height: 12px;"></i>
                            {{ facture.mecef_numero }}
                        </span>
                        {% else %}
                        <button class="btn btn-sm btn-secondary" onclick="normaliserMECeF('{{ facture.id }}')">
                            Normaliser
                        </button>
                        {% endif %}
                    </td>
                    <td>
                        <div class="flex gap-1">
                            <button class="icon-btn" title="Voir" onclick="voirFacture('{{ facture.id }}')">
                                <i data-lucide="eye"></i>
                            </button>
                            <button class="icon-btn" title="Modifier" onclick="modifierFacture('{{ facture.id }}')">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="icon-btn" title="Imprimer" onclick="imprimerFacture('{{ facture.id }}')">
                                <i data-lucide="printer"></i>
                            </button>
                            <button class="icon-btn" title="Supprimer" onclick="supprimerFacture('{{ facture.id }}')" style="color: var(--danger);">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr id="emptyRow">
                    <td colspan="9" class="text-center" style="padding: 40px; color: var(--neutral-500);">
                        Aucune facture trouvee
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Totaux -->
<div class="grid grid-cols-4 gap-4 mt-4">
    <div class="card stat-card">
        <div class="stat-content">
            <div class="stat-icon info">
                <i data-lucide="file-text"></i>
            </div>
            <div>
                <div class="stat-label">Total Factures</div>
                <div class="stat-value" id="totalFactures">{{ factures|length }}</div>
            </div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-content">
            <div class="stat-icon accent">
                <i data-lucide="banknote"></i>
            </div>
            <div>
                <div class="stat-label">Total HT</div>
                <div class="stat-value" id="totalHT">{{ total_ht|floatformat:0|default:"0" }} F</div>
            </div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-content">
            <div class="stat-icon success">
                <i data-lucide="receipt"></i>
            </div>
            <div>
                <div class="stat-label">Total TTC</div>
                <div class="stat-value" id="totalTTC">{{ total_ttc|floatformat:0|default:"0" }} F</div>
            </div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-content">
            <div class="stat-icon danger">
                <i data-lucide="clock"></i>
            </div>
            <div>
                <div class="stat-label">En attente</div>
                <div class="stat-value danger" id="enAttente">{{ nb_attente|default:"0" }}</div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block modal %}
<!-- Modal Nouvelle Facture -->
<div class="modal large" id="modalFacture" onclick="event.stopPropagation()">
    <div class="modal-header">
        <h3 class="modal-title" id="modalFactureTitle">Nouvelle facture</h3>
        <button class="modal-close" onclick="fermerModalFacture()">
            <i data-lucide="x"></i>
        </button>
    </div>
    <div class="modal-body">
        <form id="formFacture" onsubmit="sauvegarderFacture(event)">
            <input type="hidden" id="factureId" name="id">

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Numero de facture</label>
                    <input class="form-input" type="text" id="factureNumero" name="numero" readonly style="background: var(--neutral-100);">
                </div>
                <div class="form-group">
                    <label class="form-label">Date d'emission</label>
                    <input class="form-input" type="date" id="factureDate" name="date_emission" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Date d'echeance</label>
                    <input class="form-input" type="date" id="factureEcheance" name="date_echeance">
                </div>
                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="factureStatut" name="statut">
                        <option value="brouillon">Brouillon</option>
                        <option value="attente">En attente</option>
                        <option value="payee">Payee</option>
                        <option value="annulee">Annulee</option>
                    </select>
                </div>
            </div>

            <div class="form-section-title">Client</div>
            <div class="form-grid">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label">Nom du client</label>
                    <input class="form-input" type="text" id="factureClient" name="client" required placeholder="Ex: SODECO SA">
                </div>
                <div class="form-group">
                    <label class="form-label">IFU (optionnel)</label>
                    <input class="form-input" type="text" id="factureIFU" name="ifu" placeholder="Ex: 3201900001234">
                </div>
                <div class="form-group">
                    <label class="form-label">Dossier lie (optionnel)</label>
                    <select class="form-select" id="factureDossier" name="dossier">
                        <option value="">-- Aucun --</option>
                        {% for dossier in dossiers %}
                        <option value="{{ dossier.id }}">{{ dossier.reference }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-section-title">Lignes de facture</div>
            <div id="lignesFacture">
                <!-- Les lignes seront ajoutées dynamiquement ici -->
            </div>
            <div class="flex gap-2 mt-2">
                <button type="button" class="btn btn-secondary" onclick="ajouterLigneActe()">
                    <i data-lucide="plus"></i> Ajouter un acte
                </button>
                <button type="button" class="btn btn-accent" onclick="ajouterLigneDebours()" style="background: #fef3c7; color: #92400e; border-color: #f59e0b;">
                    <i data-lucide="plus"></i> Ajouter un debours
                </button>
            </div>

            <div class="form-section-title">Totaux</div>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="form-group">
                    <label class="form-label">Total HT</label>
                    <input class="form-input" type="text" id="factureMontantHT" readonly style="background: var(--neutral-100); font-weight: bold;">
                </div>
                <div class="form-group">
                    <label class="form-label">TVA (18%)</label>
                    <input class="form-input" type="text" id="factureTVA" readonly style="background: var(--neutral-100);">
                </div>
                <div class="form-group">
                    <label class="form-label">Total TTC</label>
                    <input class="form-input" type="text" id="factureTTC" readonly style="background: var(--primary); color: white; font-weight: bold;">
                </div>
            </div>

            <div class="form-section-title">Observations</div>
            <div class="form-group">
                <textarea class="form-input" id="factureObservations" name="observations" rows="3" placeholder="Notes ou observations..."></textarea>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fermerModalFacture()">Annuler</button>
        <div class="flex gap-2">
            <button class="btn btn-accent" onclick="sauvegarderFacture(event, true)">
                <i data-lucide="save"></i> Enregistrer brouillon
            </button>
            <button class="btn btn-primary" onclick="sauvegarderFacture(event)">
                <i data-lucide="check"></i> Valider la facture
            </button>
        </div>
    </div>
</div>

<!-- Modal Voir Facture -->
<div class="modal large" id="modalVoirFacture" onclick="event.stopPropagation()" style="display: none; max-height: 90vh; display: flex; flex-direction: column;">
    <div class="modal-header">
        <h3 class="modal-title">Facture <span id="voirNumero"></span></h3>
        <button class="modal-close" onclick="fermerModalVoir()">
            <i data-lucide="x"></i>
        </button>
    </div>
    <div class="modal-body" style="overflow-y: auto; flex: 1;">
        <div class="invoice-paper" id="facturePrint">
            <!-- En-tete -->
            <div class="invoice-header">
                <div>
                    <div class="invoice-logo">MAB</div>
                    <div style="margin-top: 10px; font-size: 11px;">
                        <strong>Etude Me BIAOU Martial Arnaud</strong><br>
                        Huissier de Justice<br>
                        Cotonou, Benin<br>
                        Tel: +229 97 00 00 00<br>
                        IFU: 3201900XXXXX
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="invoice-title">Facture</div>
                    <div class="invoice-status" id="voirStatut">NON NORMALISEE</div>
                    <div style="margin-top: 20px; font-size: 12px;">
                        <strong>N:</strong> <span id="voirNumeroDetail"></span><br>
                        <strong>Date:</strong> <span id="voirDate"></span><br>
                        <strong>Echeance:</strong> <span id="voirEcheance"></span>
                    </div>
                </div>
            </div>

            <!-- Client -->
            <div style="margin-bottom: 20px; padding: 15px; background: var(--neutral-50); border-radius: 8px;">
                <div style="font-size: 10px; text-transform: uppercase; color: var(--neutral-500); margin-bottom: 5px;">Facture a</div>
                <strong id="voirClient"></strong><br>
                <span id="voirClientIFU" style="font-size: 11px; color: var(--neutral-600);"></span>
            </div>

            <!-- Tableau des lignes -->
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Designation</th>
                        <th style="width: 15%; text-align: right;">Honoraires</th>
                        <th style="width: 12%; text-align: right;">Timbre</th>
                        <th style="width: 13%; text-align: right;">Enreg.</th>
                        <th style="width: 20%; text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody id="voirLignes">
                </tbody>
            </table>

            <!-- Totaux -->
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <div style="width: 280px;">
                    <div class="invoice-total-row">
                        <span>Total HT:</span>
                        <span id="voirHT"></span>
                    </div>
                    <div class="invoice-total-row">
                        <span>TVA (18%):</span>
                        <span id="voirTVA"></span>
                    </div>
                    <div class="invoice-total-row invoice-final-total">
                        <span>Total TTC:</span>
                        <span id="voirTTC"></span>
                    </div>
                </div>
            </div>

            <!-- MECeF -->
            <div id="voirMECeF" style="display: none; margin-top: 30px; padding: 15px; border: 1px solid var(--neutral-200); border-radius: 8px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div id="voirQRCode" style="width: 120px; height: 120px; background: white; display: flex; align-items: center; justify-content: center; border-radius: 8px; padding: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <!-- QR Code genere dynamiquement -->
                    </div>
                    <div style="flex: 1; font-size: 11px;">
                        <strong style="color: var(--success); font-size: 13px;">FACTURE NORMALISEE MECeF</strong><br><br>
                        <strong>N MECeF:</strong> <span id="voirMECeFNumero"></span><br>
                        <strong>NIM:</strong> <span id="voirNIM"></span><br>
                        <strong>Date normalisation:</strong> <span id="voirDateMECeF"></span><br>
                        <strong>Montant TTC:</strong> <span id="voirMECeFMontant"></span>
                    </div>
                </div>
            </div>

            <!-- Pied de page -->
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--neutral-200); font-size: 10px; color: var(--neutral-500); text-align: center;">
                Cette facture est payable a reception. En cas de retard, des interets de retard seront appliques conformement a la loi.
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fermerModalVoir()">Fermer</button>
        <div class="flex gap-2">
            <button class="btn btn-accent" onclick="imprimerFactureDirecte()">
                <i data-lucide="printer"></i> Imprimer
            </button>
            <button class="btn btn-primary" id="btnNormaliserVue" onclick="normaliserDepuisVue()">
                <i data-lucide="qr-code"></i> Normaliser MECeF
            </button>
            <button class="btn" id="btnCreerAvoir" onclick="ouvrirModalAvoir()" style="display: none; background: #fef3c7; color: #92400e; border-color: #f59e0b;">
                <i data-lucide="file-minus"></i> Creer un avoir
            </button>
        </div>
    </div>
</div>

<!-- Modal Créer un Avoir -->
<div class="modal" id="modalAvoir" style="display: none;">
    <div class="modal-header">
        <h3 class="modal-title"><i data-lucide="file-minus"></i> Creer un avoir</h3>
        <button class="modal-close" onclick="fermerModalAvoir()">
            <i data-lucide="x"></i>
        </button>
    </div>
    <div class="modal-body">
        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <strong style="color: #92400e;"><i data-lucide="alert-triangle" style="width: 16px; height: 16px; display: inline;"></i> Attention :</strong>
            <span style="color: #92400e;">Un avoir annule partiellement ou totalement une facture normalisee. L'avoir devra egalement etre normalise MECeF.</span>
        </div>

        <div style="background: var(--neutral-50); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <p style="margin-bottom: 8px;"><strong>Facture concernee :</strong> <span id="avoirFactureRef" style="color: var(--primary);"></span></p>
            <p style="margin: 0;"><strong>Montant original :</strong> <span id="avoirMontantOriginal" style="font-weight: 700;"></span></p>
        </div>

        <div class="form-group">
            <label class="form-label">Motif de l'avoir *</label>
            <textarea id="avoirMotif" class="form-input" rows="3" placeholder="Ex: Erreur de facturation, Annulation de prestation, etc."></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">Type d'annulation</label>
            <div style="display: flex; gap: 20px; margin-top: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="avoirType" value="total" checked onchange="toggleLignesAvoir()">
                    <span>Annulation totale</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="avoirType" value="partiel" onchange="toggleLignesAvoir()">
                    <span>Annulation partielle</span>
                </label>
            </div>
        </div>

        <div id="avoirLignesContainer" style="display: none; margin-top: 16px; padding: 12px; background: var(--neutral-50); border-radius: 8px;">
            <label class="form-label">Selectionner les lignes a annuler :</label>
            <div id="avoirLignesList" style="margin-top: 8px;"></div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fermerModalAvoir()">Annuler</button>
        <button class="btn" onclick="creerAvoir()" style="background: #fef3c7; color: #92400e; border-color: #f59e0b;">
            <i data-lucide="file-minus"></i> Creer l'avoir
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- QRCode.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    lucide.createIcons();

    // Donnees des factures
    let factures = {{ factures_json|safe }};
    let factureEnCours = null;
    let ligneIndex = 1;

    // ============================================
    // GESTION DU MODAL FACTURE
    // ============================================
    function ouvrirModalFacture(facture = null) {
        factureEnCours = facture;
        document.getElementById('modalFacture').style.display = 'block';
        document.getElementById('modalVoirFacture').style.display = 'none';
        document.getElementById('modalOverlay').classList.add('open');

        if (facture) {
            document.getElementById('modalFactureTitle').textContent = 'Modifier la facture';
            remplirFormulaire(facture);
        } else {
            document.getElementById('modalFactureTitle').textContent = 'Nouvelle facture';
            reinitialiserFormulaire();
            genererNumeroFacture();
        }
        lucide.createIcons();
    }

    function fermerModalFacture() {
        document.getElementById('modalOverlay').classList.remove('open');
        reinitialiserFormulaire();
    }

    function reinitialiserFormulaire() {
        document.getElementById('formFacture').reset();
        document.getElementById('factureId').value = '';
        document.getElementById('lignesFacture').innerHTML = '';
        ajouterLigne();
        calculerTotaux();

        // Date du jour
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('factureDate').value = today;

        // Echeance a 30 jours
        const echeance = new Date();
        echeance.setDate(echeance.getDate() + 30);
        document.getElementById('factureEcheance').value = echeance.toISOString().split('T')[0];
    }

    function genererNumeroFacture() {
        fetch('{% url "gestion:api_generer_numero_facture" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('factureNumero').value = data.numero;
            }
        });
    }

    function remplirFormulaire(facture) {
        document.getElementById('factureId').value = facture.id;
        document.getElementById('factureNumero').value = facture.numero;
        document.getElementById('factureDate').value = facture.date_emission;
        document.getElementById('factureEcheance').value = facture.date_echeance || '';
        document.getElementById('factureStatut').value = facture.statut;
        document.getElementById('factureClient').value = facture.client;
        document.getElementById('factureIFU').value = facture.ifu || '';
        document.getElementById('factureDossier').value = facture.dossier || '';
        document.getElementById('factureObservations').value = facture.observations || '';

        // Lignes
        document.getElementById('lignesFacture').innerHTML = '';
        if (facture.lignes && facture.lignes.length > 0) {
            facture.lignes.forEach((ligne, index) => {
                ajouterLigne(ligne);
            });
        } else {
            ajouterLigne();
        }
        calculerTotaux();
    }

    // ============================================
    // GESTION DES LIGNES
    // ============================================

    // Ajouter une ligne pour un acte (avec honoraires, timbre, enregistrement)
    function ajouterLigneActe(data = null) {
        const container = document.getElementById('lignesFacture');
        const div = document.createElement('div');
        div.className = 'ligne-facture ligne-acte';
        div.dataset.index = ligneIndex++;
        div.dataset.type = 'acte';

        const honoraires = data ? (data.honoraires || data.prix_unitaire || '') : '';
        const timbre = data ? (data.timbre || '') : '';
        const enregistrement = data ? (data.enregistrement || '') : '';

        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 11px; font-weight: 600; color: var(--primary); background: var(--primary-light); padding: 2px 8px; border-radius: 4px;">ACTE</span>
            </div>
            <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;">
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input class="form-input ligne-description" type="text" placeholder="Ex: Commandement de payer" value="${data ? data.description : ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Honoraires</label>
                    <input class="form-input ligne-honoraires" type="number" placeholder="56000" value="${honoraires}" onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label class="form-label">Timbre</label>
                    <input class="form-input ligne-timbre" type="number" placeholder="1200" value="${timbre}" onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label class="form-label">Enreg.</label>
                    <input class="form-input ligne-enreg" type="number" placeholder="2500" value="${enregistrement}" onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label class="form-label">Total</label>
                    <input class="form-input ligne-total" type="text" readonly style="background: var(--neutral-100); font-weight: 600;">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button type="button" class="btn btn-danger btn-icon" onclick="supprimerLigne(this)" style="margin-bottom: 6px;">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(div);
        lucide.createIcons();
        calculerTotaux();
    }

    // Ajouter une ligne pour un débours (montant fixe uniquement)
    function ajouterLigneDebours(data = null) {
        const container = document.getElementById('lignesFacture');
        const div = document.createElement('div');
        div.className = 'ligne-facture ligne-debours';
        div.dataset.index = ligneIndex++;
        div.dataset.type = 'debours';

        const montant = data ? (data.montant_ht || data.prix_unitaire || '') : '';

        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 11px; font-weight: 600; color: #92400e; background: #fef3c7; padding: 2px 8px; border-radius: 4px;">DEBOURS</span>
            </div>
            <div class="form-grid" style="grid-template-columns: 3fr 1fr auto; background: #fffbeb; padding: 12px; border-radius: 8px; border: 1px dashed #f59e0b;">
                <div class="form-group">
                    <label class="form-label">Description du debours</label>
                    <input class="form-input ligne-description" type="text" placeholder="Ex: Frais d'ordonnance d'injonction de payer" value="${data ? data.description : ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Montant</label>
                    <input class="form-input ligne-montant-debours" type="number" placeholder="7000" value="${montant}" onchange="calculerTotaux()" style="font-weight: 600;">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button type="button" class="btn btn-danger btn-icon" onclick="supprimerLigne(this)" style="margin-bottom: 6px;">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(div);
        lucide.createIcons();
        calculerTotaux();
    }

    // Fonction de compatibilité pour l'ancien code
    function ajouterLigne(data = null) {
        if (data && data.type_ligne === 'debours') {
            ajouterLigneDebours(data);
        } else {
            ajouterLigneActe(data);
        }
    }

    function supprimerLigne(btn) {
        const lignes = document.querySelectorAll('.ligne-facture');
        if (lignes.length > 0) {
            btn.closest('.ligne-facture').remove();
            calculerTotaux();
        }
    }

    function calculerTotaux() {
        let totalHonoaires = 0;
        let totalDebours = 0;

        // Calculer pour les lignes acte
        document.querySelectorAll('.ligne-acte').forEach(ligne => {
            const honoraires = parseFloat(ligne.querySelector('.ligne-honoraires')?.value) || 0;
            const timbre = parseFloat(ligne.querySelector('.ligne-timbre')?.value) || 0;
            const enreg = parseFloat(ligne.querySelector('.ligne-enreg')?.value) || 0;
            const total = honoraires + timbre + enreg;
            const totalField = ligne.querySelector('.ligne-total');
            if (totalField) totalField.value = formatMontant(total);
            totalHonoaires += honoraires;
            totalDebours += timbre + enreg;
        });

        // Calculer pour les lignes debours
        document.querySelectorAll('.ligne-debours').forEach(ligne => {
            const montant = parseFloat(ligne.querySelector('.ligne-montant-debours')?.value) || 0;
            totalDebours += montant;
        });

        const totalHT = totalHonoaires + totalDebours;
        const tva = totalHonoaires * 0.18;  // TVA uniquement sur les honoraires
        const ttc = totalHT + tva;

        document.getElementById('factureMontantHT').value = formatMontant(totalHT);
        document.getElementById('factureTVA').value = formatMontant(tva);
        document.getElementById('factureTTC').value = formatMontant(ttc);
    }

    function formatMontant(m) {
        return new Intl.NumberFormat('fr-FR').format(Math.round(m)) + ' FCFA';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        return d.toLocaleDateString('fr-FR');
    }

    // ============================================
    // SAUVEGARDE FACTURE
    // ============================================
    function sauvegarderFacture(event, brouillon = false) {
        event.preventDefault();

        // Collecter les lignes
        const lignes = [];

        // Collecter les lignes acte
        document.querySelectorAll('.ligne-acte').forEach(ligne => {
            const description = ligne.querySelector('.ligne-description').value;
            const honoraires = parseFloat(ligne.querySelector('.ligne-honoraires').value) || 0;
            const timbre = parseFloat(ligne.querySelector('.ligne-timbre').value) || 0;
            const enregistrement = parseFloat(ligne.querySelector('.ligne-enreg').value) || 0;
            if (description && (honoraires > 0 || timbre > 0 || enregistrement > 0)) {
                lignes.push({
                    description,
                    quantite: 1,
                    prix_unitaire: honoraires,
                    type_ligne: 'acte',
                    honoraires: honoraires,
                    timbre: timbre,
                    enregistrement: enregistrement
                });
            }
        });

        // Collecter les lignes debours
        document.querySelectorAll('.ligne-debours').forEach(ligne => {
            const description = ligne.querySelector('.ligne-description').value;
            const montant = parseFloat(ligne.querySelector('.ligne-montant-debours').value) || 0;
            if (description && montant > 0) {
                lignes.push({
                    description,
                    quantite: 1,
                    prix_unitaire: montant,
                    type_ligne: 'debours'
                });
            }
        });

        if (lignes.length === 0) {
            alert('Veuillez ajouter au moins une ligne a la facture');
            return;
        }

        const data = {
            id: document.getElementById('factureId').value || null,
            numero: document.getElementById('factureNumero').value,
            date_emission: document.getElementById('factureDate').value,
            date_echeance: document.getElementById('factureEcheance').value,
            statut: brouillon ? 'brouillon' : document.getElementById('factureStatut').value,
            client: document.getElementById('factureClient').value,
            ifu: document.getElementById('factureIFU').value,
            dossier: document.getElementById('factureDossier').value,
            observations: document.getElementById('factureObservations').value,
            lignes: lignes
        };

        fetch('{% url "gestion:api_sauvegarder_facture" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(brouillon ? 'Brouillon enregistre !' : 'Facture enregistree !');
                location.reload();
            } else {
                alert(result.error || 'Erreur lors de la sauvegarde');
            }
        })
        .catch(error => {
            alert('Erreur: ' + error.message);
        });
    }

    // ============================================
    // ACTIONS SUR LES FACTURES
    // ============================================
    function voirFacture(id) {
        const facture = factures.find(f => f.id == id);
        if (!facture) return;

        document.getElementById('modalFacture').style.display = 'none';
        document.getElementById('modalVoirFacture').style.display = 'block';
        document.getElementById('modalOverlay').classList.add('open');

        document.getElementById('voirNumero').textContent = facture.numero;
        document.getElementById('voirNumeroDetail').textContent = facture.numero;
        document.getElementById('voirDate').textContent = formatDate(facture.date_emission);
        document.getElementById('voirEcheance').textContent = formatDate(facture.date_echeance);
        document.getElementById('voirClient').textContent = facture.client;
        document.getElementById('voirClientIFU').textContent = facture.ifu ? 'IFU: ' + facture.ifu : '';
        document.getElementById('voirHT').textContent = formatMontant(facture.montant_ht);
        document.getElementById('voirTVA').textContent = formatMontant(facture.tva);
        document.getElementById('voirTTC').textContent = formatMontant(facture.total);

        // Statut
        const statutEl = document.getElementById('voirStatut');
        const qrContainer = document.getElementById('voirQRCode');
        qrContainer.innerHTML = ''; // Nettoyer le QR code precedent

        if (facture.mecef_numero) {
            statutEl.textContent = 'NORMALISEE';
            statutEl.classList.add('normalisee');
            document.getElementById('voirMECeF').style.display = 'block';
            document.getElementById('voirMECeFNumero').textContent = facture.mecef_numero;
            document.getElementById('voirNIM').textContent = facture.nim || 'N/A';
            document.getElementById('voirDateMECeF').textContent = facture.date_mecef || '-';
            document.getElementById('voirMECeFMontant').textContent = formatMontant(facture.total);
            document.getElementById('btnNormaliserVue').style.display = 'none';

            // Afficher le bouton "Créer un avoir" si facture standard normalisée sans avoir existant
            const typeFacture = facture.type_facture || 'standard';
            const avoirExiste = facture.avoir_lie || false;
            if (typeFacture === 'standard' && !avoirExiste) {
                document.getElementById('btnCreerAvoir').style.display = 'inline-flex';
            } else {
                document.getElementById('btnCreerAvoir').style.display = 'none';
            }

            // Generer le QR Code MECeF
            const qrData = `MECeF|NIM:${facture.nim || 'N/A'}|NUM:${facture.mecef_numero}|TTC:${Math.round(facture.total)}|DATE:${facture.date_mecef || '-'}|CLIENT:${facture.client}`;
            try {
                new QRCode(qrContainer, {
                    text: qrData,
                    width: 100,
                    height: 100,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch (e) {
                qrContainer.innerHTML = '<div style="text-align: center; color: var(--neutral-400); font-size: 10px;">QR Code</div>';
            }
        } else {
            statutEl.textContent = 'NON NORMALISEE';
            statutEl.classList.remove('normalisee');
            document.getElementById('voirMECeF').style.display = 'none';
            document.getElementById('btnNormaliserVue').style.display = 'inline-flex';
            document.getElementById('btnCreerAvoir').style.display = 'none';
        }

        // Lignes
        const tbody = document.getElementById('voirLignes');
        tbody.innerHTML = '';
        if (facture.lignes && facture.lignes.length > 0) {
            facture.lignes.forEach(ligne => {
                const tr = document.createElement('tr');

                if (ligne.type_ligne === 'debours') {
                    // Ligne débours : affichage simplifié avec badge
                    tr.style.background = '#fffbeb';
                    tr.innerHTML = `
                        <td>
                            ${ligne.description}
                            <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: #fef3c7; color: #92400e;">Debours</span>
                        </td>
                        <td colspan="3" style="text-align: center; color: #888;">-</td>
                        <td style="text-align: right; font-weight: 600;">${formatMontant(ligne.montant_ht || ligne.prix_unitaire)}</td>
                    `;
                } else {
                    // Ligne acte : avec décomposition honoraires/timbre/enregistrement
                    const honoraires = ligne.honoraires || ligne.prix_unitaire;
                    const timbre = ligne.timbre || 0;
                    const enregistrement = ligne.enregistrement || 0;
                    const total = ligne.montant_ht || (honoraires + timbre + enregistrement);

                    tr.innerHTML = `
                        <td>${ligne.description}</td>
                        <td style="text-align: right;">${formatMontant(honoraires)}</td>
                        <td style="text-align: right;">${formatMontant(timbre)}</td>
                        <td style="text-align: right;">${formatMontant(enregistrement)}</td>
                        <td style="text-align: right; font-weight: 600;">${formatMontant(total)}</td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        factureEnCours = facture;
        lucide.createIcons();
    }

    function fermerModalVoir() {
        document.getElementById('modalOverlay').classList.remove('open');
        factureEnCours = null;
    }

    function modifierFacture(id) {
        const facture = factures.find(f => f.id == id);
        if (facture) {
            ouvrirModalFacture(facture);
        }
    }

    function supprimerFacture(id) {
        if (!confirm('Etes-vous sur de vouloir supprimer cette facture ?')) return;

        fetch('{% url "gestion:api_supprimer_facture" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert(result.error || 'Erreur lors de la suppression');
            }
        });
    }

    function imprimerFacture(id) {
        voirFacture(id);
        setTimeout(() => {
            imprimerFactureDirecte();
        }, 300);
    }

    function imprimerFactureDirecte() {
        const contenu = document.getElementById('facturePrint').innerHTML;
        const fenetre = window.open('', '_blank');
        fenetre.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Facture - ${factureEnCours ? factureEnCours.numero : ''}</title>
                <link rel="stylesheet" href="{% static 'css/styles.css' %}">
                <style>
                    body { background: white; padding: 20px; }
                    .invoice-paper { box-shadow: none; }
                    @media print {
                        body { padding: 0; }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-paper">${contenu}</div>
                <scr` + `ipt>
                    setTimeout(() => { window.print(); }, 500);
                <\/script>
            </body>
            </html>
        `);
        fenetre.document.close();
    }

    // ============================================
    // MECeF
    // ============================================
    function normaliserMECeF(id) {
        if (!confirm('Normaliser cette facture avec le systeme MECeF ?')) return;

        fetch('{% url "gestion:api_normaliser_mecef" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Facture normalisee avec succes !\nN MECeF: ' + result.mecef_numero);
                location.reload();
            } else {
                alert(result.error || 'Erreur lors de la normalisation');
            }
        });
    }

    function normaliserDepuisVue() {
        if (factureEnCours) {
            normaliserMECeF(factureEnCours.id);
        }
    }

    // ============================================
    // FILTRES ET EXPORT
    // ============================================
    function filtrerFactures() {
        const recherche = document.getElementById('rechercheFacture').value.toLowerCase();
        const statut = document.getElementById('filtreStatut').value;

        document.querySelectorAll('#factureListe tr').forEach(tr => {
            if (tr.id === 'emptyRow') return;
            const client = (tr.dataset.client || '').toLowerCase();
            const trStatut = tr.dataset.statut || '';

            const matchRecherche = !recherche || client.includes(recherche);
            const matchStatut = !statut || trStatut === statut;

            tr.style.display = matchRecherche && matchStatut ? '' : 'none';
        });
    }

    function exporterFactures() {
        window.open('{% url "gestion:api_exporter_factures" %}?format=csv', '_blank');
    }

    // ============================================
    // GESTION DES AVOIRS
    // ============================================

    function ouvrirModalAvoir() {
        if (!factureEnCours) {
            alert('Aucune facture selectionnee');
            return;
        }

        // Remplir les informations de la facture
        document.getElementById('avoirFactureRef').textContent = factureEnCours.numero;
        document.getElementById('avoirMontantOriginal').textContent = formatMontant(factureEnCours.total);
        document.getElementById('avoirMotif').value = '';

        // Reset du type d'annulation
        document.querySelector('input[name="avoirType"][value="total"]').checked = true;
        document.getElementById('avoirLignesContainer').style.display = 'none';

        // Charger les lignes pour l'annulation partielle
        chargerLignesPourAvoir();

        // Afficher le modal
        document.getElementById('modalAvoir').style.display = 'block';
        lucide.createIcons();
    }

    function fermerModalAvoir() {
        document.getElementById('modalAvoir').style.display = 'none';
    }

    function toggleLignesAvoir() {
        const typeAnnulation = document.querySelector('input[name="avoirType"]:checked').value;
        const container = document.getElementById('avoirLignesContainer');

        if (typeAnnulation === 'partiel') {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }

    function chargerLignesPourAvoir() {
        if (!factureEnCours || !factureEnCours.lignes) return;

        let lignesHtml = '';
        factureEnCours.lignes.forEach(function(ligne, index) {
            const montant = ligne.montant_ht || ligne.prix_unitaire || 0;
            const typeLabel = ligne.type_ligne === 'debours' ? ' (Debours)' : '';
            lignesHtml += `
                <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid var(--neutral-200);">
                    <input type="checkbox" class="ligne-avoir-check" value="${ligne.id || index}" id="avoirLigne${index}">
                    <label for="avoirLigne${index}" style="flex: 1; cursor: pointer;">
                        ${ligne.description}${typeLabel}
                    </label>
                    <span style="font-weight: 600;">${formatMontant(Math.abs(montant))}</span>
                </div>
            `;
        });

        document.getElementById('avoirLignesList').innerHTML = lignesHtml || '<p style="color: var(--neutral-500);">Aucune ligne disponible</p>';
    }

    function creerAvoir() {
        const motif = document.getElementById('avoirMotif').value.trim();

        if (!motif) {
            alert('Veuillez saisir un motif pour l\'avoir');
            return;
        }

        if (!factureEnCours) {
            alert('Aucune facture selectionnee');
            return;
        }

        const typeAnnulation = document.querySelector('input[name="avoirType"]:checked').value;
        let lignesIds = [];

        if (typeAnnulation === 'partiel') {
            document.querySelectorAll('.ligne-avoir-check:checked').forEach(function(cb) {
                lignesIds.push(parseInt(cb.value));
            });
            if (lignesIds.length === 0) {
                alert('Veuillez selectionner au moins une ligne a annuler');
                return;
            }
        }

        if (!confirm('Etes-vous sur de vouloir creer cet avoir ?')) {
            return;
        }

        fetch('{% url "gestion:api_creer_avoir" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                facture_id: factureEnCours.id,
                motif: motif,
                lignes: lignesIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Avoir ' + data.avoir_numero + ' cree avec succes !\nPensez a le normaliser MECeF.');
                fermerModalAvoir();
                fermerModalVoir();
                location.reload();
            } else {
                alert('Erreur : ' + data.error);
            }
        })
        .catch(err => {
            console.error(err);
            alert('Erreur lors de la creation de l\'avoir');
        });
    }
</script>
{% endblock %}
