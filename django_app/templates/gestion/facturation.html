{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Header with tabs and button -->
<div class="flex justify-between items-center flex-wrap gap-4 mb-4">
    <div class="tabs" style="margin-bottom: 0; border-bottom: none;">
        <a href="?tab=liste" class="tab {% if current_tab == 'liste' %}active{% endif %}">
            Liste des factures
        </a>
        <a href="{% url 'gestion:memoires' %}" class="tab">
            Memoires
        </a>
        <a href="?tab=mecef" class="tab {% if current_tab == 'mecef' %}active{% endif %}">
            MECeF
        </a>
    </div>
    <div class="flex gap-2">
        {% if current_tab == 'liste' %}
        <button class="btn btn-secondary" onclick="exporterFactures()">
            <i data-lucide="download"></i> Exporter
        </button>
        <button class="btn btn-primary" onclick="ouvrirModalFacture()">
            <i data-lucide="plus"></i> Nouvelle facture
        </button>
        {% endif %}
    </div>
</div>

{% if current_tab == 'mecef' %}
<!-- Contenu MECeF -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title"><i data-lucide="shield-check"></i> Factures Normalisees MECeF</h3>
        <div class="flex gap-2">
            <span class="status-badge active">{{ factures_normalisees|length }} normalisee{{ factures_normalisees|length|pluralize }}</span>
        </div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>N Facture</th>
                    <th>Client</th>
                    <th>Total TTC</th>
                    <th>N MECeF</th>
                    <th>NIM</th>
                    <th>Date normalisation</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for facture in factures %}
                {% if facture.mecef_numero %}
                <tr>
                    <td style="font-weight: 600; color: var(--primary);">{{ facture.numero }}</td>
                    <td>{{ facture.client }}</td>
                    <td style="font-weight: 600;">{{ facture.total|floatformat:0 }} F</td>
                    <td><span class="status-badge active">{{ facture.mecef_numero }}</span></td>
                    <td>{{ facture.nim }}</td>
                    <td>{{ facture.date_mecef }}</td>
                    <td>
                        <div class="flex gap-1">
                            <button class="icon-btn" title="Voir" onclick="voirFacture('{{ facture.id }}')">
                                <i data-lucide="eye"></i>
                            </button>
                            <button class="icon-btn" title="Imprimer" onclick="imprimerFacture('{{ facture.id }}')">
                                <i data-lucide="printer"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
                {% if not nb_normalisees or nb_normalisees == 0 %}
                <tr>
                    <td colspan="7" class="text-center" style="padding: 40px; color: var(--neutral-500);">
                        Aucune facture normalisee
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Info MECeF -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><i data-lucide="info"></i> A propos du MECeF</h3>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">
            Le <strong>MECeF</strong> (Machine Electronique Certifiee de Facturation) est le systeme de normalisation
            des factures mis en place par la Direction Generale des Impots du Benin.
        </p>
        <div class="grid grid-cols-3 gap-4">
            <div class="stat-card" style="padding: 16px;">
                <div style="color: var(--primary); font-weight: 600; font-size: 1.2rem;">{{ nb_normalisees|default:0 }}</div>
                <div style="color: var(--neutral-500); font-size: 0.85rem;">Factures normalisees</div>
            </div>
            <div class="stat-card" style="padding: 16px;">
                <div style="color: var(--warning); font-weight: 600; font-size: 1.2rem;">{{ nb_non_normalisees|default:0 }}</div>
                <div style="color: var(--neutral-500); font-size: 0.85rem;">En attente de normalisation</div>
            </div>
            <div class="stat-card" style="padding: 16px;">
                <div style="color: var(--success); font-weight: 600; font-size: 1.2rem;">18%</div>
                <div style="color: var(--neutral-500); font-size: 0.85rem;">Taux TVA applique</div>
            </div>
        </div>
        <div class="alert alert-info mt-4" style="background: var(--primary-light); border: 1px solid var(--primary); border-radius: 8px; padding: 12px;">
            <strong>Note:</strong> La normalisation MECeF est actuellement en mode simulation.
            Pour une integration complete avec l'API DGI Benin, contactez votre administrateur.
        </div>
    </div>
</div>

{% else %}
<!-- Contenu Liste des factures (onglet par defaut) -->

<!-- Factures Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Factures</h3>
        <div class="flex gap-2">
            <select class="form-select" style="width: auto; padding: 6px 10px;" id="filtreStatut" onchange="filtrerFactures()">
                <option value="">Tous les statuts</option>
                <option value="brouillon">Brouillon</option>
                <option value="attente">En attente</option>
                <option value="payee">Payee</option>
                <option value="annulee">Annulee</option>
            </select>
            <input type="text" class="form-input" placeholder="Rechercher..." id="rechercheFacture" style="width: 200px; padding: 6px 10px;" oninput="filtrerFactures()">
        </div>
    </div>
    <div class="table-container">
        <table id="tableFactures">
            <thead>
                <tr>
                    <th>N Facture</th>
                    <th>Client</th>
                    <th>Montant HT</th>
                    <th>TVA (18%)</th>
                    <th>Total TTC</th>
                    <th>Date</th>
                    <th>Statut</th>
                    <th>MECeF</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="factureListe">
                {% for facture in factures %}
                <tr data-id="{{ facture.id }}" data-client="{{ facture.client }}" data-statut="{{ facture.statut }}">
                    <td style="font-weight: 600; color: var(--primary);">{{ facture.numero }}</td>
                    <td>{{ facture.client }}</td>
                    <td>{{ facture.montant_ht|floatformat:0 }} F</td>
                    <td>{{ facture.tva|floatformat:0 }} F</td>
                    <td style="font-weight: 600;">{{ facture.total|floatformat:0 }} F</td>
                    <td>{{ facture.date }}</td>
                    <td>
                        <span class="status-badge {{ facture.statut }}">
                            {% if facture.statut == 'payee' %}Payee
                            {% elif facture.statut == 'attente' %}En attente
                            {% elif facture.statut == 'brouillon' %}Brouillon
                            {% else %}Annulee{% endif %}
                        </span>
                    </td>
                    <td>
                        {% if facture.mecef_numero %}
                        <span class="status-badge active" style="font-size: 10px;">
                            <i data-lucide="check" style="width: 12px; height: 12px;"></i>
                            {{ facture.mecef_numero }}
                        </span>
                        {% else %}
                        <button class="btn btn-sm btn-secondary" onclick="normaliserMECeF('{{ facture.id }}')">
                            Normaliser
                        </button>
                        {% endif %}
                    </td>
                    <td>
                        <div class="flex gap-1">
                            <button class="icon-btn" title="Voir" onclick="voirFacture('{{ facture.id }}')">
                                <i data-lucide="eye"></i>
                            </button>
                            <button class="icon-btn" title="Modifier" onclick="modifierFacture('{{ facture.id }}')">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="icon-btn" title="Imprimer" onclick="imprimerFacture('{{ facture.id }}')">
                                <i data-lucide="printer"></i>
                            </button>
                            <button class="icon-btn" title="Supprimer" onclick="supprimerFacture('{{ facture.id }}')" style="color: var(--danger);">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr id="emptyRow">
                    <td colspan="9" class="text-center" style="padding: 40px; color: var(--neutral-500);">
                        Aucune facture trouvee
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Totaux -->
<div class="grid grid-cols-4 gap-4 mt-4">
    <div class="card stat-card">
        <div class="stat-content">
            <div class="stat-icon info">
                <i data-lucide="file-text"></i>
            </div>
            <div>
                <div class="stat-label">Total Factures</div>
                <div class="stat-value" id="totalFactures">{{ factures|length }}</div>
            </div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-content">
            <div class="stat-icon accent">
                <i data-lucide="banknote"></i>
            </div>
            <div>
                <div class="stat-label">Total HT</div>
                <div class="stat-value" id="totalHT">{{ total_ht|floatformat:0|default:"0" }} F</div>
            </div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-content">
            <div class="stat-icon success">
                <i data-lucide="receipt"></i>
            </div>
            <div>
                <div class="stat-label">Total TTC</div>
                <div class="stat-value" id="totalTTC">{{ total_ttc|floatformat:0|default:"0" }} F</div>
            </div>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-content">
            <div class="stat-icon danger">
                <i data-lucide="clock"></i>
            </div>
            <div>
                <div class="stat-label">En attente</div>
                <div class="stat-value danger" id="enAttente">{{ nb_attente|default:"0" }}</div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block modal %}
<!-- Modal Nouvelle Facture -->
<div class="modal large modal-facture" id="modalFacture" onclick="event.stopPropagation()" style="display: none; max-height: 90vh; flex-direction: column; overflow: hidden;">
    <div class="modal-header" style="flex-shrink: 0;">
        <h3 class="modal-title" id="modalFactureTitle">Nouvelle facture</h3>
        <button class="modal-close" onclick="fermerModalFacture()">
            <i data-lucide="x"></i>
        </button>
    </div>
    <form id="formFacture" onsubmit="sauvegarderFacture(event)" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
            <input type="hidden" id="factureId" name="id">

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Numero de facture</label>
                    <input class="form-input" type="text" id="factureNumero" name="numero" readonly style="background: var(--neutral-100);">
                </div>
                <div class="form-group">
                    <label class="form-label">Date d'emission</label>
                    <input class="form-input" type="date" id="factureDate" name="date_emission" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Date d'echeance</label>
                    <input class="form-input" type="date" id="factureEcheance" name="date_echeance">
                </div>
                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="factureStatut" name="statut">
                        <option value="brouillon">Brouillon</option>
                        <option value="attente">En attente</option>
                        <option value="payee">Payee</option>
                        <option value="annulee">Annulee</option>
                    </select>
                </div>
            </div>

            <div class="form-section-title">Client</div>
            <div class="form-grid">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label">Nom du client</label>
                    <input class="form-input" type="text" id="factureClient" name="client" required placeholder="Ex: SODECO SA">
                </div>
                <div class="form-group">
                    <label class="form-label">IFU (optionnel)</label>
                    <input class="form-input" type="text" id="factureIFU" name="ifu" placeholder="Ex: 3201900001234">
                </div>
                <div class="form-group">
                    <label class="form-label">Dossier lie (optionnel)</label>
                    <select class="form-select" id="factureDossier" name="dossier">
                        <option value="">-- Aucun --</option>
                        {% for dossier in dossiers %}
                        <option value="{{ dossier.id }}">{{ dossier.reference }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-section-title">Lignes de facture</div>
            <div id="lignesFacture">
                <div class="ligne-facture" data-index="0">
                    <div class="form-grid" style="grid-template-columns: 3fr 1fr 1fr 1fr auto;">
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input class="form-input ligne-description" type="text" placeholder="Ex: Commandement de payer">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantite</label>
                            <input class="form-input ligne-quantite" type="number" value="1" min="1" onchange="calculerTotaux()" oninput="calculerTotaux()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prix unitaire</label>
                            <input class="form-input ligne-prix" type="number" placeholder="15000" onchange="calculerTotaux()" oninput="calculerTotaux()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total</label>
                            <input class="form-input ligne-total" type="text" readonly style="background: var(--neutral-100);">
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button type="button" class="btn btn-danger btn-icon" onclick="supprimerLigne(this)" style="margin-bottom: 6px;">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary mt-2" onclick="ajouterLigne()">
                <i data-lucide="plus"></i> Ajouter une ligne
            </button>

            <div class="form-section-title">Totaux</div>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="form-group">
                    <label class="form-label">Total HT</label>
                    <input class="form-input" type="text" id="factureMontantHT" readonly style="background: var(--neutral-100); font-weight: bold;">
                </div>
                <div class="form-group">
                    <label class="form-label">TVA (18%)</label>
                    <input class="form-input" type="text" id="factureTVA" readonly style="background: var(--neutral-100);">
                </div>
                <div class="form-group">
                    <label class="form-label">Total TTC</label>
                    <input class="form-input" type="text" id="factureTTC" readonly style="background: var(--primary); color: white; font-weight: bold;">
                </div>
            </div>

            <div class="form-section-title">Observations</div>
            <div class="form-group">
                <textarea class="form-input" id="factureObservations" name="observations" rows="3" placeholder="Notes ou observations..."></textarea>
            </div>
        </div>
        <!-- Boutons d'action - footer fixe -->
        <div class="modal-footer" style="flex-shrink: 0; padding: 16px 20px; background: white; border-top: 1px solid #dee2e6; display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="fermerModalFacture()">← Annuler</button>
            <button type="button" class="btn btn-accent" onclick="sauvegarderFacture(event, true)">
                <i data-lucide="save"></i> Enregistrer brouillon
            </button>
            <button type="submit" class="btn btn-primary">
                <i data-lucide="check"></i> Enregistrer la facture
            </button>
        </div>
    </form>
</div>

<!-- Modal Voir Facture -->
<div class="modal large modal-voir-facture" id="modalVoirFacture" onclick="event.stopPropagation()" style="display: none; max-height: 90vh; flex-direction: column; overflow: hidden;">
    <div class="modal-header" style="flex-shrink: 0;">
        <h3 class="modal-title">Facture <span id="voirNumero"></span></h3>
        <button class="modal-close" onclick="fermerModalVoir()">
            <i data-lucide="x"></i>
        </button>
    </div>
    <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px; max-height: calc(90vh - 140px);">
        <div class="invoice-paper" id="facturePrint">
            <!-- En-tete -->
            <div class="invoice-header">
                <div>
                    <div class="invoice-logo">MAB</div>
                    <div style="margin-top: 10px; font-size: 11px;">
                        <strong>Etude Me BIAOU Martial Arnaud</strong><br>
                        Huissier de Justice<br>
                        Cotonou, Benin<br>
                        Tel: +229 97 00 00 00<br>
                        IFU: 3201900XXXXX
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="invoice-title">Facture</div>
                    <div class="invoice-status" id="voirStatut">NON NORMALISEE</div>
                    <div style="margin-top: 20px; font-size: 12px;">
                        <strong>N:</strong> <span id="voirNumeroDetail"></span><br>
                        <strong>Date:</strong> <span id="voirDate"></span><br>
                        <strong>Echeance:</strong> <span id="voirEcheance"></span>
                    </div>
                </div>
            </div>

            <!-- Client -->
            <div style="margin-bottom: 20px; padding: 15px; background: var(--neutral-50); border-radius: 8px;">
                <div style="font-size: 10px; text-transform: uppercase; color: var(--neutral-500); margin-bottom: 5px;">Facture a</div>
                <strong id="voirClient"></strong><br>
                <span id="voirClientIFU" style="font-size: 11px; color: var(--neutral-600);"></span>
            </div>

            <!-- Tableau des lignes -->
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Description</th>
                        <th style="width: 15%; text-align: center;">Qte</th>
                        <th style="width: 17%; text-align: right;">Prix Unit.</th>
                        <th style="width: 18%; text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody id="voirLignes">
                </tbody>
            </table>

            <!-- Totaux -->
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <div style="width: 280px;">
                    <div class="invoice-total-row">
                        <span>Total HT:</span>
                        <span id="voirHT"></span>
                    </div>
                    <div class="invoice-total-row">
                        <span>TVA (18%):</span>
                        <span id="voirTVA"></span>
                    </div>
                    <div class="invoice-total-row invoice-final-total">
                        <span>Total TTC:</span>
                        <span id="voirTTC"></span>
                    </div>
                </div>
            </div>

            <!-- MECeF -->
            <div id="voirMECeF" style="display: none; margin-top: 30px; padding: 15px; border: 1px solid var(--neutral-200); border-radius: 8px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div id="voirQRCode" style="width: 120px; height: 120px; background: white; display: flex; align-items: center; justify-content: center; border-radius: 8px; padding: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <!-- QR Code genere dynamiquement -->
                    </div>
                    <div style="flex: 1; font-size: 11px;">
                        <strong style="color: var(--success); font-size: 13px;">FACTURE NORMALISEE MECeF</strong><br><br>
                        <strong>N MECeF:</strong> <span id="voirMECeFNumero"></span><br>
                        <strong>NIM:</strong> <span id="voirNIM"></span><br>
                        <strong>Date normalisation:</strong> <span id="voirDateMECeF"></span><br>
                        <strong>Montant TTC:</strong> <span id="voirMECeFMontant"></span>
                    </div>
                </div>
            </div>

            <!-- Pied de page -->
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--neutral-200); font-size: 10px; color: var(--neutral-500); text-align: center;">
                Cette facture est payable a reception. En cas de retard, des interets de retard seront appliques conformement a la loi.
            </div>
        </div>
    </div>
    <div class="modal-footer" style="flex-shrink: 0; padding: 16px 20px; background: white; border-top: 1px solid #dee2e6; display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="fermerModalVoir()">Fermer</button>
        <div class="flex gap-2">
            <button class="btn btn-accent" onclick="imprimerFactureDirecte()">
                <i data-lucide="printer"></i> Imprimer
            </button>
            <button class="btn btn-primary" id="btnNormaliserVue" onclick="normaliserDepuisVue()">
                <i data-lucide="qr-code"></i> Normaliser MECeF
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- CSS pour tous les modals scrollables - FORCE avec !important -->
<style>
    /* Forcer scroll modal - solution radicale pour TOUS les modals */
    /* Note: Ne PAS utiliser display: flex !important ici car cela empêche de cacher les modals */
    #modalFacture,
    #modalFacture.modal-facture,
    .modal-facture,
    #modalVoirFacture,
    .modal-voir-facture,
    .modal.large {
        max-height: 90vh !important;
        overflow: hidden !important;
        flex-direction: column !important;
    }

    /* Afficher le modal en flex seulement quand il est visible (pas display:none) */
    #modalFacture:not([style*="display: none"]):not([style*="display:none"]) {
        display: flex !important;
    }
    #modalVoirFacture:not([style*="display: none"]):not([style*="display:none"]) {
        display: flex !important;
    }

    #modalFacture .modal-body,
    .modal-facture .modal-body,
    #modalVoirFacture .modal-body,
    .modal-voir-facture .modal-body,
    .modal.large .modal-body {
        flex: 1 1 auto !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        max-height: calc(90vh - 140px) !important;
        padding: 20px !important;
    }

    #modalFacture .modal-footer,
    .modal-facture .modal-footer,
    #modalVoirFacture .modal-footer,
    .modal-voir-facture .modal-footer,
    .modal.large .modal-footer {
        flex-shrink: 0 !important;
        position: sticky !important;
        bottom: 0 !important;
        background: white !important;
        padding: 16px 20px !important;
        border-top: 1px solid #dee2e6 !important;
        display: flex !important;
        gap: 12px !important;
        justify-content: flex-end !important;
        z-index: 10 !important;
    }

    #modalFacture .modal-header,
    .modal-facture .modal-header,
    #modalVoirFacture .modal-header,
    .modal-voir-facture .modal-header,
    .modal.large .modal-header {
        flex-shrink: 0 !important;
    }

    #modalFacture form,
    .modal-facture form {
        display: flex !important;
        flex-direction: column !important;
        flex: 1 !important;
        overflow: hidden !important;
        max-height: calc(90vh - 60px) !important;
    }
</style>

<!-- QRCode.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    lucide.createIcons();

    // Donnees des factures
    let factures = {{ factures_json|safe }};
    let factureEnCours = null;
    let ligneIndex = 1;

    // ============================================
    // GESTION DU MODAL FACTURE
    // ============================================
    function ouvrirModalFacture(facture = null) {
        factureEnCours = facture;
        document.getElementById('modalFacture').style.display = 'flex';
        document.getElementById('modalVoirFacture').style.display = 'none';
        document.getElementById('modalOverlay').classList.add('open');

        if (facture) {
            document.getElementById('modalFactureTitle').textContent = 'Modifier la facture';
            remplirFormulaire(facture);
        } else {
            document.getElementById('modalFactureTitle').textContent = 'Nouvelle facture';
            reinitialiserFormulaire();
            genererNumeroFacture();
        }
        lucide.createIcons();
    }

    function fermerModalFacture() {
        document.getElementById('modalOverlay').classList.remove('open');
        reinitialiserFormulaire();
    }

    function reinitialiserFormulaire() {
        document.getElementById('formFacture').reset();
        document.getElementById('factureId').value = '';
        document.getElementById('lignesFacture').innerHTML = '';
        ajouterLigne();
        calculerTotaux();

        // Date du jour
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('factureDate').value = today;

        // Echeance a 30 jours
        const echeance = new Date();
        echeance.setDate(echeance.getDate() + 30);
        document.getElementById('factureEcheance').value = echeance.toISOString().split('T')[0];
    }

    function genererNumeroFacture() {
        fetch('{% url "gestion:api_generer_numero_facture" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('factureNumero').value = data.numero;
            }
        });
    }

    function remplirFormulaire(facture) {
        document.getElementById('factureId').value = facture.id;
        document.getElementById('factureNumero').value = facture.numero;
        document.getElementById('factureDate').value = facture.date_emission;
        document.getElementById('factureEcheance').value = facture.date_echeance || '';
        document.getElementById('factureStatut').value = facture.statut;
        document.getElementById('factureClient').value = facture.client;
        document.getElementById('factureIFU').value = facture.ifu || '';
        document.getElementById('factureDossier').value = facture.dossier || '';
        document.getElementById('factureObservations').value = facture.observations || '';

        // Lignes
        document.getElementById('lignesFacture').innerHTML = '';
        if (facture.lignes && facture.lignes.length > 0) {
            facture.lignes.forEach((ligne, index) => {
                ajouterLigne(ligne);
            });
        } else {
            ajouterLigne();
        }
        calculerTotaux();
    }

    // ============================================
    // GESTION DES LIGNES
    // ============================================
    function ajouterLigne(data = null) {
        const container = document.getElementById('lignesFacture');
        const div = document.createElement('div');
        div.className = 'ligne-facture';
        div.dataset.index = ligneIndex++;

        div.innerHTML = `
            <div class="form-grid" style="grid-template-columns: 3fr 1fr 1fr 1fr auto;">
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input class="form-input ligne-description" type="text" placeholder="Ex: Commandement de payer" value="${data ? data.description : ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Quantite</label>
                    <input class="form-input ligne-quantite" type="number" value="${data ? data.quantite : 1}" min="1" onchange="calculerTotaux()" oninput="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label class="form-label">Prix unitaire</label>
                    <input class="form-input ligne-prix" type="number" placeholder="15000" value="${data ? data.prix_unitaire : ''}" onchange="calculerTotaux()" oninput="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label class="form-label">Total</label>
                    <input class="form-input ligne-total" type="text" readonly style="background: var(--neutral-100);" value="${data ? formatMontant(data.quantite * data.prix_unitaire) : ''}">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button type="button" class="btn btn-danger btn-icon" onclick="supprimerLigne(this)" style="margin-bottom: 6px;">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(div);
        lucide.createIcons();
        calculerTotaux();
    }

    function supprimerLigne(btn) {
        const lignes = document.querySelectorAll('.ligne-facture');
        if (lignes.length > 1) {
            btn.closest('.ligne-facture').remove();
            calculerTotaux();
        }
    }

    function calculerTotaux() {
        let totalHT = 0;
        document.querySelectorAll('.ligne-facture').forEach(ligne => {
            const qte = parseFloat(ligne.querySelector('.ligne-quantite').value) || 0;
            const prix = parseFloat(ligne.querySelector('.ligne-prix').value) || 0;
            const total = qte * prix;
            ligne.querySelector('.ligne-total').value = formatMontant(total);
            totalHT += total;
        });

        const tva = totalHT * 0.18;
        const ttc = totalHT + tva;

        document.getElementById('factureMontantHT').value = formatMontant(totalHT);
        document.getElementById('factureTVA').value = formatMontant(tva);
        document.getElementById('factureTTC').value = formatMontant(ttc);
    }

    function formatMontant(m) {
        return new Intl.NumberFormat('fr-FR').format(Math.round(m)) + ' FCFA';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        return d.toLocaleDateString('fr-FR');
    }

    // ============================================
    // SAUVEGARDE FACTURE
    // ============================================
    function sauvegarderFacture(event, brouillon = false) {
        event.preventDefault();

        // Collecter les lignes
        const lignes = [];
        document.querySelectorAll('.ligne-facture').forEach(ligne => {
            const description = ligne.querySelector('.ligne-description').value;
            const quantite = parseFloat(ligne.querySelector('.ligne-quantite').value) || 0;
            const prix = parseFloat(ligne.querySelector('.ligne-prix').value) || 0;
            if (description && prix > 0) {
                lignes.push({ description, quantite, prix_unitaire: prix });
            }
        });

        if (lignes.length === 0) {
            alert('Veuillez ajouter au moins une ligne a la facture');
            return;
        }

        const data = {
            id: document.getElementById('factureId').value || null,
            numero: document.getElementById('factureNumero').value,
            date_emission: document.getElementById('factureDate').value,
            date_echeance: document.getElementById('factureEcheance').value,
            statut: brouillon ? 'brouillon' : document.getElementById('factureStatut').value,
            client: document.getElementById('factureClient').value,
            ifu: document.getElementById('factureIFU').value,
            dossier: document.getElementById('factureDossier').value,
            observations: document.getElementById('factureObservations').value,
            lignes: lignes
        };

        fetch('{% url "gestion:api_sauvegarder_facture" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(brouillon ? 'Brouillon enregistre !' : 'Facture enregistree !');
                location.reload();
            } else {
                alert(result.error || 'Erreur lors de la sauvegarde');
            }
        })
        .catch(error => {
            alert('Erreur: ' + error.message);
        });
    }

    // ============================================
    // ACTIONS SUR LES FACTURES
    // ============================================
    function voirFacture(id) {
        const facture = factures.find(f => f.id == id);
        if (!facture) return;

        document.getElementById('modalFacture').style.display = 'none';
        document.getElementById('modalVoirFacture').style.display = 'flex';
        document.getElementById('modalOverlay').classList.add('open');

        document.getElementById('voirNumero').textContent = facture.numero;
        document.getElementById('voirNumeroDetail').textContent = facture.numero;
        document.getElementById('voirDate').textContent = formatDate(facture.date_emission);
        document.getElementById('voirEcheance').textContent = formatDate(facture.date_echeance);
        document.getElementById('voirClient').textContent = facture.client;
        document.getElementById('voirClientIFU').textContent = facture.ifu ? 'IFU: ' + facture.ifu : '';
        document.getElementById('voirHT').textContent = formatMontant(facture.montant_ht);
        document.getElementById('voirTVA').textContent = formatMontant(facture.tva);
        document.getElementById('voirTTC').textContent = formatMontant(facture.total);

        // Statut
        const statutEl = document.getElementById('voirStatut');
        const qrContainer = document.getElementById('voirQRCode');
        qrContainer.innerHTML = ''; // Nettoyer le QR code precedent

        if (facture.mecef_numero) {
            statutEl.textContent = 'NORMALISEE';
            statutEl.classList.add('normalisee');
            document.getElementById('voirMECeF').style.display = 'block';
            document.getElementById('voirMECeFNumero').textContent = facture.mecef_numero;
            document.getElementById('voirNIM').textContent = facture.nim || 'N/A';
            document.getElementById('voirDateMECeF').textContent = facture.date_mecef || '-';
            document.getElementById('voirMECeFMontant').textContent = formatMontant(facture.total);
            document.getElementById('btnNormaliserVue').style.display = 'none';

            // Generer le QR Code MECeF
            const qrData = `MECeF|NIM:${facture.nim || 'N/A'}|NUM:${facture.mecef_numero}|TTC:${Math.round(facture.total)}|DATE:${facture.date_mecef || '-'}|CLIENT:${facture.client}`;
            try {
                new QRCode(qrContainer, {
                    text: qrData,
                    width: 100,
                    height: 100,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch (e) {
                qrContainer.innerHTML = '<div style="text-align: center; color: var(--neutral-400); font-size: 10px;">QR Code</div>';
            }
        } else {
            statutEl.textContent = 'NON NORMALISEE';
            statutEl.classList.remove('normalisee');
            document.getElementById('voirMECeF').style.display = 'none';
            document.getElementById('btnNormaliserVue').style.display = 'inline-flex';
        }

        // Lignes
        const tbody = document.getElementById('voirLignes');
        tbody.innerHTML = '';
        if (facture.lignes && facture.lignes.length > 0) {
            facture.lignes.forEach(ligne => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${ligne.description}</td>
                    <td style="text-align: center;">${ligne.quantite}</td>
                    <td style="text-align: right;">${formatMontant(ligne.prix_unitaire)}</td>
                    <td style="text-align: right;">${formatMontant(ligne.quantite * ligne.prix_unitaire)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        factureEnCours = facture;
        lucide.createIcons();
    }

    function fermerModalVoir() {
        document.getElementById('modalOverlay').classList.remove('open');
        factureEnCours = null;
    }

    function modifierFacture(id) {
        const facture = factures.find(f => f.id == id);
        if (facture) {
            ouvrirModalFacture(facture);
        }
    }

    function supprimerFacture(id) {
        if (!confirm('Etes-vous sur de vouloir supprimer cette facture ?')) return;

        fetch('{% url "gestion:api_supprimer_facture" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert(result.error || 'Erreur lors de la suppression');
            }
        });
    }

    function imprimerFacture(id) {
        voirFacture(id);
        setTimeout(() => {
            imprimerFactureDirecte();
        }, 300);
    }

    function imprimerFactureDirecte() {
        const contenu = document.getElementById('facturePrint').innerHTML;
        const fenetre = window.open('', '_blank');
        fenetre.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Facture - ${factureEnCours ? factureEnCours.numero : ''}</title>
                <style>
                    /* ═══════════════════════════════════════════════════════════════
                       STYLES D'IMPRESSION POUR FACTURES PROFESSIONNELLES
                       ═══════════════════════════════════════════════════════════════ */

                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }

                    body {
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        background: white;
                        padding: 20px;
                        font-size: 12pt;
                        line-height: 1.4;
                        color: #333;
                    }

                    .invoice-paper {
                        max-width: 210mm;
                        margin: 0 auto;
                        background: white;
                        box-shadow: none;
                    }

                    /* En-tête */
                    .invoice-header {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 30px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #1e3a5f;
                    }

                    .invoice-logo {
                        width: 80px;
                        height: 80px;
                        background: linear-gradient(135deg, #b8960c 0%, #d4af37 100%) !important;
                        color: white !important;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        font-weight: bold;
                        border-radius: 8px;
                    }

                    .invoice-title {
                        font-size: 28px;
                        font-weight: bold;
                        color: #1e3a5f;
                        text-transform: uppercase;
                    }

                    .invoice-status {
                        display: inline-block;
                        padding: 6px 12px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: bold;
                        margin-top: 10px;
                    }

                    .invoice-status:contains("NON") {
                        border: 2px dashed #dc3545;
                        color: #dc3545;
                    }

                    /* Tableau des lignes */
                    .invoice-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 20px 0;
                    }

                    .invoice-table th {
                        background: #1e3a5f !important;
                        color: white !important;
                        padding: 12px 10px;
                        text-align: left;
                        font-weight: 600;
                        font-size: 11px;
                        text-transform: uppercase;
                    }

                    .invoice-table td {
                        padding: 10px;
                        border-bottom: 1px solid #e5e5e5;
                        font-size: 11px;
                    }

                    .invoice-table tr:nth-child(even) {
                        background: #f9f9f9 !important;
                    }

                    /* Totaux */
                    .invoice-total-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #e5e5e5;
                    }

                    .invoice-final-total {
                        background: #1e3a5f !important;
                        color: white !important;
                        padding: 12px !important;
                        margin-top: 10px;
                        border-radius: 4px;
                        font-weight: bold;
                        font-size: 14px;
                    }

                    /* Section MECeF */
                    #voirMECeF {
                        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%) !important;
                        border: 1px solid #22c55e !important;
                    }

                    /* Styles d'impression */
                    @media print {
                        body {
                            padding: 0;
                        }

                        @page {
                            size: A4;
                            margin: 15mm;
                        }

                        .invoice-paper {
                            page-break-inside: avoid;
                        }

                        .invoice-table,
                        tr {
                            page-break-inside: avoid;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-paper">${contenu}</div>
                <scr` + `ipt>
                    setTimeout(() => { window.print(); }, 500);
                <\/script>
            </body>
            </html>
        `);
        fenetre.document.close();
    }

    // ============================================
    // MECeF
    // ============================================
    function normaliserMECeF(id) {
        if (!confirm('Normaliser cette facture avec le systeme MECeF ?')) return;

        fetch('{% url "gestion:api_normaliser_mecef" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Facture normalisee avec succes !\nN MECeF: ' + result.mecef_numero);
                location.reload();
            } else {
                alert(result.error || 'Erreur lors de la normalisation');
            }
        });
    }

    function normaliserDepuisVue() {
        if (factureEnCours) {
            normaliserMECeF(factureEnCours.id);
        }
    }

    // ============================================
    // FILTRES ET EXPORT
    // ============================================
    function filtrerFactures() {
        const recherche = document.getElementById('rechercheFacture').value.toLowerCase();
        const statut = document.getElementById('filtreStatut').value;

        document.querySelectorAll('#factureListe tr').forEach(tr => {
            if (tr.id === 'emptyRow') return;
            const client = (tr.dataset.client || '').toLowerCase();
            const trStatut = tr.dataset.statut || '';

            const matchRecherche = !recherche || client.includes(recherche);
            const matchStatut = !statut || trStatut === statut;

            tr.style.display = matchRecherche && matchStatut ? '' : 'none';
        });
    }

    function exporterFactures() {
        window.open('{% url "gestion:api_exporter_factures" %}?format=csv', '_blank');
    }

    // ============================================
    // FORCER SCROLL MODAL - Solution radicale pour TOUS les modals
    // ============================================
    function forcerScrollModalElement(modalId) {
        var modal = document.getElementById(modalId);
        if (!modal) return;

        var modalBody = modal.querySelector('.modal-body');
        var modalFooter = modal.querySelector('.modal-footer');
        var form = modal.querySelector('form');

        modal.style.maxHeight = '90vh';
        modal.style.overflow = 'hidden';
        modal.style.display = 'flex';
        modal.style.flexDirection = 'column';

        if (form) {
            form.style.display = 'flex';
            form.style.flexDirection = 'column';
            form.style.flex = '1';
            form.style.overflow = 'hidden';
            form.style.maxHeight = 'calc(90vh - 60px)';
        }

        if (modalBody) {
            modalBody.style.flex = '1';
            modalBody.style.overflowY = 'auto';
            modalBody.style.maxHeight = 'calc(90vh - 140px)';
            modalBody.style.padding = '20px';
        }

        if (modalFooter) {
            modalFooter.style.flexShrink = '0';
            modalFooter.style.position = 'sticky';
            modalFooter.style.bottom = '0';
            modalFooter.style.background = 'white';
            modalFooter.style.zIndex = '10';
        }
    }

    function forcerScrollTousModals() {
        forcerScrollModalElement('modalFacture');
        forcerScrollModalElement('modalVoirFacture');
    }

    // Appliquer au chargement
    document.addEventListener('DOMContentLoaded', forcerScrollTousModals);

    // Observer les changements sur les modals
    ['modalFacture', 'modalVoirFacture'].forEach(function(modalId) {
        var modalEl = document.getElementById(modalId);
        if (modalEl) {
            var observer = new MutationObserver(function() {
                forcerScrollModalElement(modalId);
            });
            observer.observe(modalEl, { attributes: true, childList: true, subtree: true });
        }
    });

    // Surcharger ouvrirModalFacture pour forcer le scroll
    var _ouvrirModalFactureOriginal = ouvrirModalFacture;
    ouvrirModalFacture = function(facture) {
        _ouvrirModalFactureOriginal(facture);
        setTimeout(function() { forcerScrollModalElement('modalFacture'); }, 100);
        setTimeout(function() { forcerScrollModalElement('modalFacture'); }, 300);
    };

    // Surcharger voirFacture pour forcer le scroll
    var _voirFactureOriginal = voirFacture;
    voirFacture = function(facture) {
        _voirFactureOriginal(facture);
        setTimeout(function() { forcerScrollModalElement('modalVoirFacture'); }, 100);
        setTimeout(function() { forcerScrollModalElement('modalVoirFacture'); }, 300);
    };
</script>
{% endblock %}
