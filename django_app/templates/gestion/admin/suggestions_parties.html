{% extends 'base.html' %}
{% load static %}

{% block title %}Suggestions de normalisation des parties{% endblock %}

{% block content %}
<div class="p-6">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Harmonisation des parties</h1>
        <p class="text-gray-500">Revue et validation des suggestions de normalisation</p>
    </div>

    <!-- Statistiques -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-gray-500 text-sm">Total parties</p>
            <p class="text-2xl font-bold">{{ stats.total_parties }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-gray-500 text-sm">Personnes morales</p>
            <p class="text-2xl font-bold">{{ stats.personnes_morales }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-gray-500 text-sm">Corrections suggérées</p>
            <p class="text-2xl font-bold text-amber-600">{{ stats.suggestions_correction }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-gray-500 text-sm">Doublons potentiels</p>
            <p class="text-2xl font-bold text-red-600">{{ stats.groupes_doublons }}</p>
        </div>
    </div>

    <!-- Onglets -->
    <div class="mb-4">
        <button onclick="afficherOnglet('corrections')" id="btn-corrections" class="px-4 py-2 bg-blue-600 text-white rounded-t-lg">
            Corrections suggérées ({{ stats.suggestions_correction }})
        </button>
        <button onclick="afficherOnglet('doublons')" id="btn-doublons" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-t-lg ml-1">
            Doublons potentiels ({{ stats.groupes_doublons }})
        </button>
    </div>

    <!-- Onglet Corrections -->
    <div id="onglet-corrections" class="bg-white rounded-lg shadow">
        <div class="p-4 border-b">
            <h3 class="font-semibold">Suggestions de normalisation</h3>
            <p class="text-sm text-gray-500">Cliquez sur "Appliquer" pour valider une correction</p>
        </div>

        {% if suggestions %}
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left">ID</th>
                    <th class="px-4 py-3 text-left">Nom actuel</th>
                    <th class="px-4 py-3 text-left">Nom suggéré</th>
                    <th class="px-4 py-3 text-left">Forme</th>
                    <th class="px-4 py-3 text-left">Modifications</th>
                    <th class="px-4 py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in suggestions %}
                <tr class="border-b hover:bg-gray-50" id="row-{{ item.partie.pk }}">
                    <td class="px-4 py-3 text-gray-500">{{ item.partie.pk }}</td>
                    <td class="px-4 py-3">
                        <span class="text-red-600 line-through">{{ item.suggestion.nom_original }}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-green-600 font-medium">{{ item.suggestion.nom_suggere }}</span>
                    </td>
                    <td class="px-4 py-3">
                        {% if item.suggestion.forme_juridique_detectee %}
                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-sm">
                            {{ item.suggestion.forme_juridique_detectee }}
                        </span>
                        {% elif item.partie.forme_juridique %}
                        <span class="text-gray-500">{{ item.partie.forme_juridique }}</span>
                        {% else %}
                        <span class="text-gray-300">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        <ul class="list-disc list-inside">
                        {% for modif in item.suggestion.modifications %}
                            <li>{{ modif }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="appliquerSuggestion({{ item.partie.pk }}, '{{ item.suggestion.nom_suggere|escapejs }}', '{{ item.suggestion.forme_juridique_detectee|default_if_none:""|escapejs }}')"
                                class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                            <i class="fas fa-check mr-1"></i>Appliquer
                        </button>
                        <button onclick="ignorerSuggestion({{ item.partie.pk }})"
                                class="px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 text-sm ml-1">
                            Ignorer
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="p-8 text-center text-gray-400">
            <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
            <p>Aucune correction suggérée - Toutes les parties sont bien formatées !</p>
        </div>
        {% endif %}
    </div>

    <!-- Onglet Doublons -->
    <div id="onglet-doublons" class="bg-white rounded-lg shadow" style="display: none;">
        <div class="p-4 border-b">
            <h3 class="font-semibold">Doublons potentiels</h3>
            <p class="text-sm text-gray-500">Parties qui semblent être des enregistrements en double</p>
        </div>

        {% if doublons %}
        <div class="p-4 space-y-4">
            {% for groupe in doublons %}
            <div class="border rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-lg">
                        {{ groupe.reference.raison_sociale|default:groupe.reference.nom }}
                    </h4>
                    <span class="bg-amber-100 text-amber-700 px-2 py-1 rounded text-sm">
                        {{ groupe.similaires|length|add:1 }} enregistrements similaires
                    </span>
                </div>

                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left">ID</th>
                            <th class="px-3 py-2 text-left">Nom</th>
                            <th class="px-3 py-2 text-left">Forme</th>
                            <th class="px-3 py-2 text-center">Similarité</th>
                            <th class="px-3 py-2 text-center">Dossiers</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b bg-green-50">
                            <td class="px-3 py-2">{{ groupe.reference.pk }}</td>
                            <td class="px-3 py-2 font-medium">
                                {{ groupe.reference.raison_sociale|default:groupe.reference.nom }}
                                <span class="text-green-600 text-xs ml-2">(référence)</span>
                            </td>
                            <td class="px-3 py-2">{{ groupe.reference.forme_juridique|default:"-" }}</td>
                            <td class="px-3 py-2 text-center">100%</td>
                            <td class="px-3 py-2 text-center">
                                {{ groupe.reference.dossiers_demandeur.count|add:groupe.reference.dossiers_defendeur.count }}
                            </td>
                        </tr>
                        {% for sim in groupe.similaires %}
                        <tr class="border-b">
                            <td class="px-3 py-2">{{ sim.partie.pk }}</td>
                            <td class="px-3 py-2">{{ sim.partie.raison_sociale|default:sim.partie.nom }}</td>
                            <td class="px-3 py-2">{{ sim.partie.forme_juridique|default:"-" }}</td>
                            <td class="px-3 py-2 text-center">
                                <span class="{% if sim.score >= 0.95 %}text-red-600{% elif sim.score >= 0.90 %}text-amber-600{% else %}text-gray-600{% endif %}">
                                    {{ sim.score|floatformat:0 }}%
                                </span>
                            </td>
                            <td class="px-3 py-2 text-center">
                                {{ sim.partie.dossiers_demandeur.count|add:sim.partie.dossiers_defendeur.count }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="mt-3 text-right">
                    <span class="text-gray-400 text-sm">Fusion manuelle requise dans l'admin Django</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="p-8 text-center text-gray-400">
            <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
            <p>Aucun doublon détecté !</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function afficherOnglet(onglet) {
    document.getElementById('onglet-corrections').style.display = onglet === 'corrections' ? 'block' : 'none';
    document.getElementById('onglet-doublons').style.display = onglet === 'doublons' ? 'block' : 'none';

    document.getElementById('btn-corrections').className = onglet === 'corrections'
        ? 'px-4 py-2 bg-blue-600 text-white rounded-t-lg'
        : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-t-lg';
    document.getElementById('btn-doublons').className = onglet === 'doublons'
        ? 'px-4 py-2 bg-blue-600 text-white rounded-t-lg ml-1'
        : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-t-lg ml-1';
}

function appliquerSuggestion(partieId, nouveauNom, nouvelleForme) {
    if (!confirm('Appliquer cette correction ?')) return;

    fetch(`/gestion/admin/appliquer-suggestion/${partieId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}'
        },
        body: `nouveau_nom=${encodeURIComponent(nouveauNom)}&nouvelle_forme=${encodeURIComponent(nouvelleForme)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`row-${partieId}`).remove();
            alert('Correction appliquée !');
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(err => alert('Erreur: ' + err));
}

function ignorerSuggestion(partieId) {
    document.getElementById(`row-${partieId}`).remove();
}
</script>

{% csrf_token %}
{% endblock %}
