{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="space-y-6">
    <!-- Mode Toggle & History -->
    <div class="flex justify-between items-center flex-wrap gap-4">
        <div class="toggle-group">
            <div class="toggle-option active" id="modeComplet" onclick="setMode('complet')">Calcul Complet</div>
            <div class="toggle-option" id="modeEmoluments" onclick="setMode('emoluments')">Emoluments Seuls</div>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="toggleHistorique()">
                <i data-lucide="history"></i> Historique
            </button>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="two-col-layout">
        <!-- Parameters Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Parametres</h3>
            </div>
            <div class="card-body">
                <!-- Complet Mode -->
                <div id="completForm">
                    <!-- Stepper -->
                    <div class="stepper" id="stepper">
                        <div class="step active" data-step="1">
                            <div class="step-circle">1</div>
                            <div class="step-label">Principal</div>
                            <div class="step-line"></div>
                        </div>
                        <div class="step pending" data-step="2">
                            <div class="step-circle">2</div>
                            <div class="step-label">Taux</div>
                            <div class="step-line"></div>
                        </div>
                        <div class="step pending" data-step="3">
                            <div class="step-circle">3</div>
                            <div class="step-label">Dates</div>
                            <div class="step-line"></div>
                        </div>
                        <div class="step pending" data-step="4">
                            <div class="step-circle">4</div>
                            <div class="step-label">Options</div>
                        </div>
                    </div>

                    <!-- Step 1: Principal -->
                    <div class="step-content" id="step1">
                        <div class="form-group">
                            <label class="form-label">Montant principal (FCFA) <span style="color: var(--danger);">*</span></label>
                            <input class="form-input" type="number" id="montantPrincipal" placeholder="Ex: 1000000" min="1">
                            <small style="color: var(--neutral-500);">Le montant de la creance en FCFA</small>
                        </div>
                    </div>

                    <!-- Step 2: Taux -->
                    <div class="step-content" id="step2" style="display: none;">
                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Type de Taux</label>
                                <select class="form-select" id="typeTaux" onchange="toggleTauxConventionnel()">
                                    <option value="legal">Legal (UEMOA/BCEAO)</option>
                                    <option value="cima">CIMA (Assurance - 5%/mois)</option>
                                    <option value="conventionnel">Conventionnel</option>
                                </select>
                            </div>
                            <div class="form-group" id="tauxConventionnelGroup" style="display: none;">
                                <label class="form-label">Taux annuel (%)</label>
                                <input class="form-input" type="number" id="tauxConventionnel" step="0.01" placeholder="Ex: 12">
                            </div>
                            <div class="alert alert-info" id="tauxInfo">
                                <i data-lucide="info" style="width: 18px; height: 18px;"></i>
                                <div>
                                    <strong>Taux legaux UEMOA:</strong><br>
                                    2024: 5.0336% | 2025: 5.5000%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Dates -->
                    <div class="step-content" id="step3" style="display: none;">
                        <div class="space-y-4">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Date Creance (Dies a quo) <span style="color: var(--danger);">*</span></label>
                                    <input class="form-input" type="date" id="dateCreance">
                                    <small style="color: var(--neutral-500);">Date de naissance de la creance</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date Saisie (Dies ad quem) <span style="color: var(--danger);">*</span></label>
                                    <input class="form-input" type="date" id="dateSaisie">
                                    <small style="color: var(--neutral-500);">Date de la saisie ou calcul</small>
                                </div>
                            </div>
                            <div class="majoration-box">
                                <label class="majoration-label">
                                    <input type="checkbox" id="appliquerMajoration" onchange="toggleMajoration()">
                                    Appliquer Majoration +50% (Loi 2024)
                                </label>
                                <small style="display: block; margin-top: 4px; color: var(--neutral-600);">
                                    Majoration de 50% du taux apres 60 jours de la decision de justice
                                </small>
                                <div id="majorationDate" style="display: none; margin-top: 12px;">
                                    <label class="form-label">Date de la decision de justice</label>
                                    <input class="form-input" type="date" id="dateDecisionJustice">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Options -->
                    <div class="step-content" id="step4" style="display: none;">
                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Type de Calcul</label>
                                <select class="form-select" id="typeCalcul">
                                    <option value="simple">Interets Simples</option>
                                    <option value="compose">Interets Composes</option>
                                </select>
                            </div>
                            <div class="options-section">
                                <label class="options-label">
                                    <input type="checkbox" id="calculerEmoluments" onchange="toggleEmoluments()">
                                    Ajouter Emoluments Proportionnels
                                </label>
                                <div id="emolumentsOptions" style="display: none;" class="options-content mt-2">
                                    <div class="form-group">
                                        <label class="form-label">Titre Executoire</label>
                                        <select class="form-select" id="typeTitre">
                                            <option value="sans">Sans titre executoire</option>
                                            <option value="avec">Avec titre executoire</option>
                                        </select>
                                    </div>
                                    <div class="form-group mt-2">
                                        <label class="form-label">Frais de Justice (optionnel)</label>
                                        <input class="form-input" type="number" id="fraisJustice" placeholder="0">
                                    </div>

                                    <!-- Actes de procedure -->
                                    <div class="form-group mt-4">
                                        <label class="options-label">
                                            <input type="checkbox" id="calculerActes" onchange="toggleActes()">
                                            Ajouter couts des actes de procedure
                                        </label>
                                        <div id="actesBox" style="display: none;" class="actes-box mt-2">
                                            <div id="actesList"></div>
                                            <select class="form-select mb-2" id="catalogueActes" onchange="selectActe()">
                                                <option value="">-- Catalogue des actes --</option>
                                                {% for acte in catalogue_actes %}
                                                <option value="{{ acte.id }}" data-label="{{ acte.label }}" data-tarif="{{ acte.tarif }}">
                                                    {{ acte.label }} ({{ acte.tarif|floatformat:0 }} F)
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="flex gap-2">
                                                <input class="form-input" id="acteLibelle" placeholder="Libelle de l'acte" style="flex: 1;">
                                                <input class="form-input" id="acteMontant" type="number" placeholder="Cout" style="width: 100px;">
                                            </div>
                                            <button type="button" class="btn btn-sm btn-secondary w-full mt-2" onclick="addActe()">
                                                <i data-lucide="plus"></i> Ajouter l'acte
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex gap-2 mt-6">
                        <button class="btn btn-secondary" id="prevBtn" style="flex: 1; display: none;" onclick="prevStep()">
                            <i data-lucide="arrow-left"></i> Precedent
                        </button>
                        <button class="btn btn-primary" id="nextBtn" style="flex: 1;" onclick="nextStep()">
                            Suivant <i data-lucide="arrow-right"></i>
                        </button>
                        <button class="btn btn-success" id="calcBtn" style="flex: 1; display: none;" onclick="calculer()">
                            <i data-lucide="calculator"></i> Calculer
                        </button>
                    </div>
                </div>

                <!-- Emoluments Mode -->
                <div id="emolumentsForm" style="display: none;">
                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="form-label">Base de Calcul (FCFA) <span style="color: var(--danger);">*</span></label>
                            <input class="form-input" type="number" id="baseEmoluments" placeholder="Ex: 5000000">
                            <small style="color: var(--neutral-500);">Principal + interets</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Type de Titre</label>
                            <select class="form-select" id="typeTitreEmol">
                                <option value="sans">Sans titre executoire</option>
                                <option value="avec">Avec titre executoire</option>
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <i data-lucide="info" style="width: 18px; height: 18px;"></i>
                            <div>
                                <strong>Baremes des emoluments:</strong><br>
                                Sans titre: 10% (0-5M), 8% (5-20M), 6% (20-50M), 4% (+50M)<br>
                                Avec titre: 10% (0-5M), 3.5% (5-20M), 2% (20-50M), 1% (+50M)
                            </div>
                        </div>
                        <button class="btn btn-primary w-full mt-4" onclick="calculerEmolumentsSeuls()">
                            <i data-lucide="calculator"></i> Calculer les emoluments
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div>
            <div class="card" id="resultsCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">Resultats du Calcul</h3>
                    <div class="flex gap-2 flex-wrap">
                        <input class="form-input" style="padding: 6px 10px; width: 150px;" placeholder="Nom du calcul" id="nomCalcul">
                        <button class="btn btn-secondary btn-sm" onclick="saveCalcul()">
                            <i data-lucide="save"></i> Sauvegarder
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="exporterPDF()" title="Exporter en PDF">
                                <i data-lucide="file-text"></i> PDF
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exporterExcel()" title="Exporter en Excel">
                                <i data-lucide="file-spreadsheet"></i> Excel
                            </button>
                            <button class="btn btn-accent btn-sm" onclick="copyText()" title="Copier le texte formate">
                                <i data-lucide="clipboard-copy"></i> Copier
                            </button>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="imprimerDecompte()">
                            <i data-lucide="printer"></i> Imprimer
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-4 gap-4 mb-6" id="resultSummary">
                        <!-- Results will be inserted here -->
                    </div>
                    <div class="text-output" id="resultText">
                        <!-- Detailed text will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="card calc-box" id="emptyState">
                <i data-lucide="calculator"></i>
                <p>Configurez les parametres et lancez le calcul</p>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="modal-overlay" id="historiqueOverlay" onclick="if(event.target===this)toggleHistorique()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Historique des Calculs</h3>
            <button class="modal-close" onclick="toggleHistorique()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="historiqueList" style="text-align: center; color: var(--neutral-500);">
                <p>Chargement...</p>
            </div>
        </div>
    </div>
</div>

<!-- Print Template (hidden) -->
<div id="printTemplate" style="display: none;">
    <div class="decompte-print">
        <div class="decompte-header">
            <div class="decompte-logo">MAB</div>
            <div>
                <h1>DECOMPTE DE CREANCE</h1>
                <p>Etude Me BIAOU Martial Arnaud - Huissier de Justice</p>
            </div>
        </div>
        <div class="decompte-content" id="printContent">
            <!-- Content will be inserted here -->
        </div>
        <div class="decompte-footer">
            <p>Document genere le <span id="printDate"></span></p>
            <p>Etude Me BIAOU - Cotonou, Benin</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    lucide.createIcons();

    // State
    let currentStep = 1;
    let mode = 'complet';
    let actes = [];
    let historique = {{ historique|safe }};
    let resultats = null;
    let donneesCalcul = null;

    // Taux legaux UEMOA
    const tauxLegaux = {{ taux_legaux|safe }};

    function setMode(newMode) {
        mode = newMode;
        document.getElementById('modeComplet').classList.toggle('active', mode === 'complet');
        document.getElementById('modeEmoluments').classList.toggle('active', mode === 'emoluments');
        document.getElementById('completForm').style.display = mode === 'complet' ? 'block' : 'none';
        document.getElementById('emolumentsForm').style.display = mode === 'emoluments' ? 'block' : 'none';
        if (mode === 'complet') {
            currentStep = 1;
            updateStepper();
        }
    }

    function updateStepper() {
        const steps = document.querySelectorAll('.step');
        steps.forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('completed', 'active', 'pending');
            if (stepNum < currentStep) {
                step.classList.add('completed');
                step.querySelector('.step-circle').innerHTML = '<i data-lucide="check" style="width:18px;height:18px;"></i>';
            } else if (stepNum === currentStep) {
                step.classList.add('active');
                step.querySelector('.step-circle').textContent = stepNum;
            } else {
                step.classList.add('pending');
                step.querySelector('.step-circle').textContent = stepNum;
            }
        });

        // Show/hide step content
        for (let i = 1; i <= 4; i++) {
            document.getElementById('step' + i).style.display = i === currentStep ? 'block' : 'none';
        }

        // Update buttons
        document.getElementById('prevBtn').style.display = currentStep > 1 ? 'flex' : 'none';
        document.getElementById('nextBtn').style.display = currentStep < 4 ? 'flex' : 'none';
        document.getElementById('calcBtn').style.display = currentStep === 4 ? 'flex' : 'none';

        lucide.createIcons();
    }

    function validateStep(step) {
        if (step === 1) {
            const montant = parseFloat(document.getElementById('montantPrincipal').value);
            if (!montant || montant <= 0) {
                alert('Veuillez saisir un montant principal valide');
                return false;
            }
        } else if (step === 3) {
            const dateCreance = document.getElementById('dateCreance').value;
            const dateSaisie = document.getElementById('dateSaisie').value;
            if (!dateCreance || !dateSaisie) {
                alert('Veuillez saisir les deux dates');
                return false;
            }
            if (new Date(dateSaisie) <= new Date(dateCreance)) {
                alert('La date de saisie doit etre posterieure a la date de creance');
                return false;
            }
        }
        return true;
    }

    function nextStep() {
        if (!validateStep(currentStep)) return;
        if (currentStep < 4) {
            currentStep++;
            updateStepper();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepper();
        }
    }

    function toggleTauxConventionnel() {
        const typeTaux = document.getElementById('typeTaux').value;
        document.getElementById('tauxConventionnelGroup').style.display = typeTaux === 'conventionnel' ? 'block' : 'none';

        // Update info
        const info = document.getElementById('tauxInfo');
        if (typeTaux === 'cima') {
            info.innerHTML = '<i data-lucide="info" style="width: 18px; height: 18px;"></i><div><strong>Taux CIMA:</strong><br>5% par mois soit 60% par an</div>';
        } else if (typeTaux === 'legal') {
            info.innerHTML = '<i data-lucide="info" style="width: 18px; height: 18px;"></i><div><strong>Taux legaux UEMOA:</strong><br>2024: 5.0336% | 2025: 5.5000%</div>';
        } else {
            info.innerHTML = '<i data-lucide="info" style="width: 18px; height: 18px;"></i><div><strong>Taux conventionnel:</strong><br>Saisissez le taux annuel convenu entre les parties</div>';
        }
        lucide.createIcons();
    }

    function toggleMajoration() {
        const checked = document.getElementById('appliquerMajoration').checked;
        document.getElementById('majorationDate').style.display = checked ? 'block' : 'none';
    }

    function toggleEmoluments() {
        const checked = document.getElementById('calculerEmoluments').checked;
        document.getElementById('emolumentsOptions').style.display = checked ? 'block' : 'none';
    }

    function toggleActes() {
        const checked = document.getElementById('calculerActes').checked;
        document.getElementById('actesBox').style.display = checked ? 'block' : 'none';
    }

    function selectActe() {
        const select = document.getElementById('catalogueActes');
        const option = select.options[select.selectedIndex];
        if (option.value) {
            document.getElementById('acteLibelle').value = option.dataset.label;
            document.getElementById('acteMontant').value = option.dataset.tarif;
        }
        select.value = '';
    }

    function addActe() {
        const libelle = document.getElementById('acteLibelle').value.trim();
        const montant = parseFloat(document.getElementById('acteMontant').value);
        if (libelle && montant > 0) {
            actes.push({ id: Date.now(), libelle, montant });
            document.getElementById('acteLibelle').value = '';
            document.getElementById('acteMontant').value = '';
            renderActes();
        } else {
            alert('Veuillez saisir un libelle et un montant valide');
        }
    }

    function removeActe(id) {
        actes = actes.filter(a => a.id !== id);
        renderActes();
    }

    function renderActes() {
        const container = document.getElementById('actesList');
        if (actes.length === 0) {
            container.innerHTML = '';
            return;
        }
        let html = '';
        let total = 0;
        actes.forEach(acte => {
            total += acte.montant;
            html += `
                <div class="acte-item">
                    <span class="acte-label">${acte.libelle}</span>
                    <div class="flex items-center gap-2">
                        <span class="acte-amount">${formatMontant(acte.montant)}</span>
                        <button onclick="removeActe(${acte.id})" style="background:none;border:none;color:var(--danger);cursor:pointer;">
                            <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        html += `
            <div class="actes-total">
                <span>TOTAL ACTES</span>
                <span style="color:var(--primary);">${formatMontant(total)}</span>
            </div>
        `;
        container.innerHTML = html;
        lucide.createIcons();
    }

    function formatMontant(m) {
        return new Intl.NumberFormat('fr-FR').format(Math.round(m)) + ' FCFA';
    }

    function calculer() {
        if (!validateStep(currentStep)) return;

        donneesCalcul = {
            montant_principal: parseFloat(document.getElementById('montantPrincipal').value) || 0,
            date_creance: document.getElementById('dateCreance').value,
            date_saisie: document.getElementById('dateSaisie').value,
            type_taux: document.getElementById('typeTaux').value,
            taux_conventionnel: parseFloat(document.getElementById('tauxConventionnel').value) || 0,
            type_calcul: document.getElementById('typeCalcul').value,
            appliquer_majoration: document.getElementById('appliquerMajoration').checked,
            date_decision: document.getElementById('dateDecisionJustice').value,
            calculer_emoluments: document.getElementById('calculerEmoluments').checked,
            type_titre: document.getElementById('typeTitre').value,
            frais_justice: parseFloat(document.getElementById('fraisJustice').value) || 0,
            actes: actes,
            arrondir: true
        };

        fetch('{% url "gestion:api_calculer_interets" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(donneesCalcul)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultats = data.resultats;
                displayResults(resultats);
            } else {
                alert(data.error || 'Erreur de calcul');
            }
        })
        .catch(error => {
            alert('Erreur: ' + error.message);
        });
    }

    function calculerEmolumentsSeuls() {
        const base = parseFloat(document.getElementById('baseEmoluments').value);
        if (!base || base <= 0) {
            alert('Veuillez saisir une base de calcul valide');
            return;
        }

        donneesCalcul = {
            base: base,
            type_titre: document.getElementById('typeTitreEmol').value,
            arrondir: true
        };

        fetch('{% url "gestion:api_calculer_emoluments" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(donneesCalcul)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultats = data.resultats;
                displayResults(resultats);
            } else {
                alert(data.error || 'Erreur de calcul');
            }
        })
        .catch(error => {
            alert('Erreur: ' + error.message);
        });
    }

    function displayResults(res) {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('resultsCard').style.display = 'block';

        // Summary cards
        let summaryHtml = '';
        if (res.mode === 'emoluments') {
            summaryHtml = `
                <div class="result-card info">
                    <div class="result-label">Base</div>
                    <div class="result-value">${formatMontant(res.base)}</div>
                </div>
                <div class="result-card success">
                    <div class="result-label">Emoluments</div>
                    <div class="result-value">${formatMontant(res.emoluments.total)}</div>
                </div>
                <div class="result-card primary" style="grid-column: span 2;">
                    <div class="result-label">TOTAL</div>
                    <div class="result-value">${formatMontant(res.total)}</div>
                </div>
            `;
        } else {
            summaryHtml = `
                <div class="result-card info">
                    <div class="result-label">Principal</div>
                    <div class="result-value">${formatMontant(res.principal)}</div>
                </div>
                <div class="result-card success">
                    <div class="result-label">Interets echus</div>
                    <div class="result-value">${formatMontant(res.interets_echus.total)}</div>
                </div>
            `;
            if (res.emoluments) {
                summaryHtml += `
                    <div class="result-card purple">
                        <div class="result-label">Emoluments</div>
                        <div class="result-value">${formatMontant(res.emoluments.total)}</div>
                    </div>
                `;
            }
            if (res.frais_justice > 0) {
                summaryHtml += `
                    <div class="result-card info">
                        <div class="result-label">Frais Justice</div>
                        <div class="result-value">${formatMontant(res.frais_justice)}</div>
                    </div>
                `;
            }
            summaryHtml += `
                <div class="result-card primary">
                    <div class="result-label">TOTAL</div>
                    <div class="result-value">${formatMontant(res.total)}</div>
                </div>
            `;
        }
        document.getElementById('resultSummary').innerHTML = summaryHtml;

        // Detailed text
        document.getElementById('resultText').textContent = generateText(res);
    }

    function generateText(res) {
        if (res.mode === 'emoluments') {
            let text = `CALCUL D'EMOLUMENTS PROPORTIONNELS\n`;
            text += `===================================\n\n`;
            text += `Base de calcul: ${formatMontant(res.base)}\n`;
            text += `Type: ${res.type_titre === 'avec' ? 'Avec titre executoire' : 'Sans titre executoire'}\n\n`;

            if (res.emoluments.details) {
                text += `Detail par tranche:\n`;
                res.emoluments.details.forEach(d => {
                    text += `  - ${d.tranche}: ${d.taux}% = ${formatMontant(d.emolument)}\n`;
                });
            }

            text += `\nEmoluments: ${formatMontant(res.emoluments.total)}\n`;
            text += `\n===================================\n`;
            text += `TOTAL: ${formatMontant(res.total)}`;
            return text;
        }

        let text = `DECOMPTE DE CREANCE OHADA\n`;
        text += `===================================\n\n`;

        text += `I. PRINCIPAL\n`;
        text += `   Montant principal: ${formatMontant(res.principal)}\n\n`;

        text += `II. INTERETS ECHUS\n`;
        text += `    Periode: du ${res.date_debut} au ${res.date_fin}\n`;
        text += `    Type: ${res.type_calcul === 'compose' ? 'Interets composes' : 'Interets simples'}\n\n`;

        if (res.interets_echus.periodes && res.interets_echus.periodes.length > 0) {
            res.interets_echus.periodes.forEach(p => {
                let tauxInfo = `${p.taux.toFixed(4)}%`;
                if (p.majore) tauxInfo += ' (majore +50%)';
                text += `    ${p.annee}: ${p.jours} jours a ${tauxInfo} = ${formatMontant(p.interet)}\n`;
            });
        }
        text += `    SOUS-TOTAL INTERETS ECHUS: ${formatMontant(res.interets_echus.total)}\n\n`;

        if (res.majoration && res.date_limite_majoration) {
            text += `    *** MAJORATION LOI 2024 APPLIQUEE ***\n`;
            text += `    Taux majore de 50% apres le ${res.date_limite_majoration}\n\n`;
        }

        text += `III. INTERETS A ECHOIR (1 mois)\n`;
        text += `     ${formatMontant(res.interets_echoir.total)}\n\n`;

        if (res.frais_justice > 0) {
            text += `IV. FRAIS DE JUSTICE\n`;
            text += `    ${formatMontant(res.frais_justice)}\n\n`;
        }

        if (res.emoluments) {
            text += `V. EMOLUMENTS PROPORTIONNELS\n`;
            text += `   Base: ${formatMontant(res.base_emoluments)}\n`;
            text += `   Type: ${res.emoluments.type_titre === 'avec' ? 'Avec titre' : 'Sans titre'}\n`;
            text += `   Emoluments: ${formatMontant(res.emoluments.total)}\n\n`;
        }

        if (res.actes > 0) {
            text += `VI. COUTS DES ACTES DE PROCEDURE\n`;
            actes.forEach(a => {
                text += `    - ${a.libelle}: ${formatMontant(a.montant)}\n`;
            });
            text += `    TOTAL ACTES: ${formatMontant(res.actes)}\n\n`;
        }

        text += `===================================\n`;
        text += `TOTAL GENERAL: ${formatMontant(res.total)}\n`;
        text += `===================================\n`;

        return text;
    }

    function copyText() {
        const text = document.getElementById('resultText').textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert('Decompte copie dans le presse-papiers !');
        });
    }

    function saveCalcul() {
        if (!resultats) {
            alert('Aucun calcul a sauvegarder');
            return;
        }

        const nom = document.getElementById('nomCalcul').value.trim() || `Calcul du ${new Date().toLocaleString('fr-FR')}`;

        fetch('{% url "gestion:api_sauvegarder_calcul" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                nom: nom,
                mode: resultats.mode,
                donnees: donneesCalcul,
                resultats: resultats,
                total: resultats.total
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('nomCalcul').value = '';
                // Ajouter a l'historique local
                historique.unshift({
                    id: data.id,
                    nom: nom,
                    mode: resultats.mode,
                    total: resultats.total,
                    date: new Date().toLocaleString('fr-FR'),
                    resultats: resultats
                });
                alert('Calcul sauvegarde avec succes !');
            } else {
                alert(data.error || 'Erreur lors de la sauvegarde');
            }
        })
        .catch(error => {
            alert('Erreur: ' + error.message);
        });
    }

    function toggleHistorique() {
        const overlay = document.getElementById('historiqueOverlay');
        overlay.classList.toggle('open');

        if (overlay.classList.contains('open')) {
            renderHistorique();
        }
    }

    function renderHistorique() {
        const container = document.getElementById('historiqueList');

        if (historique.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--neutral-500);padding:40px;">Aucun historique de calcul.</p>';
            return;
        }

        let html = '<table style="width:100%;"><thead><tr><th>Nom</th><th>Mode</th><th>Total</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
        historique.forEach(h => {
            html += `
                <tr>
                    <td style="font-weight:500;">${h.nom}</td>
                    <td><span class="status-badge ${h.mode === 'complet' ? 'active' : 'contentieux'}">${h.mode === 'complet' ? 'Complet' : 'Emoluments'}</span></td>
                    <td style="font-weight:700;">${formatMontant(h.total)}</td>
                    <td style="color:var(--neutral-500);font-size:12px;">${h.date}</td>
                    <td>
                        <div class="flex gap-1">
                            <button class="icon-btn" title="Charger" onclick="chargerCalcul(${h.id})">
                                <i data-lucide="upload"></i>
                            </button>
                            <button class="icon-btn" title="Supprimer" onclick="supprimerCalcul(${h.id})" style="color:var(--danger);">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        lucide.createIcons();
    }

    function chargerCalcul(id) {
        const calcul = historique.find(h => h.id === id);
        if (calcul && calcul.resultats) {
            resultats = calcul.resultats;
            donneesCalcul = calcul.donnees || {};

            // Restaurer les donnees du formulaire si disponibles
            if (calcul.donnees) {
                const d = calcul.donnees;
                if (d.montant_principal) document.getElementById('montantPrincipal').value = d.montant_principal;
                if (d.date_creance) document.getElementById('dateCreance').value = d.date_creance;
                if (d.date_saisie) document.getElementById('dateSaisie').value = d.date_saisie;
                if (d.type_taux) document.getElementById('typeTaux').value = d.type_taux;
                if (d.type_calcul) document.getElementById('typeCalcul').value = d.type_calcul;
                if (d.appliquer_majoration !== undefined) {
                    document.getElementById('appliquerMajoration').checked = d.appliquer_majoration;
                    toggleMajoration();
                }
                if (d.date_decision) document.getElementById('dateDecisionJustice').value = d.date_decision;
                if (d.calculer_emoluments !== undefined) {
                    document.getElementById('calculerEmoluments').checked = d.calculer_emoluments;
                    toggleEmoluments();
                }
                if (d.type_titre) document.getElementById('typeTitre').value = d.type_titre;
                if (d.frais_justice) document.getElementById('fraisJustice').value = d.frais_justice;
                if (d.actes && Array.isArray(d.actes)) {
                    actes = d.actes;
                    renderActes();
                }
                // Passer au mode correspondant
                setMode(resultats.mode === 'emoluments' ? 'emoluments' : 'complet');
                if (d.base) document.getElementById('baseEmoluments').value = d.base;
            }

            displayResults(resultats);
            toggleHistorique();
        }
    }

    function supprimerCalcul(id) {
        if (!confirm('Supprimer ce calcul de l\'historique ?')) return;

        fetch('{% url "gestion:api_supprimer_calcul" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                historique = historique.filter(h => h.id !== id);
                renderHistorique();
            } else {
                alert(data.error || 'Erreur lors de la suppression');
            }
        });
    }

    function imprimerDecompte() {
        if (!resultats) return;

        const content = document.getElementById('resultText').textContent;
        const now = new Date().toLocaleString('fr-FR');

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Decompte de Creance</title>
                <style>
                    body {
                        font-family: 'Courier New', monospace;
                        padding: 40px;
                        max-width: 800px;
                        margin: 0 auto;
                        background: white;
                    }
                    .header {
                        text-align: center;
                        border-bottom: 2px solid #1a365d;
                        padding-bottom: 20px;
                        margin-bottom: 30px;
                    }
                    .logo {
                        width: 60px;
                        height: 60px;
                        background: #c6a962;
                        color: #1a365d;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 20px;
                        border-radius: 8px;
                        margin-bottom: 10px;
                    }
                    h1 {
                        color: #1a365d;
                        margin: 10px 0;
                        font-size: 24px;
                    }
                    .subtitle {
                        color: #666;
                        font-size: 14px;
                    }
                    .content {
                        white-space: pre-wrap;
                        font-size: 13px;
                        line-height: 1.8;
                        background: #f8fafc;
                        padding: 20px;
                        border-radius: 8px;
                        border: 1px solid #e2e8f0;
                    }
                    .footer {
                        margin-top: 40px;
                        text-align: center;
                        color: #666;
                        font-size: 11px;
                        border-top: 1px solid #e2e8f0;
                        padding-top: 20px;
                    }
                    @media print {
                        body { padding: 20px; }
                        .content { border: none; background: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">MAB</div>
                    <h1>DECOMPTE DE CREANCE</h1>
                    <p class="subtitle">Etude Me BIAOU Martial Arnaud - Huissier de Justice</p>
                </div>
                <div class="content">${content}</div>
                <div class="footer">
                    <p>Document genere le ${now}</p>
                    <p>Etude Me BIAOU - Cotonou, Benin</p>
                </div>
                <script>
                    setTimeout(() => { window.print(); }, 500);
                </script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    // ═══════════════════════════════════════════════════════════════
    // FONCTIONS D'EXPORT
    // ═══════════════════════════════════════════════════════════════

    function exporterPDF() {
        if (!resultats) {
            alert('Aucun calcul a exporter');
            return;
        }

        // Preparer les donnees pour le PDF
        const exportData = {
            ...resultats,
            actes_detail: actes  // Ajouter le detail des actes
        };

        fetch('{% url "gestion:api_exporter_decompte_pdf" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(exportData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Erreur export PDF'); });
            }
            return response.blob();
        })
        .then(blob => {
            // Creer un lien de telechargement
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `decompte_creance_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            alert('Erreur lors de l\'export PDF: ' + error.message);
        });
    }

    function exporterExcel() {
        if (!resultats) {
            alert('Aucun calcul a exporter');
            return;
        }

        // Preparer les donnees pour Excel
        const exportData = {
            ...resultats,
            donnees_calcul: donneesCalcul,
            actes_detail: actes
        };

        fetch('{% url "gestion:api_exporter_decompte_excel" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(exportData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Erreur export Excel'); });
            }
            return response.blob();
        })
        .then(blob => {
            // Creer un lien de telechargement
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `decompte_creance_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            alert('Erreur lors de l\'export Excel: ' + error.message);
        });
    }

    // Amelioration de la fonction copyText pour copier un texte formate pour actes
    function copyText() {
        if (!resultats) {
            alert('Aucun calcul a copier');
            return;
        }

        const text = generateTextForActe(resultats);
        navigator.clipboard.writeText(text).then(() => {
            // Feedback visuel
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check"></i> Copie !';
            btn.classList.add('btn-success');
            lucide.createIcons();
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                lucide.createIcons();
            }, 2000);
        }).catch(err => {
            alert('Erreur lors de la copie: ' + err.message);
        });
    }

    // Generer un texte formate pour coller dans un acte juridique
    function generateTextForActe(res) {
        if (res.mode === 'emoluments') {
            return generateText(res);  // Utiliser la fonction existante
        }

        let text = `DÉCOMPTE DE CRÉANCE\n`;
        text += `conformément aux règles OHADA (Articles 92, 153, 184)\n`;
        text += `════════════════════════════════════════════════════\n\n`;

        text += `I. EN PRINCIPAL\n`;
        text += `   La somme de ${formatMontant(res.principal)} à titre de principal\n\n`;

        text += `II. INTÉRÊTS ÉCHUS\n`;
        text += `    Du ${res.date_debut} au ${res.date_fin}\n`;
        if (res.interets_echus.periodes && res.interets_echus.periodes.length > 0) {
            res.interets_echus.periodes.forEach(p => {
                let tauxInfo = `${p.taux.toFixed(4)}%`;
                if (p.majore) tauxInfo += ' (majoré +50%)';
                text += `    - Année ${p.annee}: ${p.jours} jours au taux de ${tauxInfo}\n`;
                text += `      soit la somme de ${formatMontant(p.interet)}\n`;
            });
        }
        text += `    SOUS-TOTAL INTÉRÊTS ÉCHUS: ${formatMontant(res.interets_echus.total)}\n\n`;

        if (res.majoration && res.date_limite_majoration) {
            text += `    *** MAJORATION (Loi 2024-10, Art. 3) ***\n`;
            text += `    Taux majoré de 50% applicable après le ${res.date_limite_majoration}\n\n`;
        }

        text += `III. INTÉRÊTS À ÉCHOIR\n`;
        text += `     La somme de ${formatMontant(res.interets_echoir.total)} pour un mois\n`;
        text += `     (conformément à l'OHADA pour saisie-attribution)\n\n`;

        if (res.frais_justice > 0) {
            text += `IV. FRAIS DE JUSTICE\n`;
            text += `    La somme de ${formatMontant(res.frais_justice)}\n\n`;
        }

        if (res.emoluments) {
            text += `V. ÉMOLUMENTS PROPORTIONNELS\n`;
            text += `   Base de calcul: ${formatMontant(res.base_emoluments)}\n`;
            text += `   Type: ${res.emoluments.type_titre === 'avec' ? 'Avec titre exécutoire' : 'Sans titre exécutoire'}\n`;
            text += `   (Décret 2017-066 - Barème de recouvrement)\n`;
            text += `   Émoluments: ${formatMontant(res.emoluments.total)}\n\n`;
        }

        if (res.actes > 0) {
            text += `VI. COÛTS DES ACTES DE PROCÉDURE\n`;
            actes.forEach(a => {
                text += `    - ${a.libelle}: ${formatMontant(a.montant)}\n`;
            });
            text += `    TOTAL ACTES: ${formatMontant(res.actes)}\n\n`;
        }

        text += `════════════════════════════════════════════════════\n`;
        text += `SOIT AU TOTAL LA SOMME DE: ${formatMontant(res.total)}\n`;
        text += `(${nombreEnLettres(res.total)} francs CFA)\n`;
        text += `════════════════════════════════════════════════════\n`;

        return text;
    }

    // Convertir un nombre en lettres (simplifie)
    function nombreEnLettres(n) {
        n = Math.round(n);
        if (n === 0) return 'zéro';

        const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf',
                       'dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept',
                       'dix-huit', 'dix-neuf'];
        const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante',
                      'quatre-vingt', 'quatre-vingt'];

        function convertLessThan1000(num) {
            if (num === 0) return '';
            if (num < 20) return units[num];
            if (num < 100) {
                const t = Math.floor(num / 10);
                const u = num % 10;
                if (t === 7 || t === 9) {
                    return tens[t] + '-' + units[10 + u];
                }
                if (u === 1 && t !== 8) {
                    return tens[t] + ' et un';
                }
                return tens[t] + (u > 0 ? '-' + units[u] : (t === 8 ? 's' : ''));
            }
            const h = Math.floor(num / 100);
            const rest = num % 100;
            let result = h === 1 ? 'cent' : units[h] + ' cent';
            if (rest === 0 && h > 1) result += 's';
            else if (rest > 0) result += ' ' + convertLessThan1000(rest);
            return result;
        }

        if (n >= 1000000000) {
            const milliards = Math.floor(n / 1000000000);
            const reste = n % 1000000000;
            let result = (milliards === 1 ? 'un milliard' : convertLessThan1000(milliards) + ' milliards');
            if (reste > 0) result += ' ' + nombreEnLettres(reste);
            return result;
        }

        if (n >= 1000000) {
            const millions = Math.floor(n / 1000000);
            const reste = n % 1000000;
            let result = (millions === 1 ? 'un million' : convertLessThan1000(millions) + ' millions');
            if (reste > 0) result += ' ' + nombreEnLettres(reste);
            return result;
        }

        if (n >= 1000) {
            const milliers = Math.floor(n / 1000);
            const reste = n % 1000;
            let result = milliers === 1 ? 'mille' : convertLessThan1000(milliers) + ' mille';
            if (reste > 0) result += ' ' + convertLessThan1000(reste);
            return result;
        }

        return convertLessThan1000(n);
    }
</script>
{% endblock %}
