{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Étude BIAOU{% endblock %}

{% block extra_css %}
<style>
    /* Styles spécifiques au module Paramètres */
    .parametres-page {
        padding: 0;
    }

    /* Navigation par onglets */
    .tabs-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 24px;
        overflow: hidden;
    }

    .tabs-nav {
        display: flex;
        overflow-x: auto;
        border-bottom: 2px solid var(--neutral-200);
        background: var(--neutral-50);
    }

    .tab-btn {
        padding: 14px 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-family: 'Source Sans 3', sans-serif;
        font-size: 14px;
        font-weight: 500;
        color: var(--neutral-600);
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }

    .tab-btn:hover {
        color: var(--primary);
        background: var(--neutral-100);
    }

    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--accent);
        background: white;
    }

    .tab-btn i {
        width: 18px;
        height: 18px;
    }

    .tab-content {
        display: none;
        padding: 24px;
    }

    .tab-content.active {
        display: block;
    }

    /* Sections repliables */
    .section-collapsible {
        border: 1px solid var(--neutral-200);
        border-radius: 8px;
        margin-bottom: 16px;
        overflow: hidden;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: var(--neutral-50);
        cursor: pointer;
        transition: background 0.2s;
    }

    .section-header:hover {
        background: var(--neutral-100);
    }

    .section-header h4 {
        margin: 0;
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--neutral-800);
    }

    .section-header h4 i {
        width: 18px;
        height: 18px;
        color: var(--primary);
    }

    .section-toggle {
        width: 24px;
        height: 24px;
        transition: transform 0.2s;
    }

    .section-collapsible.open .section-toggle {
        transform: rotate(180deg);
    }

    .section-body {
        display: none;
        padding: 20px;
        border-top: 1px solid var(--neutral-200);
    }

    .section-collapsible.open .section-body {
        display: block;
    }

    /* Formulaires */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }

    .form-grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
    }

    @media (max-width: 768px) {
        .form-grid, .form-grid-3, .form-grid-4 {
            grid-template-columns: 1fr;
        }
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--neutral-700);
        margin-bottom: 6px;
    }

    .form-label.required::after {
        content: ' *';
        color: var(--danger);
    }

    .form-input, .form-select, .form-textarea {
        padding: 10px 12px;
        border: 1px solid var(--neutral-300);
        border-radius: 6px;
        font-size: 14px;
        font-family: 'Source Sans 3', sans-serif;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
    }

    .form-input:disabled, .form-select:disabled {
        background: var(--neutral-100);
        cursor: not-allowed;
    }

    .form-input.readonly {
        background: var(--neutral-50);
        color: var(--neutral-600);
    }

    .form-help {
        font-size: 12px;
        color: var(--neutral-500);
        margin-top: 4px;
    }

    /* Groupe de toggle */
    .toggle-group {
        display: flex;
        border: 1px solid var(--neutral-300);
        border-radius: 6px;
        overflow: hidden;
    }

    .toggle-option {
        flex: 1;
        padding: 10px 16px;
        text-align: center;
        cursor: pointer;
        background: white;
        border: none;
        font-size: 14px;
        transition: all 0.2s;
    }

    .toggle-option:not(:last-child) {
        border-right: 1px solid var(--neutral-300);
    }

    .toggle-option:hover {
        background: var(--neutral-50);
    }

    .toggle-option.active {
        background: var(--primary);
        color: white;
    }

    /* Switch */
    .switch-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .switch {
        position: relative;
        width: 48px;
        height: 26px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .switch-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--neutral-300);
        transition: 0.3s;
        border-radius: 26px;
    }

    .switch-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }

    .switch input:checked + .switch-slider {
        background-color: var(--primary);
    }

    .switch input:checked + .switch-slider:before {
        transform: translateX(22px);
    }

    /* Color picker */
    .color-picker-group {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .color-preview {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        border: 2px solid var(--neutral-300);
    }

    input[type="color"] {
        width: 60px;
        height: 40px;
        padding: 0;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    /* File upload */
    .file-upload {
        border: 2px dashed var(--neutral-300);
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .file-upload:hover {
        border-color: var(--primary);
        background: var(--neutral-50);
    }

    .file-upload i {
        width: 40px;
        height: 40px;
        color: var(--neutral-400);
        margin-bottom: 8px;
    }

    .file-upload-text {
        color: var(--neutral-600);
        font-size: 14px;
    }

    .file-upload-hint {
        color: var(--neutral-400);
        font-size: 12px;
        margin-top: 4px;
    }

    /* Logo preview */
    .logo-preview {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 16px;
        background: var(--neutral-50);
        border-radius: 8px;
    }

    .logo-preview img {
        max-width: 150px;
        max-height: 80px;
        border-radius: 4px;
    }

    /* Barème table */
    .bareme-table {
        width: 100%;
        border-collapse: collapse;
    }

    .bareme-table th, .bareme-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--neutral-200);
    }

    .bareme-table th {
        background: var(--neutral-50);
        font-weight: 600;
        font-size: 13px;
        color: var(--neutral-600);
    }

    .bareme-table tr:last-child td {
        border-bottom: none;
    }

    .bareme-readonly {
        background: var(--neutral-50);
        border-radius: 8px;
        padding: 16px;
    }

    .bareme-readonly .info-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--info);
        color: white;
        border-radius: 4px;
        font-size: 12px;
        margin-bottom: 12px;
    }

    /* Ordre imputation draggable */
    .ordre-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .ordre-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: white;
        border: 1px solid var(--neutral-200);
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: grab;
        transition: all 0.2s;
    }

    .ordre-item:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .ordre-item.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }

    .ordre-number {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: 600;
    }

    .ordre-drag-handle {
        color: var(--neutral-400);
        cursor: grab;
    }

    /* Bouton flottant Enregistrer */
    .floating-save {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 100;
    }

    .floating-save .btn {
        padding: 14px 28px;
        font-size: 15px;
        box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
    }

    /* Alertes */
    .alert {
        padding: 14px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .alert i {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
    }

    .alert-info {
        background: #e7f3ff;
        border: 1px solid #b8daff;
        color: #004085;
    }

    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .tabs-nav {
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 12px 16px;
            font-size: 13px;
        }

        .tab-btn span {
            display: none;
        }

        .floating-save {
            bottom: 16px;
            right: 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="parametres-page">
    <!-- Alert admin only -->
    <div class="alert alert-info">
        <i data-lucide="shield-check"></i>
        <div>
            <strong>Module réservé à l'administrateur.</strong>
            Les modifications effectuées ici affectent l'ensemble de l'application.
        </div>
    </div>

    <!-- Container avec onglets -->
    <div class="tabs-container">
        <!-- Navigation par onglets -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="showTab('etude')">
                <i data-lucide="building-2"></i>
                <span>Informations de l'étude</span>
            </button>
            <button class="tab-btn" onclick="showTab('modules')">
                <i data-lucide="settings-2"></i>
                <span>Paramètres des modules</span>
            </button>
            <button class="tab-btn" onclick="showTab('documents')">
                <i data-lucide="file-text"></i>
                <span>Modèles de documents</span>
            </button>
            <button class="tab-btn" onclick="showTab('notifications')">
                <i data-lucide="bell"></i>
                <span>Notifications</span>
            </button>
            <button class="tab-btn" onclick="showTab('sauvegardes')">
                <i data-lucide="hard-drive"></i>
                <span>Sauvegardes</span>
            </button>
            <button class="tab-btn" onclick="showTab('personnalisation')">
                <i data-lucide="palette"></i>
                <span>Personnalisation</span>
            </button>
            <button class="tab-btn" onclick="showTab('referentiels')">
                <i data-lucide="database"></i>
                <span>Référentiels</span>
            </button>
            <button class="tab-btn" onclick="showTab('apropos')">
                <i data-lucide="info"></i>
                <span>À propos</span>
            </button>
        </div>

        <!-- ============================================== -->
        <!-- SECTION 1 : INFORMATIONS DE L'ÉTUDE -->
        <!-- ============================================== -->
        <div id="tab-etude" class="tab-content active">
            <!-- Identité de l'étude -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="building"></i> Identité de l'étude</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label required">Nom de l'étude</label>
                            <input type="text" id="nom_etude" class="form-input"
                                   value="{{ config.nom_etude }}" placeholder="Étude Me NOM PRÉNOM">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Titre</label>
                            <input type="text" id="titre" class="form-input"
                                   value="{{ config.titre }}" placeholder="Huissier de Justice">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date d'installation</label>
                            <input type="date" id="date_installation" class="form-input"
                                   value="{{ config.date_installation|date:'Y-m-d' }}">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Juridiction</label>
                            <input type="text" id="juridiction" class="form-input"
                                   value="{{ config.juridiction }}"
                                   placeholder="près le Tribunal de Première Instance de [Ville] et la Cour d'Appel de [Ville]">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro IFU</label>
                            <input type="text" id="numero_ifu" class="form-input"
                                   value="{{ config.numero_ifu }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro RCCM</label>
                            <input type="text" id="numero_rccm" class="form-input"
                                   value="{{ config.numero_rccm|default:'' }}"
                                   placeholder="Ex: RB/COT/25 A 12345">
                            <small class="form-help">Registre du Commerce et du Crédit Mobilier</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro d'agrément / Inscription au tableau</label>
                            <input type="text" id="numero_agrement" class="form-input"
                                   value="{{ config.numero_agrement }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adresse et contacts -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="map-pin"></i> Adresse et contacts</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Adresse (rue)</label>
                            <input type="text" id="adresse_rue" class="form-input"
                                   value="{{ config.adresse_rue }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quartier</label>
                            <input type="text" id="adresse_quartier" class="form-input"
                                   value="{{ config.adresse_quartier }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ville</label>
                            <input type="text" id="adresse_ville" class="form-input"
                                   value="{{ config.adresse_ville }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Boîte postale</label>
                            <input type="text" id="adresse_bp" class="form-input"
                                   value="{{ config.adresse_bp }}" placeholder="BP 123">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Téléphone fixe</label>
                            <input type="tel" id="telephone_fixe" class="form-input"
                                   value="{{ config.telephone_fixe }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile 1</label>
                            <input type="tel" id="telephone_mobile1" class="form-input"
                                   value="{{ config.telephone_mobile1 }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile 2</label>
                            <input type="tel" id="telephone_mobile2" class="form-input"
                                   value="{{ config.telephone_mobile2 }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email professionnel</label>
                            <input type="email" id="email" class="form-input"
                                   value="{{ config.email }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site web</label>
                            <input type="url" id="site_web" class="form-input"
                                   value="{{ config.site_web }}" placeholder="https://...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logo et couleurs -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="image"></i> Logo et en-tête</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Logo de l'étude</label>
                            <div class="file-upload" onclick="document.getElementById('logo_file').click()">
                                <i data-lucide="upload-cloud"></i>
                                <div class="file-upload-text">Cliquez pour uploader le logo</div>
                                <div class="file-upload-hint">PNG, JPG - Max 2 Mo</div>
                            </div>
                            <input type="file" id="logo_file" accept=".png,.jpg,.jpeg" style="display:none" onchange="previewLogo(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Aperçu du logo</label>
                            <div class="logo-preview" id="logo_preview">
                                {% if config.logo %}
                                    <img src="{{ config.logo.url }}" alt="Logo">
                                {% else %}
                                    <span style="color: var(--neutral-400)">Aucun logo</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Couleur principale</label>
                            <div class="color-picker-group">
                                <input type="color" id="couleur_principale"
                                       value="{{ config.couleur_principale }}" onchange="updateColorPreview('principale')">
                                <input type="text" class="form-input" style="width:100px"
                                       value="{{ config.couleur_principale }}" id="couleur_principale_text"
                                       onchange="document.getElementById('couleur_principale').value = this.value">
                                <div class="color-preview" id="preview_principale"
                                     style="background: {{ config.couleur_principale }}"></div>
                            </div>
                            <small class="form-help">Par défaut : #1a365d (bleu foncé)</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Couleur secondaire</label>
                            <div class="color-picker-group">
                                <input type="color" id="couleur_secondaire"
                                       value="{{ config.couleur_secondaire }}" onchange="updateColorPreview('secondaire')">
                                <input type="text" class="form-input" style="width:100px"
                                       value="{{ config.couleur_secondaire }}" id="couleur_secondaire_text"
                                       onchange="document.getElementById('couleur_secondaire').value = this.value">
                                <div class="color-preview" id="preview_secondaire"
                                     style="background: {{ config.couleur_secondaire }}"></div>
                            </div>
                            <small class="form-help">Par défaut : #c6a962 (or)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signature de l'huissier -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="pen-tool"></i> Signature de l'huissier</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Signature numérisée</label>
                            <div class="file-upload" onclick="document.getElementById('signature_file').click()">
                                <i data-lucide="upload-cloud"></i>
                                <div class="file-upload-text">Cliquez pour uploader la signature</div>
                                <div class="file-upload-hint">PNG transparent recommandé - Max 2 Mo</div>
                            </div>
                            <input type="file" id="signature_file" accept=".png,.jpg,.jpeg,.webp" style="display:none" onchange="previewSignature(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Aperçu de la signature</label>
                            <div class="signature-preview" id="signature_preview" style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--neutral-200);">
                                {% if config.signature_huissier %}
                                    <img src="{{ config.signature_huissier.url }}" alt="Signature" style="max-height: 100px; max-width: 100%;">
                                {% else %}
                                    <span style="color: var(--neutral-400)">Aucune signature</span>
                                {% endif %}
                            </div>
                            <small class="form-help">Cette signature sera utilisée sur les documents officiels (PV, actes, etc.)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coordonnées bancaires -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="landmark"></i> Coordonnées bancaires de l'étude</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Banque principale</label>
                            <input type="text" id="banque_nom" class="form-input"
                                   value="{{ config.banque_nom }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Code banque</label>
                            <input type="text" id="banque_code" class="form-input"
                                   value="{{ config.banque_code }}" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Code guichet</label>
                            <input type="text" id="banque_guichet" class="form-input"
                                   value="{{ config.banque_guichet }}" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro de compte</label>
                            <input type="text" id="banque_compte" class="form-input"
                                   value="{{ config.banque_compte }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Clé RIB</label>
                            <input type="text" id="banque_cle" class="form-input"
                                   value="{{ config.banque_cle }}" maxlength="2">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">IBAN (si applicable)</label>
                            <input type="text" id="banque_iban" class="form-input"
                                   value="{{ config.banque_iban }}">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Titulaire du compte</label>
                            <input type="text" id="banque_titulaire" class="form-input"
                                   value="{{ config.banque_titulaire }}">
                        </div>
                    </div>

                    <h5 style="margin: 20px 0 12px; color: var(--neutral-700);">Mobile Money</h5>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Opérateur</label>
                            <select id="mobile_money_operateur" class="form-select">
                                <option value="">-- Sélectionner --</option>
                                <option value="MTN" {% if config.mobile_money_operateur == 'MTN' %}selected{% endif %}>MTN Mobile Money</option>
                                <option value="MOOV" {% if config.mobile_money_operateur == 'MOOV' %}selected{% endif %}>Moov Money</option>
                                <option value="CELTIIS" {% if config.mobile_money_operateur == 'CELTIIS' %}selected{% endif %}>Celtiis Cash</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro</label>
                            <input type="tel" id="mobile_money_numero" class="form-input"
                                   value="{{ config.mobile_money_numero }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sites/Agences -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="building-2"></i> Sites / Agences</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="alert alert-info" style="margin-bottom: 16px;">
                        <i data-lucide="info"></i>
                        <span>Ajoutez des sites si votre étude dispose de plusieurs agences.</span>
                    </div>

                    <div class="table-container">
                        <table class="table" id="sites_table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Adresse</th>
                                    <th>Téléphone</th>
                                    <th>Responsable</th>
                                    <th>Principal</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for site in sites %}
                                <tr data-id="{{ site.id }}">
                                    <td>{{ site.nom }}</td>
                                    <td>{{ site.adresse|truncatewords:5 }}</td>
                                    <td>{{ site.telephone }}</td>
                                    <td>{{ site.responsable }}</td>
                                    <td>
                                        {% if site.est_principal %}
                                            <i data-lucide="check-circle" style="color: var(--success); width: 18px;"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-icon" onclick="editSite({{ site.id }})" title="Modifier">
                                            <i data-lucide="edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-icon btn-danger" onclick="deleteSite({{ site.id }})" title="Supprimer">
                                            <i data-lucide="trash-2"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--neutral-500);">
                                        Aucun site enregistré
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-secondary mt-3" onclick="openSiteModal()">
                        <i data-lucide="plus"></i> Ajouter un site
                    </button>
                </div>
            </div>

            <!-- Bouton enregistrer section -->
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="sauvegarderSection('etude')">
                    <i data-lucide="save"></i> Enregistrer les informations de l'étude
                </button>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- SECTION 2 : PARAMÈTRES DES MODULES -->
        <!-- ============================================== -->
        <div id="tab-modules" class="tab-content">
            <!-- 2.1 Dossiers -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="folder-open"></i> Dossiers</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Préfixe des numéros de dossier</label>
                            <input type="text" id="dossier_prefixe" class="form-input"
                                   value="{{ config.dossier_prefixe }}" placeholder="DOS-">
                            <small class="form-help">Format: [PRÉFIXE][ANNÉE]-[NUMÉRO]</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro de départ (nouvelle année)</label>
                            <input type="number" id="dossier_numero_depart" class="form-input"
                                   value="{{ config.dossier_numero_depart }}" min="1">
                        </div>
                    </div>

                    <!-- Types de dossiers -->
                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Types de dossiers</h5>
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Libellé</th>
                                    <th>Couleur</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="types_dossier_tbody">
                                {% for type in types_dossier %}
                                <tr>
                                    <td>{{ type.code }}</td>
                                    <td>{{ type.libelle }}</td>
                                    <td><span style="display:inline-block;width:20px;height:20px;background:{{ type.couleur }};border-radius:4px;"></span></td>
                                    <td>
                                        <button class="btn btn-sm btn-icon" onclick="editTypeDossier({{ type.id }})">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="openTypeDossierModal()">
                        <i data-lucide="plus"></i> Ajouter un type
                    </button>

                    <!-- Statuts de dossiers -->
                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Statuts de dossiers</h5>
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Libellé</th>
                                    <th>Clôture</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="statuts_dossier_tbody">
                                {% for statut in statuts_dossier %}
                                <tr>
                                    <td>{{ statut.code }}</td>
                                    <td>{{ statut.libelle }}</td>
                                    <td>
                                        {% if statut.est_cloture %}
                                            <i data-lucide="check" style="color: var(--success); width: 16px;"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-icon" onclick="editStatutDossier({{ statut.id }})">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="openStatutDossierModal()">
                        <i data-lucide="plus"></i> Ajouter un statut
                    </button>
                </div>
            </div>

            <!-- 2.2 Facturation -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="file-text"></i> Facturation</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Préfixe des factures</label>
                            <input type="text" id="facture_prefixe" class="form-input"
                                   value="{{ config.facture_prefixe }}" placeholder="FAC-">
                        </div>
                        <div class="form-group">
                            <label class="form-label">TVA applicable</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="tva_applicable" {% if config.tva_applicable %}checked{% endif %}>
                                    <span class="switch-slider"></span>
                                </label>
                                <span id="tva_label">{% if config.tva_applicable %}Oui{% else %}Non{% endif %}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Taux TVA (%)</label>
                            <input type="number" id="tva_taux" class="form-input"
                                   value="{{ config.tva_taux }}" step="0.01" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Délai de paiement (jours)</label>
                            <input type="number" id="facture_delai_paiement" class="form-input"
                                   value="{{ config.facture_delai_paiement }}" min="0">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Conditions de paiement par défaut</label>
                            <input type="text" id="facture_conditions_paiement" class="form-input"
                                   value="{{ config.facture_conditions_paiement }}" placeholder="Payable à réception">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pénalités de retard (% par mois)</label>
                            <input type="number" id="facture_penalites_retard" class="form-input"
                                   value="{{ config.facture_penalites_retard }}" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- MECeF -->
                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Configuration MECeF</h5>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Numéro NIM (MECeF)</label>
                            <input type="text" id="mecef_nim" class="form-input"
                                   value="{{ config.mecef_nim }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Token API MECeF</label>
                            <input type="password" id="mecef_token" class="form-input"
                                   value="{{ config.mecef_token }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mode MECeF</label>
                            <div class="toggle-group">
                                <button type="button" class="toggle-option {% if config.mecef_mode == 'test' %}active{% endif %}"
                                        onclick="setMecefMode('test')">Test</button>
                                <button type="button" class="toggle-option {% if config.mecef_mode == 'production' %}active{% endif %}"
                                        onclick="setMecefMode('production')">Production</button>
                            </div>
                            <input type="hidden" id="mecef_mode" value="{{ config.mecef_mode }}">
                        </div>
                    </div>

                    <div class="form-group full-width mt-3">
                        <label class="form-label">Mentions légales sur factures</label>
                        <textarea id="facture_mentions_legales" class="form-textarea" rows="3">{{ config.facture_mentions_legales }}</textarea>
                    </div>
                </div>
            </div>

            <!-- 2.3 Trésorerie -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="wallet"></i> Trésorerie</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Devise</label>
                            <input type="text" id="devise" class="form-input readonly"
                                   value="{{ config.devise }}" disabled>
                            <small class="form-help">Non modifiable</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seuil alerte solde faible (F)</label>
                            <input type="number" id="tresorerie_seuil_alerte" class="form-input"
                                   value="{{ config.tresorerie_seuil_alerte }}" min="0" step="1000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Validation obligatoire décaissements > (F)</label>
                            <input type="number" id="tresorerie_validation_seuil" class="form-input"
                                   value="{{ config.tresorerie_validation_seuil }}" min="0" step="10000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Délai max reversement consignations (jours)</label>
                            <input type="number" id="tresorerie_delai_reversement" class="form-input"
                                   value="{{ config.tresorerie_delai_reversement }}" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Compte séquestre obligatoire</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="tresorerie_compte_sequestre"
                                           {% if config.tresorerie_compte_sequestre %}checked{% endif %}>
                                    <span class="switch-slider"></span>
                                </label>
                                <span>{% if config.tresorerie_compte_sequestre %}Oui{% else %}Non{% endif %}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2.4 Comptabilité -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="calculator"></i> Comptabilité</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Début exercice comptable</label>
                            <input type="date" id="exercice_debut" class="form-input"
                                   value="{{ config.exercice_debut|date:'Y-m-d' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fin exercice comptable</label>
                            <input type="date" id="exercice_fin" class="form-input"
                                   value="{{ config.exercice_fin|date:'Y-m-d' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mode de saisie par défaut</label>
                            <select id="comptabilite_mode" class="form-select">
                                <option value="facile" {% if config.comptabilite_mode == 'facile' %}selected{% endif %}>Facile</option>
                                <option value="guide" {% if config.comptabilite_mode == 'guide' %}selected{% endif %}>Guidé</option>
                                <option value="expert" {% if config.comptabilite_mode == 'expert' %}selected{% endif %}>Expert</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Plan comptable</label>
                            <input type="text" class="form-input readonly" value="SYSCOHADA" disabled>
                            <small class="form-help">Non modifiable</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Régime fiscal</label>
                            <select id="regime_fiscal" class="form-select">
                                <option value="reel_normal" {% if config.regime_fiscal == 'reel_normal' %}selected{% endif %}>Réel normal</option>
                                <option value="reel_simplifie" {% if config.regime_fiscal == 'reel_simplifie' %}selected{% endif %}>Réel simplifié</option>
                                <option value="micro" {% if config.regime_fiscal == 'micro' %}selected{% endif %}>Micro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Déclarations TVA</label>
                            <select id="tva_declaration" class="form-select">
                                <option value="mensuelle" {% if config.tva_declaration == 'mensuelle' %}selected{% endif %}>Mensuelle</option>
                                <option value="trimestrielle" {% if config.tva_declaration == 'trimestrielle' %}selected{% endif %}>Trimestrielle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rappels échéances fiscales (jours avant)</label>
                            <input type="number" id="echeances_rappel_jours" class="form-input"
                                   value="{{ config.echeances_rappel_jours }}" min="1" max="30">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2.5 Recouvrement -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="hand-coins"></i> Recouvrement</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Taux intérêt légal par défaut</label>
                            <input type="text" class="form-input readonly" value="Taux UEMOA (automatique)" disabled>
                            <small class="form-help">Mis à jour via les référentiels</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Application majoration 50% (Loi 2024)</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="recouvrement_majoration_50"
                                           {% if config.recouvrement_majoration_50 %}checked{% endif %}>
                                    <span class="switch-slider"></span>
                                </label>
                                <span>{% if config.recouvrement_majoration_50 %}Oui{% else %}Non{% endif %}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Délai avant majoration (mois)</label>
                            <input type="number" id="recouvrement_delai_majoration" class="form-input"
                                   value="{{ config.recouvrement_delai_majoration }}" min="1">
                        </div>
                    </div>

                    <!-- Ordre d'imputation -->
                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Ordre d'imputation des paiements</h5>
                    <p style="color: var(--neutral-500); font-size: 13px; margin-bottom: 12px;">
                        Glissez-déposez pour réorganiser l'ordre
                    </p>
                    <ul class="ordre-list" id="ordre_imputation">
                        <li class="ordre-item" data-value="frais_procedure" draggable="true">
                            <span class="ordre-number">1</span>
                            <i data-lucide="grip-vertical" class="ordre-drag-handle"></i>
                            <span>Frais de procédure</span>
                        </li>
                        <li class="ordre-item" data-value="emoluments" draggable="true">
                            <span class="ordre-number">2</span>
                            <i data-lucide="grip-vertical" class="ordre-drag-handle"></i>
                            <span>Émoluments</span>
                        </li>
                        <li class="ordre-item" data-value="interets" draggable="true">
                            <span class="ordre-number">3</span>
                            <i data-lucide="grip-vertical" class="ordre-drag-handle"></i>
                            <span>Intérêts</span>
                        </li>
                        <li class="ordre-item" data-value="principal" draggable="true">
                            <span class="ordre-number">4</span>
                            <i data-lucide="grip-vertical" class="ordre-drag-handle"></i>
                            <span>Principal</span>
                        </li>
                    </ul>

                    <!-- Barème émoluments OHADA (lecture seule) -->
                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Barème émoluments proportionnels OHADA</h5>
                    <div class="bareme-readonly">
                        <span class="info-badge">
                            <i data-lucide="info" style="width:14px;height:14px;"></i>
                            Référence légale - Non modifiable
                        </span>
                        <table class="bareme-table">
                            <thead>
                                <tr>
                                    <th>Tranche</th>
                                    <th>Taux</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for b in bareme_ohada %}
                                <tr>
                                    <td>
                                        {% if b.max %}
                                            {{ b.min|floatformat:0 }} - {{ b.max|floatformat:0 }} F
                                        {% else %}
                                            > {{ b.min|floatformat:0 }} F
                                        {% endif %}
                                    </td>
                                    <td>{{ b.taux }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2.6 Gérance Immobilière -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="home"></i> Gérance Immobilière</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Taux honoraires gestion (% loyer)</label>
                            <input type="number" id="gerance_taux_honoraires" class="form-input"
                                   value="{{ config.gerance_taux_honoraires }}" step="0.5" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date de reversement propriétaires</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>Le</span>
                                <input type="number" id="gerance_date_reversement" class="form-input"
                                       style="width: 80px;" value="{{ config.gerance_date_reversement }}" min="1" max="28">
                                <span>de chaque mois</span>
                            </div>
                        </div>
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Délais de relance impayés</h5>
                    <div class="form-grid-4">
                        <div class="form-group">
                            <label class="form-label">Niveau 1 (rappel)</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>J+</span>
                                <input type="number" id="gerance_relance_niveau1" class="form-input"
                                       value="{{ config.gerance_relance_niveau1 }}" min="1">
                                <span>jours</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Niveau 2 (relance)</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>J+</span>
                                <input type="number" id="gerance_relance_niveau2" class="form-input"
                                       value="{{ config.gerance_relance_niveau2 }}" min="1">
                                <span>jours</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Niveau 3 (mise en demeure)</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>J+</span>
                                <input type="number" id="gerance_relance_niveau3" class="form-input"
                                       value="{{ config.gerance_relance_niveau3 }}" min="1">
                                <span>jours</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Niveau 4 (commandement)</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>J+</span>
                                <input type="number" id="gerance_relance_niveau4" class="form-input"
                                       value="{{ config.gerance_relance_niveau4 }}" min="1">
                                <span>jours</span>
                            </div>
                        </div>
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Modèles de baux disponibles</h5>
                    <div class="table-container">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Libellé</th>
                                    <th>Modèle associé</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bail in types_bail %}
                                <tr>
                                    <td>{{ bail.code }}</td>
                                    <td>{{ bail.libelle }}</td>
                                    <td>{{ bail.modele_document.nom|default:"-" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-icon">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--neutral-500);">
                                        Aucun type de bail configuré
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2.7 RH -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="users"></i> Ressources Humaines</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">SMIG en vigueur (FCFA)</label>
                            <input type="number" id="rh_smig" class="form-input"
                                   value="{{ config.rh_smig }}" min="0">
                            <small class="form-help">Modifiable si changement légal</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Plafond CNSS mensuel (FCFA)</label>
                            <input type="number" id="rh_plafond_cnss" class="form-input"
                                   value="{{ config.rh_plafond_cnss }}" min="0">
                        </div>
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Taux cotisations CNSS</h5>
                    <div class="form-grid-4">
                        <div class="form-group">
                            <label class="form-label">Salarial Vieillesse (%)</label>
                            <input type="number" id="rh_cnss_salarial_vieillesse" class="form-input"
                                   value="{{ config.rh_cnss_salarial_vieillesse }}" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Patronal PF (%)</label>
                            <input type="number" id="rh_cnss_patronal_pf" class="form-input"
                                   value="{{ config.rh_cnss_patronal_pf }}" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Patronal Vieillesse (%)</label>
                            <input type="number" id="rh_cnss_patronal_vieillesse" class="form-input"
                                   value="{{ config.rh_cnss_patronal_vieillesse }}" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Patronal AT (%)</label>
                            <input type="number" id="rh_cnss_patronal_at" class="form-input"
                                   value="{{ config.rh_cnss_patronal_at }}" step="0.1" min="1" max="4">
                        </div>
                    </div>

                    <div class="form-grid mt-3">
                        <div class="form-group">
                            <label class="form-label">Congés annuels (jours/mois)</label>
                            <input type="number" id="rh_conges_annuels" class="form-input"
                                   value="{{ config.rh_conges_annuels }}" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Heures travail hebdomadaires</label>
                            <input type="number" id="rh_heures_hebdo" class="form-input"
                                   value="{{ config.rh_heures_hebdo }}" min="1" max="48">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jour de paie</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>Le</span>
                                <input type="number" id="rh_jour_paie" class="form-input"
                                       style="width: 80px;" value="{{ config.rh_jour_paie }}" min="1" max="28">
                                <span>de chaque mois</span>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i data-lucide="info"></i>
                        <div>
                            <strong>Bonus ancienneté congés :</strong><br>
                            Après 5 ans : +1 jour | Après 10 ans : +2 jours | Après 15 ans : +3 jours | Après 20 ans : +5 jours
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2.8 Mémoires de Cédules -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="file-signature"></i> Mémoires de Cédules</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Résidence de l'huissier (pour calcul distances)</label>
                            <input type="text" id="cedules_residence" class="form-input"
                                   value="{{ config.cedules_residence }}">
                        </div>
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Barème frais signification (Article 81)</h5>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label class="form-label">Premier original (F)</label>
                            <input type="number" id="cedules_premier_original" class="form-input"
                                   value="{{ config.cedules_premier_original }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Deuxième original (F)</label>
                            <input type="number" id="cedules_deuxieme_original" class="form-input"
                                   value="{{ config.cedules_deuxieme_original }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Copie (F)</label>
                            <input type="number" id="cedules_copie" class="form-input"
                                   value="{{ config.cedules_copie }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mention répertoire (F)</label>
                            <input type="number" id="cedules_mention_repertoire" class="form-input"
                                   value="{{ config.cedules_mention_repertoire }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vacation (F)</label>
                            <input type="number" id="cedules_vacation" class="form-input"
                                   value="{{ config.cedules_vacation }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Frais copie par rôle (Art. 82) (F)</label>
                            <input type="number" id="cedules_frais_copie_role" class="form-input"
                                   value="{{ config.cedules_frais_copie_role }}">
                        </div>
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Transport et mission</h5>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label class="form-label">Tarif kilométrique (Art. 45) (F/km)</label>
                            <input type="number" id="cedules_tarif_km" class="form-input"
                                   value="{{ config.cedules_tarif_km }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seuil transport (Art. 89) (km)</label>
                            <input type="number" id="cedules_seuil_transport" class="form-input"
                                   value="{{ config.cedules_seuil_transport }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seuil frais mission (km)</label>
                            <input type="number" id="cedules_seuil_mission" class="form-input"
                                   value="{{ config.cedules_seuil_mission }}">
                        </div>
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Barème frais mission Groupe II</h5>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label class="form-label">1 repas (F)</label>
                            <input type="number" id="cedules_mission_1_repas" class="form-input"
                                   value="{{ config.cedules_mission_1_repas }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">2 repas (F)</label>
                            <input type="number" id="cedules_mission_2_repas" class="form-input"
                                   value="{{ config.cedules_mission_2_repas }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Journée complète (F)</label>
                            <input type="number" id="cedules_mission_journee" class="form-input"
                                   value="{{ config.cedules_mission_journee }}">
                        </div>
                    </div>
                    <small class="form-help">Modifiable si changement réglementaire</small>
                </div>
            </div>

            <!-- 2.9 Agenda -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="calendar"></i> Agenda</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Heure début journée</label>
                            <input type="time" id="agenda_heure_debut" class="form-input"
                                   value="{{ config.agenda_heure_debut|time:'H:i' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Heure fin journée</label>
                            <input type="time" id="agenda_heure_fin" class="form-input"
                                   value="{{ config.agenda_heure_fin|time:'H:i' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Durée RDV par défaut (minutes)</label>
                            <input type="number" id="agenda_duree_rdv" class="form-input"
                                   value="{{ config.agenda_duree_rdv }}" min="15" step="15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rappel par défaut (jours avant)</label>
                            <input type="number" id="agenda_rappel_jours" class="form-input"
                                   value="{{ config.agenda_rappel_jours }}" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rappel par défaut (heures avant)</label>
                            <input type="number" id="agenda_rappel_heures" class="form-input"
                                   value="{{ config.agenda_rappel_heures }}" min="0">
                        </div>
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Jours ouvrés</h5>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <label class="switch-container">
                            <input type="checkbox" id="jour_1" class="jour-ouvre" value="1"
                                   {% if 1 in config.agenda_jours_ouvres %}checked{% endif %}>
                            <span>Lundi</span>
                        </label>
                        <label class="switch-container">
                            <input type="checkbox" id="jour_2" class="jour-ouvre" value="2"
                                   {% if 2 in config.agenda_jours_ouvres %}checked{% endif %}>
                            <span>Mardi</span>
                        </label>
                        <label class="switch-container">
                            <input type="checkbox" id="jour_3" class="jour-ouvre" value="3"
                                   {% if 3 in config.agenda_jours_ouvres %}checked{% endif %}>
                            <span>Mercredi</span>
                        </label>
                        <label class="switch-container">
                            <input type="checkbox" id="jour_4" class="jour-ouvre" value="4"
                                   {% if 4 in config.agenda_jours_ouvres %}checked{% endif %}>
                            <span>Jeudi</span>
                        </label>
                        <label class="switch-container">
                            <input type="checkbox" id="jour_5" class="jour-ouvre" value="5"
                                   {% if 5 in config.agenda_jours_ouvres %}checked{% endif %}>
                            <span>Vendredi</span>
                        </label>
                        <label class="switch-container">
                            <input type="checkbox" id="jour_6" class="jour-ouvre" value="6"
                                   {% if 6 in config.agenda_jours_ouvres %}checked{% endif %}>
                            <span>Samedi</span>
                        </label>
                        <label class="switch-container">
                            <input type="checkbox" id="jour_0" class="jour-ouvre" value="0"
                                   {% if 0 in config.agenda_jours_ouvres %}checked{% endif %}>
                            <span>Dimanche</span>
                        </label>
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Jours fériés Bénin</h5>
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Actif</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for jour in jours_feries %}
                                <tr>
                                    <td>{{ jour.nom }}</td>
                                    <td>
                                        {% if jour.jour_mois and jour.mois %}
                                            {{ jour.jour_mois }}/{{ jour.mois }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{% if jour.est_mobile %}Mobile{% else %}Fixe{% endif %}</td>
                                    <td>
                                        {% if jour.actif %}
                                            <i data-lucide="check" style="color: var(--success); width: 16px;"></i>
                                        {% else %}
                                            <i data-lucide="x" style="color: var(--danger); width: 16px;"></i>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--neutral-500);">
                                        Aucun jour férié configuré
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bouton enregistrer section -->
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="sauvegarderSection('modules')">
                    <i data-lucide="save"></i> Enregistrer les paramètres des modules
                </button>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- SECTION 3 : MODÈLES DE DOCUMENTS -->
        <!-- ============================================== -->
        <div id="tab-documents" class="tab-content">
            <!-- Gestion des modèles -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="files"></i> Gestion des modèles</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <!-- Filtres par catégorie -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Filtrer par catégorie</label>
                        <select id="filter_categorie_modele" class="form-select" style="max-width: 300px;" onchange="filterModeles()">
                            <option value="">Toutes les catégories</option>
                            <option value="actes">Actes de procédure</option>
                            <option value="factures">Factures et devis</option>
                            <option value="courriers">Courriers</option>
                            <option value="baux">Contrats de bail</option>
                            <option value="etats_lieux">États des lieux</option>
                            <option value="paie">Bulletins de paie</option>
                            <option value="memoires">Mémoires de frais</option>
                            <option value="rapports">Rapports</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table class="table" id="modeles_table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Catégorie</th>
                                    <th>Dernière modification</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for modele in modeles_document %}
                                <tr data-categorie="{{ modele.categorie }}">
                                    <td>{{ modele.nom }}</td>
                                    <td>{{ modele.get_categorie_display }}</td>
                                    <td>{{ modele.date_modification|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-icon" onclick="previewModele({{ modele.id }})" title="Aperçu">
                                            <i data-lucide="eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-icon" onclick="editModele({{ modele.id }})" title="Modifier">
                                            <i data-lucide="edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-icon" onclick="duplicateModele({{ modele.id }})" title="Dupliquer">
                                            <i data-lucide="copy"></i>
                                        </button>
                                        <button class="btn btn-sm btn-icon" onclick="downloadModele({{ modele.id }})" title="Télécharger">
                                            <i data-lucide="download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-icon btn-danger" onclick="deleteModele({{ modele.id }})" title="Supprimer">
                                            <i data-lucide="trash-2"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--neutral-500);">
                                        Aucun modèle de document configuré
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-primary mt-3" onclick="openModeleModal()">
                        <i data-lucide="plus"></i> Créer un modèle
                    </button>
                </div>
            </div>

            <!-- Variables disponibles -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="variable"></i> Variables disponibles</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <p style="color: var(--neutral-600); margin-bottom: 16px;">
                        Utilisez ces variables dans vos modèles. Elles seront automatiquement remplacées lors de la génération.
                    </p>
                    <div class="form-grid-3">
                        {% for var in variables_modeles %}
                        <div class="variable-item" style="padding: 10px; background: var(--neutral-50); border-radius: 6px; cursor: pointer;" onclick="copyVariable('{{ var.code }}')">
                            <code style="color: var(--primary); font-weight: 600;">{{ var.code }}</code>
                            <div style="font-size: 12px; color: var(--neutral-500); margin-top: 4px;">{{ var.description }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- SECTION 4 : NOTIFICATIONS ET ALERTES -->
        <!-- ============================================== -->
        <div id="tab-notifications" class="tab-content">
            <!-- Configuration des alertes -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="bell-ring"></i> Configuration des alertes</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Type d'alerte</th>
                                    <th style="text-align: center;">App</th>
                                    <th style="text-align: center;">Email</th>
                                    <th style="text-align: center;">SMS</th>
                                    <th>Délai</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>RDV à venir</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="rdv_a_venir" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="rdv_a_venir" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="rdv_a_venir" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="1 jour" data-type="rdv_a_venir" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Tâche en retard</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="tache_retard" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="tache_retard" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="tache_retard" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="Immédiat" data-type="tache_retard" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Facture impayée > 30 jours</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="facture_impayee" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="facture_impayee" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="facture_impayee" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="Quotidien" data-type="facture_impayee" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Solde caisse faible</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="solde_caisse_faible" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="solde_caisse_faible" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="solde_caisse_faible" data-channel="sms" checked></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="Immédiat" data-type="solde_caisse_faible" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Décaissement en attente</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="decaissement_attente" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="decaissement_attente" data-channel="email"></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="decaissement_attente" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="Immédiat" data-type="decaissement_attente" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Fin de contrat employé</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="fin_contrat" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="fin_contrat" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="fin_contrat" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="30 jours" data-type="fin_contrat" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Loyer impayé</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="loyer_impaye" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="loyer_impaye" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="loyer_impaye" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="J+5" data-type="loyer_impaye" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Reversement à effectuer</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="reversement" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="reversement" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="reversement" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="Quotidien" data-type="reversement" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Échéance fiscale</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="echeance_fiscale" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="echeance_fiscale" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="echeance_fiscale" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="7 jours" data-type="echeance_fiscale" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Audience à venir</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="audience" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="audience" data-channel="email" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="audience" data-channel="sms" checked></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="2 jours" data-type="audience" data-field="delai"></td>
                                </tr>
                                <tr>
                                    <td>Dossier sans activité</td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="dossier_inactif" data-channel="app" checked></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="dossier_inactif" data-channel="email"></td>
                                    <td style="text-align: center;"><input type="checkbox" class="notif-checkbox" data-type="dossier_inactif" data-channel="sms"></td>
                                    <td><input type="text" class="form-input" style="width: 120px;" value="30 jours" data-type="dossier_inactif" data-field="delai"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Configuration Email -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="mail"></i> Configuration Email (SMTP)</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Serveur SMTP</label>
                            <input type="text" id="smtp_serveur" class="form-input"
                                   value="{{ config.smtp_serveur }}" placeholder="smtp.gmail.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Port</label>
                            <input type="number" id="smtp_port" class="form-input"
                                   value="{{ config.smtp_port }}" placeholder="587">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Utilisateur</label>
                            <input type="text" id="smtp_utilisateur" class="form-input"
                                   value="{{ config.smtp_utilisateur }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mot de passe</label>
                            <input type="password" id="smtp_mot_de_passe" class="form-input"
                                   placeholder="••••••••">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Email expéditeur</label>
                            <input type="email" id="smtp_expediteur" class="form-input"
                                   value="{{ config.smtp_expediteur }}">
                        </div>
                    </div>
                    <button class="btn btn-secondary mt-3" onclick="testerSMTP()">
                        <i data-lucide="send"></i> Tester la configuration
                    </button>
                </div>
            </div>

            <!-- Configuration SMS -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="smartphone"></i> Configuration SMS (optionnel)</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Fournisseur</label>
                            <select id="sms_fournisseur" class="form-select">
                                <option value="">-- Sélectionner --</option>
                                <option value="twilio" {% if config.sms_fournisseur == 'twilio' %}selected{% endif %}>Twilio</option>
                                <option value="orange" {% if config.sms_fournisseur == 'orange' %}selected{% endif %}>Orange SMS API</option>
                                <option value="infobip" {% if config.sms_fournisseur == 'infobip' %}selected{% endif %}>Infobip</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" id="sms_api_key" class="form-input"
                                   placeholder="••••••••">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro expéditeur</label>
                            <input type="text" id="sms_expediteur" class="form-input"
                                   value="{{ config.sms_expediteur }}">
                        </div>
                    </div>
                    <button class="btn btn-secondary mt-3" onclick="testerSMS()">
                        <i data-lucide="send"></i> Tester la configuration
                    </button>
                </div>
            </div>

            <!-- Bouton enregistrer -->
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="sauvegarderNotifications()">
                    <i data-lucide="save"></i> Enregistrer les paramètres de notifications
                </button>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- SECTION 5 : SAUVEGARDES ET DONNÉES -->
        <!-- ============================================== -->
        <div id="tab-sauvegardes" class="tab-content">
            <!-- Sauvegardes automatiques -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="hard-drive"></i> Sauvegardes automatiques</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Activer les sauvegardes automatiques</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="backup_auto" {% if config.backup_auto %}checked{% endif %}>
                                    <span class="switch-slider"></span>
                                </label>
                                <span>{% if config.backup_auto %}Activé{% else %}Désactivé{% endif %}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fréquence</label>
                            <select id="backup_frequence" class="form-select">
                                <option value="quotidienne" {% if config.backup_frequence == 'quotidienne' %}selected{% endif %}>Quotidienne</option>
                                <option value="hebdomadaire" {% if config.backup_frequence == 'hebdomadaire' %}selected{% endif %}>Hebdomadaire</option>
                                <option value="mensuelle" {% if config.backup_frequence == 'mensuelle' %}selected{% endif %}>Mensuelle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Heure de sauvegarde</label>
                            <input type="time" id="backup_heure" class="form-input"
                                   value="{{ config.backup_heure|time:'H:i' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Conserver les sauvegardes (jours)</label>
                            <input type="number" id="backup_retention" class="form-input"
                                   value="{{ config.backup_retention }}" min="7" max="365">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Emplacement</label>
                            <select id="backup_emplacement" class="form-select">
                                <option value="local" {% if config.backup_emplacement == 'local' %}selected{% endif %}>Local</option>
                                <option value="google_drive" {% if config.backup_emplacement == 'google_drive' %}selected{% endif %}>Google Drive</option>
                                <option value="dropbox" {% if config.backup_emplacement == 'dropbox' %}selected{% endif %}>Dropbox</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historique des sauvegardes -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="history"></i> Historique des sauvegardes</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Taille</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup in sauvegardes %}
                                <tr>
                                    <td>{{ backup.date|date:"d/m/Y H:i" }}</td>
                                    <td>{{ backup.taille_formatee }}</td>
                                    <td>
                                        {% if backup.statut == 'reussi' %}
                                            <span class="status-badge active">
                                                <i data-lucide="check-circle" style="width: 14px;"></i> Réussi
                                            </span>
                                        {% elif backup.statut == 'echec' %}
                                            <span class="status-badge urgent">
                                                <i data-lucide="x-circle" style="width: 14px;"></i> Échec
                                            </span>
                                        {% else %}
                                            <span class="status-badge">
                                                <i data-lucide="loader" style="width: 14px;"></i> En cours
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="restaurerBackup({{ backup.id }})">
                                            <i data-lucide="rotate-ccw"></i> Restaurer
                                        </button>
                                        <button class="btn btn-sm btn-icon" onclick="downloadBackup({{ backup.id }})" title="Télécharger">
                                            <i data-lucide="download"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--neutral-500);">
                                        Aucune sauvegarde disponible
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-primary mt-3" onclick="creerBackup()">
                        <i data-lucide="hard-drive-download"></i> Créer une sauvegarde maintenant
                    </button>
                </div>
            </div>

            <!-- Export des données -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="download"></i> Export des données</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <button class="btn btn-secondary btn-block" onclick="exportData('json', 'all')">
                                <i data-lucide="file-json"></i> Exporter toutes les données (JSON)
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary btn-block" onclick="exportData('excel', 'dossiers')">
                                <i data-lucide="table"></i> Exporter les dossiers (Excel)
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary btn-block" onclick="exportData('excel', 'clients')">
                                <i data-lucide="users"></i> Exporter les clients (Excel)
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary btn-block" onclick="exportData('excel', 'factures')">
                                <i data-lucide="file-text"></i> Exporter les factures (Excel)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Import des données -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="upload"></i> Import des données</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Importer des clients</label>
                            <div class="file-upload" onclick="document.getElementById('import_clients').click()">
                                <i data-lucide="upload-cloud"></i>
                                <div class="file-upload-text">CSV ou Excel</div>
                            </div>
                            <input type="file" id="import_clients" accept=".csv,.xlsx" style="display:none" onchange="importData('clients', this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Importer des localités</label>
                            <div class="file-upload" onclick="document.getElementById('import_localites').click()">
                                <i data-lucide="upload-cloud"></i>
                                <div class="file-upload-text">CSV</div>
                            </div>
                            <input type="file" id="import_localites" accept=".csv" style="display:none" onchange="importData('localites', this)">
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i data-lucide="info"></i>
                        <span>Téléchargez les modèles de fichiers d'import pour connaître le format attendu.</span>
                    </div>
                </div>
            </div>

            <!-- Bouton enregistrer -->
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="sauvegarderSection('sauvegardes')">
                    <i data-lucide="save"></i> Enregistrer les paramètres de sauvegarde
                </button>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- SECTION 6 : PERSONNALISATION INTERFACE -->
        <!-- ============================================== -->
        <div id="tab-personnalisation" class="tab-content">
            <!-- Thème -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="sun-moon"></i> Thème</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Mode d'affichage</label>
                            <div class="toggle-group">
                                <button type="button" class="toggle-option {% if config.theme_mode == 'clair' %}active{% endif %}"
                                        onclick="setThemeMode('clair')">
                                    <i data-lucide="sun" style="width:16px;height:16px;"></i> Clair
                                </button>
                                <button type="button" class="toggle-option {% if config.theme_mode == 'sombre' %}active{% endif %}"
                                        onclick="setThemeMode('sombre')">
                                    <i data-lucide="moon" style="width:16px;height:16px;"></i> Sombre
                                </button>
                                <button type="button" class="toggle-option {% if config.theme_mode == 'auto' %}active{% endif %}"
                                        onclick="setThemeMode('auto')">
                                    <i data-lucide="monitor" style="width:16px;height:16px;"></i> Auto
                                </button>
                            </div>
                            <input type="hidden" id="theme_mode" value="{{ config.theme_mode }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Langue et formats -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="globe"></i> Langue et formats</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Langue</label>
                            <select class="form-select" disabled>
                                <option selected>Français</option>
                            </select>
                            <small class="form-help">Autres langues à venir</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Format des dates</label>
                            <select id="format_date" class="form-select">
                                <option value="DD/MM/YYYY" {% if config.format_date == 'DD/MM/YYYY' %}selected{% endif %}>JJ/MM/AAAA</option>
                                <option value="YYYY-MM-DD" {% if config.format_date == 'YYYY-MM-DD' %}selected{% endif %}>AAAA-MM-JJ</option>
                                <option value="DD MMMM YYYY" {% if config.format_date == 'DD MMMM YYYY' %}selected{% endif %}>JJ Mois AAAA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Séparateur milliers</label>
                            <select id="separateur_milliers" class="form-select">
                                <option value=" " {% if config.separateur_milliers == ' ' %}selected{% endif %}>Espace (1 000 000)</option>
                                <option value="." {% if config.separateur_milliers == '.' %}selected{% endif %}>Point (1.000.000)</option>
                                <option value="," {% if config.separateur_milliers == ',' %}selected{% endif %}>Virgule (1,000,000)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Séparateur décimales</label>
                            <select id="separateur_decimales" class="form-select">
                                <option value="," {% if config.separateur_decimales == ',' %}selected{% endif %}>Virgule (0,00)</option>
                                <option value="." {% if config.separateur_decimales == '.' %}selected{% endif %}>Point (0.00)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tableau de bord -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="layout-dashboard"></i> Tableau de bord</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label class="form-label">Période par défaut</label>
                        <div class="toggle-group" style="max-width: 300px;">
                            <button type="button" class="toggle-option {% if config.dashboard_periode == 'jour' %}active{% endif %}"
                                    onclick="setDashboardPeriode('jour')">Jour</button>
                            <button type="button" class="toggle-option {% if config.dashboard_periode == 'semaine' %}active{% endif %}"
                                    onclick="setDashboardPeriode('semaine')">Semaine</button>
                            <button type="button" class="toggle-option {% if config.dashboard_periode == 'mois' %}active{% endif %}"
                                    onclick="setDashboardPeriode('mois')">Mois</button>
                        </div>
                        <input type="hidden" id="dashboard_periode" value="{{ config.dashboard_periode }}">
                    </div>

                    <h5 style="margin: 24px 0 12px; color: var(--neutral-700);">Widgets actifs</h5>
                    <p style="color: var(--neutral-500); font-size: 13px; margin-bottom: 12px;">
                        Sélectionnez les widgets à afficher et réorganisez-les par glisser-déposer
                    </p>
                    <div class="widgets-list">
                        <label class="switch-container" style="padding: 10px; background: var(--neutral-50); border-radius: 6px; margin-bottom: 8px;">
                            <input type="checkbox" class="widget-checkbox" value="stats_dossiers" checked>
                            <span>Statistiques dossiers</span>
                        </label>
                        <label class="switch-container" style="padding: 10px; background: var(--neutral-50); border-radius: 6px; margin-bottom: 8px;">
                            <input type="checkbox" class="widget-checkbox" value="stats_facturation" checked>
                            <span>Statistiques facturation</span>
                        </label>
                        <label class="switch-container" style="padding: 10px; background: var(--neutral-50); border-radius: 6px; margin-bottom: 8px;">
                            <input type="checkbox" class="widget-checkbox" value="stats_tresorerie" checked>
                            <span>Statistiques trésorerie</span>
                        </label>
                        <label class="switch-container" style="padding: 10px; background: var(--neutral-50); border-radius: 6px; margin-bottom: 8px;">
                            <input type="checkbox" class="widget-checkbox" value="rdv_jour" checked>
                            <span>RDV du jour</span>
                        </label>
                        <label class="switch-container" style="padding: 10px; background: var(--neutral-50); border-radius: 6px; margin-bottom: 8px;">
                            <input type="checkbox" class="widget-checkbox" value="taches_urgentes" checked>
                            <span>Tâches urgentes</span>
                        </label>
                        <label class="switch-container" style="padding: 10px; background: var(--neutral-50); border-radius: 6px; margin-bottom: 8px;">
                            <input type="checkbox" class="widget-checkbox" value="factures_impayees" checked>
                            <span>Factures impayées</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Bouton enregistrer -->
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="sauvegarderSection('personnalisation')">
                    <i data-lucide="save"></i> Enregistrer les paramètres d'affichage
                </button>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- SECTION 7 : RÉFÉRENTIELS -->
        <!-- ============================================== -->
        <div id="tab-referentiels" class="tab-content">
            <!-- Table des localités -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="map-pin"></i> Table des localités</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div style="display: flex; gap: 16px; margin-bottom: 16px; align-items: center;">
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <input type="text" id="search_localite" class="form-input"
                                   placeholder="Rechercher une localité..." onkeyup="searchLocalites()">
                        </div>
                        <button class="btn btn-secondary" onclick="openLocaliteModal()">
                            <i data-lucide="plus"></i> Ajouter
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('import_localites_ref').click()">
                            <i data-lucide="upload"></i> Importer CSV
                        </button>
                        <input type="file" id="import_localites_ref" accept=".csv" style="display:none" onchange="importLocalites(this)">
                    </div>

                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Localité</th>
                                    <th>Département</th>
                                    <th>Distance (km)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="localites_tbody">
                                {% for loc in localites %}
                                <tr>
                                    <td>{{ loc.nom }}</td>
                                    <td>{{ loc.departement }}</td>
                                    <td>{{ loc.distance_km }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-icon" onclick="editLocalite({{ loc.id }})">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--neutral-500);">
                                        Aucune localité enregistrée
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Table des taux légaux -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="percent"></i> Taux légaux UEMOA</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Année</th>
                                    <th>Semestre</th>
                                    <th>Taux (%)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for taux in taux_legaux %}
                                <tr>
                                    <td>{{ taux.annee }}</td>
                                    <td>{{ taux.get_semestre_display }}</td>
                                    <td>{{ taux.taux }}%</td>
                                    <td>
                                        <button class="btn btn-sm btn-icon" onclick="editTauxLegal({{ taux.id }})">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--neutral-500);">
                                        Aucun taux enregistré
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-secondary mt-3" onclick="openTauxLegalModal()">
                        <i data-lucide="plus"></i> Ajouter un taux
                    </button>
                </div>
            </div>

            <!-- Types d'actes -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="file-signature"></i> Types d'actes</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Libellé</th>
                                    <th>Catégorie</th>
                                    <th>Montant défaut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for acte in types_actes %}
                                <tr>
                                    <td>{{ acte.code }}</td>
                                    <td>{{ acte.libelle }}</td>
                                    <td>{{ acte.categorie }}</td>
                                    <td>{{ acte.montant_defaut|floatformat:0 }} F</td>
                                    <td>
                                        <button class="btn btn-sm btn-icon" onclick="editTypeActe({{ acte.id }})">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--neutral-500);">
                                        Aucun type d'acte configuré
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-secondary mt-3" onclick="openTypeActeModal()">
                        <i data-lucide="plus"></i> Ajouter un type d'acte
                    </button>
                </div>
            </div>

            <!-- Juridictions -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="landmark"></i> Juridictions</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Nom</th>
                                    <th>Ville</th>
                                    <th>Téléphone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for jur in juridictions %}
                                <tr>
                                    <td>{{ jur.get_type_display }}</td>
                                    <td>{{ jur.nom }}</td>
                                    <td>{{ jur.ville }}</td>
                                    <td>{{ jur.telephone }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-icon" onclick="editJuridiction({{ jur.id }})">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--neutral-500);">
                                        Aucune juridiction enregistrée
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-secondary mt-3" onclick="openJuridictionModal()">
                        <i data-lucide="plus"></i> Ajouter une juridiction
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- SECTION 8 : À PROPOS -->
        <!-- ============================================== -->
        <div id="tab-apropos" class="tab-content">
            <!-- Informations système -->
            <div class="section-collapsible open">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="info"></i> Informations système</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Version de l'application</label>
                            <input type="text" class="form-input readonly" value="{{ config.version_app }}" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dernière mise à jour</label>
                            <input type="text" class="form-input readonly"
                                   value="{{ config.date_mise_a_jour|date:'d/m/Y'|default:'Non renseigné' }}" disabled>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Support technique</label>
                            <input type="text" class="form-input readonly" value="contact@etude-biaou.bj" disabled>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crédits -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="award"></i> Crédits</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div style="text-align: center; padding: 24px;">
                        <div style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--primary); margin-bottom: 12px;">
                            Gestion Étude Huissier
                        </div>
                        <div style="color: var(--neutral-600); margin-bottom: 20px;">
                            Solution de gestion complète pour les études d'huissiers de justice
                        </div>
                        <div style="font-size: 14px; color: var(--neutral-500);">
                            Développé pour l'Étude Me BIAOU<br>
                            &copy; 2025 - Tous droits réservés
                        </div>
                    </div>
                </div>
            </div>

            <!-- Journal des modifications -->
            <div class="section-collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h4><i data-lucide="history"></i> Journal des modifications</h4>
                    <i data-lucide="chevron-down" class="section-toggle"></i>
                </div>
                <div class="section-body">
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Utilisateur</th>
                                    <th>Section</th>
                                    <th>Champ</th>
                                    <th>Ancienne valeur</th>
                                    <th>Nouvelle valeur</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in journal %}
                                <tr>
                                    <td>{{ log.date|date:"d/m/Y H:i" }}</td>
                                    <td>{{ log.utilisateur.get_full_name|default:"Système" }}</td>
                                    <td>{{ log.section }}</td>
                                    <td>{{ log.champ }}</td>
                                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                                        {{ log.ancienne_valeur|truncatechars:30 }}
                                    </td>
                                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                                        {{ log.nouvelle_valeur|truncatechars:30 }}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--neutral-500);">
                                        Aucune modification enregistrée
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================== -->
<!-- MODALES -->
<!-- ============================================== -->

<!-- Modal Site/Agence -->
<div id="modalSite" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modalSiteTitle">Ajouter un site</h3>
            <button class="btn btn-icon" onclick="fermerModal('modalSite')">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="siteId">
            <div class="form-group">
                <label class="form-label">Nom du site *</label>
                <input type="text" id="siteNom" class="form-input" required placeholder="Ex: Bureau principal, Annexe...">
            </div>
            <div class="form-group">
                <label class="form-label">Adresse</label>
                <input type="text" id="siteAdresse" class="form-input" placeholder="Adresse complète">
            </div>
            <div class="form-group">
                <label class="form-label">Téléphone</label>
                <input type="tel" id="siteTelephone" class="form-input" placeholder="+229 XX XX XX XX">
            </div>
            <div class="form-group">
                <label class="form-label">Responsable</label>
                <input type="text" id="siteResponsable" class="form-input" placeholder="Nom du responsable">
            </div>
            <div class="form-group">
                <label class="switch-container">
                    <input type="checkbox" id="sitePrincipal">
                    <span class="switch-slider"></span>
                    <span style="margin-left: 10px;">Site principal</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fermerModal('modalSite')">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderSite()">
                <i data-lucide="save"></i> Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modal Type de Dossier -->
<div id="modalTypeDossier" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modalTypeDossierTitle">Ajouter un type de dossier</h3>
            <button class="btn btn-icon" onclick="fermerModal('modalTypeDossier')">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="typeDossierId">
            <div class="form-group">
                <label class="form-label">Code *</label>
                <input type="text" id="typeDossierCode" class="form-input" required placeholder="Ex: REC, EXP, SAI...">
            </div>
            <div class="form-group">
                <label class="form-label">Libellé *</label>
                <input type="text" id="typeDossierLibelle" class="form-input" required placeholder="Ex: Recouvrement de créances">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="typeDossierDescription" class="form-textarea" rows="2" placeholder="Description du type de dossier"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Couleur</label>
                <input type="color" id="typeDossierCouleur" class="form-input" value="#3b82f6" style="width: 60px; height: 40px; padding: 2px;">
            </div>
            <div class="form-group">
                <label class="switch-container">
                    <input type="checkbox" id="typeDossierActif" checked>
                    <span class="switch-slider"></span>
                    <span style="margin-left: 10px;">Actif</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fermerModal('modalTypeDossier')">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderTypeDossier()">
                <i data-lucide="save"></i> Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modal Statut de Dossier -->
<div id="modalStatutDossier" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modalStatutDossierTitle">Ajouter un statut de dossier</h3>
            <button class="btn btn-icon" onclick="fermerModal('modalStatutDossier')">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="statutDossierId">
            <div class="form-group">
                <label class="form-label">Code *</label>
                <input type="text" id="statutDossierCode" class="form-input" required placeholder="Ex: EN_COURS, CLOS...">
            </div>
            <div class="form-group">
                <label class="form-label">Libellé *</label>
                <input type="text" id="statutDossierLibelle" class="form-input" required placeholder="Ex: En cours de traitement">
            </div>
            <div class="form-group">
                <label class="form-label">Couleur</label>
                <input type="color" id="statutDossierCouleur" class="form-input" value="#10b981" style="width: 60px; height: 40px; padding: 2px;">
            </div>
            <div class="form-group">
                <label class="form-label">Ordre d'affichage</label>
                <input type="number" id="statutDossierOrdre" class="form-input" value="0" min="0">
            </div>
            <div class="form-group">
                <label class="switch-container">
                    <input type="checkbox" id="statutDossierActif" checked>
                    <span class="switch-slider"></span>
                    <span style="margin-left: 10px;">Actif</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fermerModal('modalStatutDossier')">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderStatutDossier()">
                <i data-lucide="save"></i> Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modal Localité -->
<div id="modalLocalite" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modalLocaliteTitle">Ajouter une localité</h3>
            <button class="btn btn-icon" onclick="fermerModal('modalLocalite')">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="localiteId">
            <div class="form-group">
                <label class="form-label">Nom de la localité *</label>
                <input type="text" id="localiteNom" class="form-input" required placeholder="Ex: Cotonou, Porto-Novo...">
            </div>
            <div class="form-group">
                <label class="form-label">Département</label>
                <input type="text" id="localiteDepartement" class="form-input" placeholder="Ex: Littoral, Atlantique...">
            </div>
            <div class="form-group">
                <label class="form-label">Distance depuis l'étude (km) *</label>
                <input type="number" id="localiteDistance" class="form-input" required min="0" step="0.1" placeholder="Distance en kilomètres">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fermerModal('modalLocalite')">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderLocalite()">
                <i data-lucide="save"></i> Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modal Taux Légal -->
<div id="modalTauxLegal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modalTauxLegalTitle">Ajouter un taux légal</h3>
            <button class="btn btn-icon" onclick="fermerModal('modalTauxLegal')">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="tauxLegalId">
            <div class="form-group">
                <label class="form-label">Année *</label>
                <input type="number" id="tauxLegalAnnee" class="form-input" required min="2000" max="2100" placeholder="Ex: 2024">
            </div>
            <div class="form-group">
                <label class="form-label">Semestre *</label>
                <select id="tauxLegalSemestre" class="form-select" required>
                    <option value="1">1er semestre (Jan-Juin)</option>
                    <option value="2">2ème semestre (Juil-Déc)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Taux (%) *</label>
                <input type="number" id="tauxLegalTaux" class="form-input" required min="0" step="0.01" placeholder="Ex: 3.25">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fermerModal('modalTauxLegal')">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderTauxLegal()">
                <i data-lucide="save"></i> Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modal Type d'Acte -->
<div id="modalTypeActe" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modalTypeActeTitle">Ajouter un type d'acte</h3>
            <button class="btn btn-icon" onclick="fermerModal('modalTypeActe')">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="typeActeId">
            <div class="form-group">
                <label class="form-label">Code *</label>
                <input type="text" id="typeActeCode" class="form-input" required placeholder="Ex: CMD, SOM, PV...">
            </div>
            <div class="form-group">
                <label class="form-label">Libellé *</label>
                <input type="text" id="typeActeLibelle" class="form-input" required placeholder="Ex: Commandement de payer">
            </div>
            <div class="form-group">
                <label class="form-label">Catégorie</label>
                <select id="typeActeCategorie" class="form-select">
                    <option value="signification">Signification</option>
                    <option value="execution">Exécution</option>
                    <option value="constat">Constat</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Montant par défaut (F CFA)</label>
                <input type="number" id="typeActeMontant" class="form-input" min="0" placeholder="Ex: 15000">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fermerModal('modalTypeActe')">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderTypeActe()">
                <i data-lucide="save"></i> Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modal Juridiction -->
<div id="modalJuridiction" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modalJuridictionTitle">Ajouter une juridiction</h3>
            <button class="btn btn-icon" onclick="fermerModal('modalJuridiction')">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="juridictionId">
            <div class="form-group">
                <label class="form-label">Type *</label>
                <select id="juridictionType" class="form-select" required>
                    <option value="TPI">Tribunal de Première Instance</option>
                    <option value="TCC">Tribunal de Commerce</option>
                    <option value="CA">Cour d'Appel</option>
                    <option value="CS">Cour Suprême</option>
                    <option value="CCJA">CCJA (OHADA)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Nom *</label>
                <input type="text" id="juridictionNom" class="form-input" required placeholder="Ex: Tribunal de Première Instance de Cotonou">
            </div>
            <div class="form-group">
                <label class="form-label">Ville *</label>
                <input type="text" id="juridictionVille" class="form-input" required placeholder="Ex: Cotonou">
            </div>
            <div class="form-group">
                <label class="form-label">Adresse</label>
                <input type="text" id="juridictionAdresse" class="form-input" placeholder="Adresse complète">
            </div>
            <div class="form-group">
                <label class="form-label">Téléphone</label>
                <input type="tel" id="juridictionTelephone" class="form-input" placeholder="+229 XX XX XX XX">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fermerModal('modalJuridiction')">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderJuridiction()">
                <i data-lucide="save"></i> Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Styles pour les modales -->
<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}
.modal-container {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--neutral-200);
}
.modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}
.modal-body {
    padding: 24px;
}
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid var(--neutral-200);
    background: var(--neutral-50);
    border-radius: 0 0 12px 12px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Initialiser Lucide
    lucide.createIcons();

    // Navigation par onglets
    function showTab(tabId) {
        // Masquer tous les contenus
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        // Désactiver tous les boutons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        // Afficher le contenu sélectionné
        document.getElementById('tab-' + tabId).classList.add('active');
        // Activer le bouton
        event.target.closest('.tab-btn').classList.add('active');

        // Réinitialiser les icônes Lucide
        lucide.createIcons();
    }

    // Sections repliables
    function toggleSection(header) {
        const section = header.closest('.section-collapsible');
        section.classList.toggle('open');
        lucide.createIcons();
    }

    // Mise à jour couleur preview
    function updateColorPreview(type) {
        const colorInput = document.getElementById('couleur_' + type);
        const textInput = document.getElementById('couleur_' + type + '_text');
        const preview = document.getElementById('preview_' + type);

        textInput.value = colorInput.value;
        preview.style.background = colorInput.value;
    }

    // Preview et upload logo
    function previewLogo(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logo_preview').innerHTML =
                    '<img src="' + e.target.result + '" alt="Logo">';
            };
            reader.readAsDataURL(file);

            // Upload au serveur
            uploadImage(file, 'logo');
        }
    }

    // Preview et upload signature
    function previewSignature(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('signature_preview').innerHTML =
                    '<img src="' + e.target.result + '" alt="Signature" style="max-height: 100px; max-width: 100%;">';
            };
            reader.readAsDataURL(file);

            // Upload au serveur
            uploadImage(file, 'signature');
        }
    }

    // Upload image générique
    function uploadImage(file, imageType) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', imageType);

        fetch('{% url "parametres:api_upload_image" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('success', result.message);
            } else {
                showNotification('error', 'Erreur: ' + result.error);
            }
        })
        .catch(error => {
            showNotification('error', 'Erreur de connexion');
        });
    }

    // Mode MECeF
    function setMecefMode(mode) {
        document.getElementById('mecef_mode').value = mode;
        document.querySelectorAll('.toggle-option').forEach(opt => {
            opt.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    // TVA toggle label
    document.getElementById('tva_applicable').addEventListener('change', function() {
        document.getElementById('tva_label').textContent = this.checked ? 'Oui' : 'Non';
    });

    // Drag and drop pour ordre imputation
    const ordreList = document.getElementById('ordre_imputation');
    if (ordreList) {
        let draggedItem = null;

        ordreList.querySelectorAll('.ordre-item').forEach(item => {
            item.addEventListener('dragstart', function() {
                draggedItem = this;
                this.classList.add('dragging');
            });

            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                updateOrdreNumbers();
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(ordreList, e.clientY);
                if (afterElement == null) {
                    ordreList.appendChild(draggedItem);
                } else {
                    ordreList.insertBefore(draggedItem, afterElement);
                }
            });
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.ordre-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateOrdreNumbers() {
            ordreList.querySelectorAll('.ordre-item').forEach((item, index) => {
                item.querySelector('.ordre-number').textContent = index + 1;
            });
        }
    }

    // Sauvegarde par section
    function sauvegarderSection(section) {
        let data = { section: section };

        if (section === 'etude') {
            // Section Étude
            data.nom_etude = document.getElementById('nom_etude').value;
            data.titre = document.getElementById('titre').value;
            data.juridiction = document.getElementById('juridiction').value;
            data.date_installation = document.getElementById('date_installation').value;
            data.numero_ifu = document.getElementById('numero_ifu').value;
            data.numero_rccm = document.getElementById('numero_rccm').value;
            data.numero_agrement = document.getElementById('numero_agrement').value;
            data.adresse_rue = document.getElementById('adresse_rue').value;
            data.adresse_quartier = document.getElementById('adresse_quartier').value;
            data.adresse_ville = document.getElementById('adresse_ville').value;
            data.adresse_bp = document.getElementById('adresse_bp').value;
            data.telephone_fixe = document.getElementById('telephone_fixe').value;
            data.telephone_mobile1 = document.getElementById('telephone_mobile1').value;
            data.telephone_mobile2 = document.getElementById('telephone_mobile2').value;
            data.email = document.getElementById('email').value;
            data.site_web = document.getElementById('site_web').value;
            data.couleur_principale = document.getElementById('couleur_principale').value;
            data.couleur_secondaire = document.getElementById('couleur_secondaire').value;

            // Sauvegarder aussi la banque
            sauvegarderBanque();
        }

        if (section === 'modules') {
            // Sauvegarder toutes les sous-sections
            sauvegarderDossiers();
            sauvegarderFacturation();
            sauvegarderTresorerie();
            sauvegarderComptabilite();
            sauvegarderRecouvrement();
            sauvegarderGerance();
            sauvegarderRH();
            sauvegarderCedules();
            sauvegarderAgenda();
            return; // Les sous-fonctions gèrent la sauvegarde
        }

        envoyerConfig(data);
    }

    function sauvegarderBanque() {
        const data = {
            section: 'banque',
            banque_nom: document.getElementById('banque_nom').value,
            banque_code: document.getElementById('banque_code').value,
            banque_guichet: document.getElementById('banque_guichet').value,
            banque_compte: document.getElementById('banque_compte').value,
            banque_cle: document.getElementById('banque_cle').value,
            banque_iban: document.getElementById('banque_iban').value,
            banque_titulaire: document.getElementById('banque_titulaire').value,
            mobile_money_operateur: document.getElementById('mobile_money_operateur').value,
            mobile_money_numero: document.getElementById('mobile_money_numero').value
        };
        envoyerConfig(data);
    }

    function sauvegarderDossiers() {
        const data = {
            section: 'dossiers',
            dossier_prefixe: document.getElementById('dossier_prefixe').value,
            dossier_numero_depart: document.getElementById('dossier_numero_depart').value
        };
        envoyerConfig(data);
    }

    function sauvegarderFacturation() {
        const data = {
            section: 'facturation',
            facture_prefixe: document.getElementById('facture_prefixe').value,
            tva_applicable: document.getElementById('tva_applicable').checked,
            tva_taux: document.getElementById('tva_taux').value,
            facture_delai_paiement: document.getElementById('facture_delai_paiement').value,
            facture_conditions_paiement: document.getElementById('facture_conditions_paiement').value,
            facture_penalites_retard: document.getElementById('facture_penalites_retard').value,
            mecef_nim: document.getElementById('mecef_nim').value,
            mecef_token: document.getElementById('mecef_token').value,
            mecef_mode: document.getElementById('mecef_mode').value,
            facture_mentions_legales: document.getElementById('facture_mentions_legales').value
        };
        envoyerConfig(data);
    }

    function sauvegarderTresorerie() {
        const data = {
            section: 'tresorerie',
            tresorerie_seuil_alerte: document.getElementById('tresorerie_seuil_alerte').value,
            tresorerie_validation_seuil: document.getElementById('tresorerie_validation_seuil').value,
            tresorerie_delai_reversement: document.getElementById('tresorerie_delai_reversement').value,
            tresorerie_compte_sequestre: document.getElementById('tresorerie_compte_sequestre').checked
        };
        envoyerConfig(data);
    }

    function sauvegarderComptabilite() {
        const data = {
            section: 'comptabilite',
            exercice_debut: document.getElementById('exercice_debut').value,
            exercice_fin: document.getElementById('exercice_fin').value,
            comptabilite_mode: document.getElementById('comptabilite_mode').value,
            regime_fiscal: document.getElementById('regime_fiscal').value,
            tva_declaration: document.getElementById('tva_declaration').value,
            echeances_rappel_jours: document.getElementById('echeances_rappel_jours').value
        };
        envoyerConfig(data);
    }

    function sauvegarderRecouvrement() {
        // Récupérer l'ordre d'imputation
        const ordreItems = document.querySelectorAll('#ordre_imputation .ordre-item');
        const ordre = Array.from(ordreItems).map(item => item.dataset.value);

        const data = {
            section: 'recouvrement',
            recouvrement_majoration_50: document.getElementById('recouvrement_majoration_50').checked,
            recouvrement_delai_majoration: document.getElementById('recouvrement_delai_majoration').value,
            recouvrement_ordre_imputation: ordre
        };
        envoyerConfig(data);
    }

    function sauvegarderGerance() {
        const data = {
            section: 'gerance',
            gerance_taux_honoraires: document.getElementById('gerance_taux_honoraires').value,
            gerance_date_reversement: document.getElementById('gerance_date_reversement').value,
            gerance_relance_niveau1: document.getElementById('gerance_relance_niveau1').value,
            gerance_relance_niveau2: document.getElementById('gerance_relance_niveau2').value,
            gerance_relance_niveau3: document.getElementById('gerance_relance_niveau3').value,
            gerance_relance_niveau4: document.getElementById('gerance_relance_niveau4').value
        };
        envoyerConfig(data);
    }

    function sauvegarderRH() {
        const data = {
            section: 'rh',
            rh_smig: document.getElementById('rh_smig').value,
            rh_plafond_cnss: document.getElementById('rh_plafond_cnss').value,
            rh_cnss_salarial_vieillesse: document.getElementById('rh_cnss_salarial_vieillesse').value,
            rh_cnss_patronal_pf: document.getElementById('rh_cnss_patronal_pf').value,
            rh_cnss_patronal_vieillesse: document.getElementById('rh_cnss_patronal_vieillesse').value,
            rh_cnss_patronal_at: document.getElementById('rh_cnss_patronal_at').value,
            rh_conges_annuels: document.getElementById('rh_conges_annuels').value,
            rh_heures_hebdo: document.getElementById('rh_heures_hebdo').value,
            rh_jour_paie: document.getElementById('rh_jour_paie').value
        };
        envoyerConfig(data);
    }

    function sauvegarderCedules() {
        const data = {
            section: 'cedules',
            cedules_residence: document.getElementById('cedules_residence').value,
            cedules_premier_original: document.getElementById('cedules_premier_original').value,
            cedules_deuxieme_original: document.getElementById('cedules_deuxieme_original').value,
            cedules_copie: document.getElementById('cedules_copie').value,
            cedules_mention_repertoire: document.getElementById('cedules_mention_repertoire').value,
            cedules_vacation: document.getElementById('cedules_vacation').value,
            cedules_frais_copie_role: document.getElementById('cedules_frais_copie_role').value,
            cedules_tarif_km: document.getElementById('cedules_tarif_km').value,
            cedules_seuil_transport: document.getElementById('cedules_seuil_transport').value,
            cedules_seuil_mission: document.getElementById('cedules_seuil_mission').value,
            cedules_mission_1_repas: document.getElementById('cedules_mission_1_repas').value,
            cedules_mission_2_repas: document.getElementById('cedules_mission_2_repas').value,
            cedules_mission_journee: document.getElementById('cedules_mission_journee').value
        };
        envoyerConfig(data);
    }

    function sauvegarderAgenda() {
        // Récupérer les jours ouvrés
        const joursOuvres = [];
        document.querySelectorAll('.jour-ouvre:checked').forEach(cb => {
            joursOuvres.push(parseInt(cb.value));
        });

        const data = {
            section: 'agenda',
            agenda_heure_debut: document.getElementById('agenda_heure_debut').value,
            agenda_heure_fin: document.getElementById('agenda_heure_fin').value,
            agenda_duree_rdv: document.getElementById('agenda_duree_rdv').value,
            agenda_rappel_jours: document.getElementById('agenda_rappel_jours').value,
            agenda_rappel_heures: document.getElementById('agenda_rappel_heures').value,
            agenda_jours_ouvres: joursOuvres
        };
        envoyerConfig(data);
    }

    function envoyerConfig(data) {
        fetch('{% url "parametres:api_sauvegarder_config" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('success', result.message);
            } else {
                showNotification('error', 'Erreur: ' + result.error);
            }
        })
        .catch(error => {
            showNotification('error', 'Erreur de connexion');
        });
    }

    // Notification toast
    function showNotification(type, message) {
        // Créer le toast
        const toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.innerHTML = `
            <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
            <span>${message}</span>
        `;
        toast.style.cssText = `
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        `;

        document.body.appendChild(toast);
        lucide.createIcons();

        setTimeout(() => {
            toast.style.animation = 'slideDown 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Ajouter les keyframes d'animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(100px); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // ========== Fonctions utilitaires modales ==========
    function ouvrirModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
        lucide.createIcons();
    }

    function fermerModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Fermer modal en cliquant sur l'overlay
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });

    // ========== Sites/Agences ==========
    function openSiteModal() {
        document.getElementById('siteId').value = '';
        document.getElementById('modalSiteTitle').textContent = 'Ajouter un site';
        document.getElementById('siteNom').value = '';
        document.getElementById('siteAdresse').value = '';
        document.getElementById('siteTelephone').value = '';
        document.getElementById('siteResponsable').value = '';
        document.getElementById('sitePrincipal').checked = false;
        ouvrirModal('modalSite');
    }

    function editSite(id) {
        document.getElementById('siteId').value = id;
        document.getElementById('modalSiteTitle').textContent = 'Modifier le site';

        fetch(`{% url "parametres:api_sites_list" %}`)
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    const site = result.data.find(s => s.id === id);
                    if (site) {
                        document.getElementById('siteNom').value = site.nom || '';
                        document.getElementById('siteAdresse').value = site.adresse || '';
                        document.getElementById('siteTelephone').value = site.telephone || '';
                        document.getElementById('siteResponsable').value = site.responsable || '';
                        document.getElementById('sitePrincipal').checked = site.est_principal || false;
                        ouvrirModal('modalSite');
                    }
                }
            });
    }

    function sauvegarderSite() {
        const id = document.getElementById('siteId').value;
        const data = {
            nom: document.getElementById('siteNom').value,
            adresse: document.getElementById('siteAdresse').value,
            telephone: document.getElementById('siteTelephone').value,
            responsable: document.getElementById('siteResponsable').value,
            est_principal: document.getElementById('sitePrincipal').checked
        };

        if (!data.nom) {
            showNotification('error', 'Le nom du site est obligatoire');
            return;
        }

        const url = id ?
            `{% url "parametres:api_site_update" site_id=0 %}`.replace('0', id) :
            '{% url "parametres:api_site_create" %}';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                fermerModal('modalSite');
                showNotification('success', result.message);
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('error', result.error || 'Erreur');
            }
        })
        .catch(error => {
            showNotification('error', 'Erreur de connexion');
        });
    }

    function deleteSite(id) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce site ?')) {
            fetch(`{% url "parametres:api_site_delete" site_id=0 %}`.replace('0', id), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showNotification('success', result.message);
                    setTimeout(() => location.reload(), 500);
                } else {
                    showNotification('error', result.error || 'Erreur');
                }
            });
        }
    }

    // ========== Types de Dossiers ==========
    function openTypeDossierModal() {
        document.getElementById('typeDossierId').value = '';
        document.getElementById('modalTypeDossierTitle').textContent = 'Ajouter un type de dossier';
        document.getElementById('typeDossierCode').value = '';
        document.getElementById('typeDossierLibelle').value = '';
        document.getElementById('typeDossierDescription').value = '';
        document.getElementById('typeDossierCouleur').value = '#3b82f6';
        document.getElementById('typeDossierActif').checked = true;
        ouvrirModal('modalTypeDossier');
    }

    function editTypeDossier(id) {
        document.getElementById('typeDossierId').value = id;
        document.getElementById('modalTypeDossierTitle').textContent = 'Modifier le type de dossier';

        fetch('{% url "parametres:api_types_dossier_list" %}')
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    const type = result.data.find(t => t.id === id);
                    if (type) {
                        document.getElementById('typeDossierCode').value = type.code || '';
                        document.getElementById('typeDossierLibelle').value = type.libelle || '';
                        document.getElementById('typeDossierDescription').value = type.description || '';
                        document.getElementById('typeDossierCouleur').value = type.couleur || '#3b82f6';
                        document.getElementById('typeDossierActif').checked = type.actif !== false;
                        ouvrirModal('modalTypeDossier');
                    }
                }
            });
    }

    function sauvegarderTypeDossier() {
        const id = document.getElementById('typeDossierId').value;
        const data = {
            code: document.getElementById('typeDossierCode').value,
            libelle: document.getElementById('typeDossierLibelle').value,
            description: document.getElementById('typeDossierDescription').value,
            couleur: document.getElementById('typeDossierCouleur').value,
            actif: document.getElementById('typeDossierActif').checked
        };

        if (!data.code || !data.libelle) {
            showNotification('error', 'Le code et le libellé sont obligatoires');
            return;
        }

        const url = id ?
            `{% url "parametres:api_type_dossier_update" type_id=0 %}`.replace('0', id) :
            '{% url "parametres:api_type_dossier_create" %}';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                fermerModal('modalTypeDossier');
                showNotification('success', result.message);
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('error', result.error || 'Erreur');
            }
        });
    }

    // ========== Statuts de Dossiers ==========
    function openStatutDossierModal() {
        document.getElementById('statutDossierId').value = '';
        document.getElementById('modalStatutDossierTitle').textContent = 'Ajouter un statut de dossier';
        document.getElementById('statutDossierCode').value = '';
        document.getElementById('statutDossierLibelle').value = '';
        document.getElementById('statutDossierCouleur').value = '#10b981';
        document.getElementById('statutDossierOrdre').value = '0';
        document.getElementById('statutDossierActif').checked = true;
        ouvrirModal('modalStatutDossier');
    }

    function editStatutDossier(id) {
        document.getElementById('statutDossierId').value = id;
        document.getElementById('modalStatutDossierTitle').textContent = 'Modifier le statut de dossier';

        fetch('{% url "parametres:api_statuts_dossier_list" %}')
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    const statut = result.data.find(s => s.id === id);
                    if (statut) {
                        document.getElementById('statutDossierCode').value = statut.code || '';
                        document.getElementById('statutDossierLibelle').value = statut.libelle || '';
                        document.getElementById('statutDossierCouleur').value = statut.couleur || '#10b981';
                        document.getElementById('statutDossierOrdre').value = statut.ordre || 0;
                        document.getElementById('statutDossierActif').checked = statut.actif !== false;
                        ouvrirModal('modalStatutDossier');
                    }
                }
            });
    }

    function sauvegarderStatutDossier() {
        const id = document.getElementById('statutDossierId').value;
        const data = {
            code: document.getElementById('statutDossierCode').value,
            libelle: document.getElementById('statutDossierLibelle').value,
            couleur: document.getElementById('statutDossierCouleur').value,
            ordre: parseInt(document.getElementById('statutDossierOrdre').value) || 0,
            actif: document.getElementById('statutDossierActif').checked
        };

        if (!data.code || !data.libelle) {
            showNotification('error', 'Le code et le libellé sont obligatoires');
            return;
        }

        const url = id ?
            `{% url "parametres:api_statut_dossier_update" statut_id=0 %}`.replace('0', id) :
            '{% url "parametres:api_statut_dossier_create" %}';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                fermerModal('modalStatutDossier');
                showNotification('success', result.message);
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('error', result.error || 'Erreur');
            }
        });
    }

    // ========== Localités ==========
    function openLocaliteModal() {
        document.getElementById('localiteId').value = '';
        document.getElementById('modalLocaliteTitle').textContent = 'Ajouter une localité';
        document.getElementById('localiteNom').value = '';
        document.getElementById('localiteDepartement').value = '';
        document.getElementById('localiteDistance').value = '';
        ouvrirModal('modalLocalite');
    }

    function editLocalite(id) {
        document.getElementById('localiteId').value = id;
        document.getElementById('modalLocaliteTitle').textContent = 'Modifier la localité';

        fetch('{% url "parametres:api_localites_list" %}')
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    const loc = result.data.find(l => l.id === id);
                    if (loc) {
                        document.getElementById('localiteNom').value = loc.nom || '';
                        document.getElementById('localiteDepartement').value = loc.departement || '';
                        document.getElementById('localiteDistance').value = loc.distance_km || '';
                        ouvrirModal('modalLocalite');
                    }
                }
            });
    }

    function sauvegarderLocalite() {
        const id = document.getElementById('localiteId').value;
        const data = {
            nom: document.getElementById('localiteNom').value,
            departement: document.getElementById('localiteDepartement').value,
            distance_km: parseFloat(document.getElementById('localiteDistance').value) || 0
        };

        if (!data.nom) {
            showNotification('error', 'Le nom de la localité est obligatoire');
            return;
        }

        const url = id ?
            `{% url "parametres:api_localite_update" localite_id=0 %}`.replace('0', id) :
            '{% url "parametres:api_localite_create" %}';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                fermerModal('modalLocalite');
                showNotification('success', result.message);
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('error', result.error || 'Erreur');
            }
        });
    }

    // ========== Taux Légaux ==========
    function openTauxLegalModal() {
        document.getElementById('tauxLegalId').value = '';
        document.getElementById('modalTauxLegalTitle').textContent = 'Ajouter un taux légal';
        document.getElementById('tauxLegalAnnee').value = new Date().getFullYear();
        document.getElementById('tauxLegalSemestre').value = '1';
        document.getElementById('tauxLegalTaux').value = '';
        ouvrirModal('modalTauxLegal');
    }

    function editTauxLegal(id) {
        document.getElementById('tauxLegalId').value = id;
        document.getElementById('modalTauxLegalTitle').textContent = 'Modifier le taux légal';

        fetch('{% url "parametres:api_taux_legaux_list" %}')
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    const taux = result.data.find(t => t.id === id);
                    if (taux) {
                        document.getElementById('tauxLegalAnnee').value = taux.annee || '';
                        document.getElementById('tauxLegalSemestre').value = taux.semestre || '1';
                        document.getElementById('tauxLegalTaux').value = taux.taux || '';
                        ouvrirModal('modalTauxLegal');
                    }
                }
            });
    }

    function sauvegarderTauxLegal() {
        const id = document.getElementById('tauxLegalId').value;
        const data = {
            annee: parseInt(document.getElementById('tauxLegalAnnee').value),
            semestre: parseInt(document.getElementById('tauxLegalSemestre').value),
            taux: parseFloat(document.getElementById('tauxLegalTaux').value)
        };

        if (!data.annee || !data.taux) {
            showNotification('error', 'L\'année et le taux sont obligatoires');
            return;
        }

        const url = id ?
            `{% url "parametres:api_taux_legal_update" taux_id=0 %}`.replace('0', id) :
            '{% url "parametres:api_taux_legal_create" %}';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                fermerModal('modalTauxLegal');
                showNotification('success', result.message);
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('error', result.error || 'Erreur');
            }
        });
    }

    // ========== Types d'Actes ==========
    function openTypeActeModal() {
        document.getElementById('typeActeId').value = '';
        document.getElementById('modalTypeActeTitle').textContent = 'Ajouter un type d\'acte';
        document.getElementById('typeActeCode').value = '';
        document.getElementById('typeActeLibelle').value = '';
        document.getElementById('typeActeCategorie').value = 'signification';
        document.getElementById('typeActeMontant').value = '';
        ouvrirModal('modalTypeActe');
    }

    function editTypeActe(id) {
        document.getElementById('typeActeId').value = id;
        document.getElementById('modalTypeActeTitle').textContent = 'Modifier le type d\'acte';

        fetch('{% url "parametres:api_types_actes_list" %}')
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    const acte = result.data.find(a => a.id === id);
                    if (acte) {
                        document.getElementById('typeActeCode').value = acte.code || '';
                        document.getElementById('typeActeLibelle').value = acte.libelle || '';
                        document.getElementById('typeActeCategorie').value = acte.categorie || 'signification';
                        document.getElementById('typeActeMontant').value = acte.montant_defaut || '';
                        ouvrirModal('modalTypeActe');
                    }
                }
            });
    }

    function sauvegarderTypeActe() {
        const id = document.getElementById('typeActeId').value;
        const data = {
            code: document.getElementById('typeActeCode').value,
            libelle: document.getElementById('typeActeLibelle').value,
            categorie: document.getElementById('typeActeCategorie').value,
            montant_defaut: parseFloat(document.getElementById('typeActeMontant').value) || 0
        };

        if (!data.code || !data.libelle) {
            showNotification('error', 'Le code et le libellé sont obligatoires');
            return;
        }

        const url = id ?
            `{% url "parametres:api_type_acte_update" type_id=0 %}`.replace('0', id) :
            '{% url "parametres:api_type_acte_create" %}';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                fermerModal('modalTypeActe');
                showNotification('success', result.message);
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('error', result.error || 'Erreur');
            }
        });
    }

    // ========== Juridictions ==========
    function openJuridictionModal() {
        document.getElementById('juridictionId').value = '';
        document.getElementById('modalJuridictionTitle').textContent = 'Ajouter une juridiction';
        document.getElementById('juridictionType').value = 'TPI';
        document.getElementById('juridictionNom').value = '';
        document.getElementById('juridictionVille').value = '';
        document.getElementById('juridictionAdresse').value = '';
        document.getElementById('juridictionTelephone').value = '';
        ouvrirModal('modalJuridiction');
    }

    function editJuridiction(id) {
        document.getElementById('juridictionId').value = id;
        document.getElementById('modalJuridictionTitle').textContent = 'Modifier la juridiction';

        fetch('{% url "parametres:api_juridictions_list" %}')
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    const jur = result.data.find(j => j.id === id);
                    if (jur) {
                        document.getElementById('juridictionType').value = jur.type || 'TPI';
                        document.getElementById('juridictionNom').value = jur.nom || '';
                        document.getElementById('juridictionVille').value = jur.ville || '';
                        document.getElementById('juridictionAdresse').value = jur.adresse || '';
                        document.getElementById('juridictionTelephone').value = jur.telephone || '';
                        ouvrirModal('modalJuridiction');
                    }
                }
            });
    }

    function sauvegarderJuridiction() {
        const id = document.getElementById('juridictionId').value;
        const data = {
            type: document.getElementById('juridictionType').value,
            nom: document.getElementById('juridictionNom').value,
            ville: document.getElementById('juridictionVille').value,
            adresse: document.getElementById('juridictionAdresse').value,
            telephone: document.getElementById('juridictionTelephone').value
        };

        if (!data.nom || !data.ville) {
            showNotification('error', 'Le nom et la ville sont obligatoires');
            return;
        }

        const url = id ?
            `{% url "parametres:api_juridiction_update" juridiction_id=0 %}`.replace('0', id) :
            '{% url "parametres:api_juridiction_create" %}';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                fermerModal('modalJuridiction');
                showNotification('success', result.message);
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('error', result.error || 'Erreur');
            }
        });
    }

    // ========== Section Modèles de documents ==========
    function filterModeles() {
        const categorie = document.getElementById('filter_categorie_modele').value;
        const rows = document.querySelectorAll('#modeles_table tbody tr');
        rows.forEach(row => {
            if (!categorie || row.dataset.categorie === categorie) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function openModeleModal() {
        alert('Créer un modèle - À implémenter avec éditeur WYSIWYG');
    }

    function previewModele(id) {
        alert('Aperçu modèle ' + id + ' - À implémenter');
    }

    function editModele(id) {
        alert('Modifier modèle ' + id + ' - À implémenter');
    }

    function duplicateModele(id) {
        if (confirm('Dupliquer ce modèle ?')) {
            fetch('{% url "parametres:api_modele_document_duplicate" modele_id=0 %}'.replace('0', id), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification('success', result.message);
                    location.reload();
                } else {
                    showNotification('error', result.error);
                }
            });
        }
    }

    function downloadModele(id) {
        alert('Télécharger modèle ' + id + ' - À implémenter');
    }

    function deleteModele(id) {
        if (confirm('Supprimer ce modèle ?')) {
            alert('Supprimer modèle ' + id + ' - À implémenter');
        }
    }

    function copyVariable(code) {
        navigator.clipboard.writeText(code).then(() => {
            showNotification('success', 'Variable copiée : ' + code);
        });
    }

    // ========== Section Notifications ==========
    function sauvegarderNotifications() {
        // Récupérer la config des notifications
        const notifConfig = {};
        document.querySelectorAll('.notif-checkbox').forEach(cb => {
            const type = cb.dataset.type;
            const channel = cb.dataset.channel;
            if (!notifConfig[type]) {
                notifConfig[type] = { app: false, email: false, sms: false, delai: '' };
            }
            notifConfig[type][channel] = cb.checked;
        });

        // Récupérer les délais
        document.querySelectorAll('input[data-field="delai"]').forEach(input => {
            const type = input.dataset.type;
            if (notifConfig[type]) {
                notifConfig[type].delai = input.value;
            }
        });

        const data = {
            section: 'notifications',
            notif_config: notifConfig,
            smtp_serveur: document.getElementById('smtp_serveur').value,
            smtp_port: document.getElementById('smtp_port').value,
            smtp_utilisateur: document.getElementById('smtp_utilisateur').value,
            smtp_mot_de_passe: document.getElementById('smtp_mot_de_passe').value,
            smtp_expediteur: document.getElementById('smtp_expediteur').value,
            sms_fournisseur: document.getElementById('sms_fournisseur').value,
            sms_api_key: document.getElementById('sms_api_key').value,
            sms_expediteur: document.getElementById('sms_expediteur').value
        };

        envoyerConfig(data);
    }

    function testerSMTP() {
        fetch('{% url "parametres:api_test_smtp" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('success', result.message);
            } else {
                showNotification('error', result.error);
            }
        });
    }

    function testerSMS() {
        fetch('{% url "parametres:api_test_sms" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('success', result.message);
            } else {
                showNotification('error', result.error);
            }
        });
    }

    // ========== Section Sauvegardes ==========
    function creerBackup() {
        showNotification('success', 'Création de la sauvegarde en cours...');
        fetch('{% url "parametres:api_backup_create" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('success', result.message);
                location.reload();
            } else {
                showNotification('error', result.error);
            }
        });
    }

    function restaurerBackup(id) {
        if (confirm('ATTENTION: Cette action va restaurer les données. Continuer ?')) {
            alert('Restauration backup ' + id + ' - À implémenter');
        }
    }

    function downloadBackup(id) {
        alert('Téléchargement backup ' + id + ' - À implémenter');
    }

    function exportData(format, type) {
        window.location.href = '{% url "parametres:api_export_data" format_type="json" %}'.replace('json', format) + '?type=' + type;
    }

    function importData(type, input) {
        if (!input.files[0]) return;

        const formData = new FormData();
        formData.append('file', input.files[0]);

        fetch('{% url "parametres:api_localites_import" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('success', result.message);
                location.reload();
            } else {
                showNotification('error', result.error);
            }
        });

        input.value = '';
    }

    // ========== Section Personnalisation ==========
    function setThemeMode(mode) {
        document.getElementById('theme_mode').value = mode;
        document.querySelectorAll('#tab-personnalisation .toggle-group .toggle-option').forEach(opt => {
            opt.classList.remove('active');
        });
        event.target.closest('.toggle-option').classList.add('active');
    }

    function setDashboardPeriode(periode) {
        document.getElementById('dashboard_periode').value = periode;
        const toggleGroup = event.target.closest('.toggle-group');
        toggleGroup.querySelectorAll('.toggle-option').forEach(opt => {
            opt.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    // ========== Section Référentiels ==========
    function searchLocalites() {
        const search = document.getElementById('search_localite').value.toLowerCase();
        const rows = document.querySelectorAll('#localites_tbody tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function openLocaliteModal() {
        alert('Modal Localité - À implémenter');
    }

    function editLocalite(id) {
        alert('Modifier localité ' + id + ' - À implémenter');
    }

    function importLocalites(input) {
        importData('localites', input);
    }

    function openTauxLegalModal() {
        alert('Modal Taux Légal - À implémenter');
    }

    function editTauxLegal(id) {
        alert('Modifier taux ' + id + ' - À implémenter');
    }

    function openTypeActeModal() {
        alert('Modal Type Acte - À implémenter');
    }

    function editTypeActe(id) {
        alert('Modifier type acte ' + id + ' - À implémenter');
    }

    function openJuridictionModal() {
        alert('Modal Juridiction - À implémenter');
    }

    function editJuridiction(id) {
        alert('Modifier juridiction ' + id + ' - À implémenter');
    }
</script>
{% endblock %}
