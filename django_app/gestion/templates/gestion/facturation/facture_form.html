{% extends 'base.html' %}

{% block title %}{{ title }} - Étude BIAOU{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">/</span>
<a href="{% url 'gestion:facturation' %}" class="breadcrumb-item">Facturation</a>
<span class="breadcrumb-separator">/</span>
<a href="{% url 'gestion:liste_factures_emecef' %}" class="breadcrumb-item">E-MECeF</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-item active">Créer</span>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ title }}</h2>
</div>

<div class="card">
    <div class="card-header">
        <h3>Informations de la facture</h3>
    </div>
    <div class="card-body">
        <form method="post" id="factureForm">
            {% csrf_token %}

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="id_dossier">Dossier (optionnel)</label>
                    {{ form.dossier }}
                </div>
                <div class="form-group col-md-6">
                    <label for="id_client">Client *</label>
                    {{ form.client }}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="id_ifu">IFU Client (13 chiffres)</label>
                    {{ form.ifu }}
                    <small class="form-text text-muted">Obligatoire pour normalisation MECeF</small>
                </div>
                <div class="form-group col-md-4">
                    <label for="id_regime_fiscal">Régime fiscal *</label>
                    {{ form.regime_fiscal }}
                    <small class="form-text text-muted">
                        TVA = 18% sur Groupe B | TPS = 3% sur total CA
                    </small>
                </div>
                <div class="form-group col-md-4">
                    <label class="form-check-label">
                        {{ form.prelevable_aib }}
                        Client entreprise (AIB prélevable)
                    </label>
                    <small class="form-text text-muted">
                        Coché = Entreprise (AIB 3% sur Groupe B) | Décoché = Particulier (pas AIB)
                    </small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="id_date_emission">Date d'émission *</label>
                    {{ form.date_emission }}
                </div>
                <div class="form-group col-md-4">
                    <label for="id_date_echeance">Date d'échéance</label>
                    {{ form.date_echeance }}
                </div>
            </div>

            <div class="form-group">
                <label for="id_observations">Observations</label>
                {{ form.observations }}
            </div>

            <!-- Aide sur les groupes E-MECeF -->
            <div class="alert alert-info">
                <h4>Groupes de taxation E-MECeF</h4>
                <ul>
                    <li><strong>Groupe A (Exonéré)</strong> : Débours, timbres, frais d'enregistrement - TVA 0%</li>
                    <li><strong>Groupe B (Taxable)</strong> : Honoraires, prestations de service - TVA 18%</li>
                </ul>
                <p><strong>AIB</strong> : Si le client est une entreprise, AIB = 3% sur montant HT Groupe B uniquement.</p>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i data-lucide="save"></i>
                    Créer la facture
                </button>
                <a href="{% url 'gestion:liste_factures_emecef' %}" class="btn btn-secondary">
                    <i data-lucide="x"></i>
                    Annuler
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    lucide.createIcons();

    // Validation IFU
    document.getElementById('id_ifu').addEventListener('input', function(e) {
        let val = e.target.value.replace(/\D/g, '');
        if (val.length > 13) val = val.substring(0, 13);
        e.target.value = val;
    });
</script>
{% endblock %}
